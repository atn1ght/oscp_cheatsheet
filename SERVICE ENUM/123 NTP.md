# NTP ENUMERATION (Port 123/UDP)

## SERVICE OVERVIEW
```
NTP (Network Time Protocol) - Time synchronization protocol
- Port: 123/UDP
- Synchronizes clocks across network
- Can reveal system information
- Potential for DDoS amplification attacks
- May leak internal network information
```

## BANNER GRABBING & VERSION DETECTION
```bash
nmap -sU -p123 -sV <IP>                         # UDP scan with version detection
ntpq -c readvar <IP>                            # Query NTP variables
ntpdc -c sysinfo <IP>                           # System information
```

## NMAP ENUMERATION
```bash
# NTP scripts
nmap -sU -p123 --script ntp-info <IP>           # NTP server info
nmap -sU -p123 --script ntp-monlist <IP>        # Get monlist (if enabled)
nmap -sU -p123 --script ntp-monlist,ntp-info <IP>  # Both scripts

# Comprehensive NTP scan
nmap -sU -sV -p123 --script "ntp-*" <IP> -oA ntp_scan
```

## NTP QUERIES
```bash
# Get NTP version
ntpq -c version <IP>

# Get system info
ntpdc -c sysinfo <IP>

# Get peer information
ntpq -c peers <IP>
ntpq -c associations <IP>

# Get system variables
ntpq -c readvar <IP>

# Get runtime variables
ntpq -c rv <IP>
```

## NTP MONLIST QUERY (CVE-2013-5211)
```bash
# Monlist reveals recent NTP clients (up to 600)
# Deprecated in NTPd 4.2.7p26+ due to DDoS abuse

# Query monlist
ntpdc -c monlist <IP>
ntpq -c "rv 0 monlist" <IP>

# Nmap script
nmap -sU -p123 --script ntp-monlist <IP>

# Manual query with ntpdc
ntpdc -n -c monlist <IP>

# Information revealed:
# - IP addresses of recent NTP clients
# - Internal network topology
# - Number of requests from each client
```

## NTPQ COMMANDS
```bash
# Connect to NTP server
ntpq <IP>

# Common commands after connection:
ntpq> peers                                     # Show peer servers
ntpq> associations                              # Show associations
ntpq> sysinfo                                   # System information
ntpq> version                                   # NTP version
ntpq> readvar                                   # Read variables
ntpq> rv                                        # Runtime variables
ntpq> mrulist                                   # Most recently used list
ntpq> quit
```

## EXTRACT INFORMATION
```bash
# Get NTP version and implementation
ntpq -c version <IP>
# Example output: ntpq 4.2.8p10@1.3728-o

# Get system information
ntpdc -c sysinfo <IP>
# Reveals:
# - System peer
# - System stratum
# - Time precision
# - Root delay/dispersion
# - Reference ID

# Get peer list (upstream NTP servers)
ntpq -c peers <IP>
# May reveal:
# - Internal NTP servers
# - Network topology
# - Geographic location (based on NTP pool servers)
```

## NTP AMPLIFICATION ATTACK (CVE-2013-5211)
```bash
# NTP monlist can be abused for DDoS amplification
# 1 byte request = up to 600x response (206 IPs x 440 bytes)

# Test for amplification vulnerability
nmap -sU -p123 --script ntp-monlist <IP>

# If monlist is enabled:
# - Server is vulnerable to DDoS abuse
# - Can be used in reflection attacks
# - Should be disabled (upgrade to ntpd 4.2.7p26+)

# Mitigation check:
ntpq -c "rv 0 version" <IP>
# If version >= 4.2.7p26, monlist is disabled by default
```

## MODE 6/7 QUERIES
```bash
# NTP Mode 6 (Control) and Mode 7 (Private)
# Can reveal sensitive information

# Mode 6 queries (standard)
ntpq -c peers <IP>
ntpq -c sysinfo <IP>

# Mode 7 queries (private, deprecated)
ntpdc -c monlist <IP>
ntpdc -c sysinfo <IP>
ntpdc -c peers <IP>

# Mode 7 is disabled in modern NTP versions
```

## VULNERABILITY SCANNING
```bash
# Check for known NTP vulnerabilities
nmap -sU -p123 --script vuln <IP>

# Known vulnerabilities:
# CVE-2013-5211: monlist DDoS amplification
# CVE-2015-7704: NTPd crypto-NAK crash (DoS)
# CVE-2016-7434: NTPd broadcast mode replay (MitM)
# CVE-2016-9311: NTPd broadcast mode crash (DoS)
# CVE-2018-12327: Stack buffer overflow (RCE)

# searchsploit
searchsploit ntp
searchsploit ntpd
```

## METASPLOIT MODULES
```bash
msfconsole

# NTP monlist scanner
use auxiliary/scanner/ntp/ntp_monlist
set RHOSTS <IP>
run

# NTP readvar info gathering
use auxiliary/scanner/ntp/ntp_readvar
set RHOSTS <IP>
run

# NTP amplification test
use auxiliary/scanner/ntp/ntp_req_nonce
set RHOSTS <IP>
run
```

## TIME MANIPULATION ATTACKS
```bash
# NTP can be exploited to manipulate system time
# Affects:
# - Certificate validation (SSL/TLS)
# - Kerberos authentication (time-sensitive)
# - Logging/forensics
# - Scheduled tasks

# Tools for NTP attacks:
# - Delorean: NTP MitM tool
# - ntpoff: NTP time offset tool

# Requires network position (MitM)
```

## COMMON MISCONFIGURATIONS
```
☐ NTP monlist enabled (CVE-2013-5211)
☐ Outdated NTPd version with known vulnerabilities
☐ NTP server exposed to internet (DDoS amplification)
☐ No rate limiting configured
☐ Mode 7 (private) queries enabled
☐ No authentication required (default)
☐ Verbose responses revealing internal network
☐ NTP server used as open resolver
☐ No firewall restricting NTP access
```

## QUICK WIN CHECKLIST
```
☐ Scan for NTP on port 123/UDP
☐ Query NTP version (ntpq -c version)
☐ Check for monlist vulnerability (CVE-2013-5211)
☐ Enumerate peer servers (reveals network topology)
☐ Extract system information (OS, uptime, stratum)
☐ Check for outdated NTPd version
☐ Test for DDoS amplification potential
☐ Look for internal IP addresses in monlist
☐ Check if Mode 7 queries are enabled
☐ Document findings for reconnaissance
```

## ONE-LINER ENUMERATION
```bash
# Quick NTP enumeration
nmap -sU -p123 --script ntp-info,ntp-monlist <IP>

# Get all NTP info
ntpq -c "rv 0" <IP> && ntpq -c peers <IP> && ntpdc -c sysinfo <IP>
```

## SECURITY IMPLICATIONS
```
RISKS:
- Information disclosure (network topology, IPs)
- DDoS amplification vector (CVE-2013-5211)
- Time manipulation (affects auth, logging, certs)
- Internal network enumeration
- Upstream NTP server identification
- Potential RCE in old versions (CVE-2018-12327)

RECONNAISSANCE VALUE:
- Internal IP addresses from monlist
- Network topology from peer list
- Operating system hints
- Time zone information
- System uptime
- Reference clock information

RECOMMENDATIONS:
- Upgrade to NTPd 4.2.7p26 or later (disables monlist)
- Disable Mode 7 queries (ntpdc)
- Implement rate limiting
- Use 'noquery' in ntp.conf to disable status queries
- Restrict NTP to trusted networks only
- Use NTP authentication (symmetric keys)
- Monitor for amplification abuse
- Consider using chrony instead of ntpd
- Implement BCP38 (ingress filtering)
```

## NTP.CONF HARDENING
```bash
# Secure NTP configuration (/etc/ntp.conf)

# Disable monlist and other queries
restrict default kod nomodify notrap nopeer noquery
restrict -6 default kod nomodify notrap nopeer noquery

# Allow localhost
restrict 127.0.0.1
restrict -6 ::1

# Disable Mode 7 (private queries)
disable monitor

# Use only trusted NTP servers
server 0.pool.ntp.org iburst
server 1.pool.ntp.org iburst
server 2.pool.ntp.org iburst

# Enable authentication (optional but recommended)
keys /etc/ntp/keys
trustedkey 1 2 3
requestkey 1
controlkey 2
```

## CHECK NTP CONFIGURATION
```bash
# View current restrictions
ntpq -c "restrict" <IP>

# Check if monitor is disabled
ntpq -c "sysstats" <IP>
# If "monitor" appears, Mode 7 is enabled (bad)

# Verify monlist is disabled
ntpdc -c monlist <IP>
# Should return error or "***Command `monlist' unknown"
```

## TOOLS
```bash
# ntpq (standard NTP client)
apt-get install ntp
ntpq -c peers <IP>

# ntpdc (deprecated, Mode 7)
ntpdc -c monlist <IP>

# Nmap
nmap -sU -p123 --script ntp-* <IP>

# Metasploit
use auxiliary/scanner/ntp/ntp_monlist

# ntpdate (synchronize time)
ntpdate -q <IP>                                 # Query only, don't set time

# chrony (alternative to ntpd)
chronyc sources <IP>
```

## NTP RECON SUMMARY
```bash
# Information gathering from NTP:

# 1. Version information
ntpq -c version <IP>

# 2. System info
ntpdc -c sysinfo <IP>
ntpq -c "rv 0" <IP>

# 3. Peer servers (network topology)
ntpq -c peers <IP>

# 4. Recent clients (if monlist enabled)
ntpdc -c monlist <IP>

# 5. Amplification test
nmap -sU -p123 --script ntp-monlist <IP>

# Combine all:
echo "=== NTP Version ===" && ntpq -c version <IP> && \
echo "=== System Info ===" && ntpdc -c sysinfo <IP> && \
echo "=== Peers ===" && ntpq -c peers <IP> && \
echo "=== Monlist ===" && ntpdc -c monlist <IP>
```

## INTEGRATION WITH OTHER ATTACKS
```bash
# NTP in reconnaissance phase:

# 1. Discover NTP server
nmap -sU -p123 <subnet>

# 2. Query for monlist (internal IPs)
ntpdc -c monlist <IP> > internal_ips.txt

# 3. Extract unique IPs
grep -oE "([0-9]{1,3}\.){3}[0-9]{1,3}" internal_ips.txt | sort -u > targets.txt

# 4. Scan discovered IPs
nmap -iL targets.txt -sV

# 5. Use time info for Kerberos attacks
# - Kerberos requires time sync (within 5 min)
# - Set your system time based on NTP server
ntpdate -q <IP>
# Use for AS-REP Roasting, Kerberoasting
```

## DEFENSE DETECTION
```bash
# Monitor for NTP abuse:
# - Large number of monlist queries
# - Queries from unexpected sources
# - Amplification attack patterns
# - Unusual query rates

# Log analysis (rsyslog/syslog)
grep "ntpd" /var/log/syslog | grep -i "monlist\|restrict"

# Check for amplification abuse
tcpdump -i any -n udp port 123 -vv
# Look for:
# - Small inbound packets
# - Large outbound responses
# - High packet rate
```
