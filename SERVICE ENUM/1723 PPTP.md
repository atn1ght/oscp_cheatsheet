# PPTP VPN ENUMERATION (Port 1723/TCP)

## SERVICE OVERVIEW
```
PPTP (Point-to-Point Tunneling Protocol) - Legacy VPN protocol
- Port: 1723/TCP
- Developed by Microsoft
- Deprecated due to security vulnerabilities
- Still found in legacy environments
- Weak encryption (MS-CHAPv2, DES, RC4)
```

## BANNER GRABBING & VERSION DETECTION
```bash
nmap -sV -p1723 <IP>                            # Service/Version detection
nc -nv <IP> 1723                                # Manual connection
telnet <IP> 1723                                # Alternative connection
```

## NMAP ENUMERATION
```bash
# PPTP detection
nmap -sV -p1723 <IP>                            # Version detection
nmap -p1723 --script pptp-version <IP>          # PPTP version info

# Comprehensive scan
nmap -sV -p1723 -A <IP> -oA pptp_scan
```

## PPTP HANDSHAKE
```bash
# PPTP uses TCP for control, GRE (protocol 47) for data
# Port 1723 handles PPTP control connection
# GRE tunnels actual VPN traffic

# Check for GRE support
nmap -sO <IP> | grep -i gre                     # Check protocol 47
tcpdump -i eth0 proto 47                        # Capture GRE traffic
```

## PPTP CLIENT CONNECTION
```bash
# Install PPTP client (Linux)
apt-get install pptp-linux

# Create PPTP connection
pon <connection_name>                           # Start VPN
poff <connection_name>                          # Stop VPN

# Manual configuration (/etc/ppp/peers/vpn)
cat > /etc/ppp/peers/myvpn <<EOF
pty "pptp <IP> --nolaunchpppd"
name <username>
password <password>
remotename PPTP
require-mppe-128
file /etc/ppp/options.pptp
ipparam myvpn
EOF

# Start connection
pon myvpn
```

## BRUTE FORCE ATTACKS
```bash
# PPTP brute force (limited tool support)
# MS-CHAPv2 can be brute forced

# THC-PPTP-Bruter (legacy tool)
git clone https://github.com/moxie0/chapcrack
cd chapcrack
# Follow build instructions

# Hydra (basic support)
hydra -l <username> -P passwords.txt <IP> pptp

# Custom brute force
# Capture MS-CHAPv2 handshake, crack offline
```

## MS-CHAPV2 VULNERABILITIES
```bash
# MS-CHAPv2 is cryptographically broken (Moxie Marlinspike, 2012)
# Can crack handshake in ~23 hours on modern hardware

# Capture MS-CHAPv2 handshake
tcpdump -i eth0 -w pptp.pcap port 1723 or proto 47

# Extract challenge/response from pcap
# Use chapcrack or similar tools

# Crack MS-CHAPv2
# 1. Capture handshake
# 2. Extract challenge, peer challenge, response
# 3. Submit to cloud cracking service or crack locally
# 4. Retrieve password in ~1 day

# chapcrack usage
./chapcrack/chapcrack.py -r response.txt
```

## VULNERABILITY SCANNING
```bash
# Known PPTP vulnerabilities
searchsploit pptp

# CVE-2012-4929: MS-CHAPv2 cryptographic weaknesses
# CVE-2017-5720: PPTP buffer overflow (rare)
# Multiple MPPE (Microsoft Point-to-Point Encryption) weaknesses

# Nmap vuln scan
nmap -p1723 --script vuln <IP>
```

## COMMON MISCONFIGURATIONS
```
☐ PPTP enabled despite being deprecated
☐ Weak or default credentials
☐ MS-CHAPv2 authentication (cryptographically broken)
☐ No account lockout policy
☐ PPTP exposed to internet
☐ Using MPPE-40 or MPPE-128 (weak encryption)
☐ No migration plan to modern VPN (IPsec, OpenVPN, L2TP/IPsec)
☐ Legacy Windows systems requiring PPTP
```

## ENUMERATE PPTP SERVER
```bash
# After PPTP connection established:

# Check assigned IP
ip a show ppp0                                  # VPN interface
ifconfig ppp0

# Check routing
ip route
route -n

# DNS servers
cat /etc/resolv.conf

# Enumerate internal network
nmap -sn 10.0.0.0/24                            # Ping scan
nmap -sV 10.0.0.1                               # VPN gateway
```

## PPTP AUTHENTICATION METHODS
```
PAP    - Password Authentication Protocol (cleartext, very weak)
CHAP   - Challenge Handshake Authentication Protocol (weak)
MS-CHAPv1 - Microsoft CHAP version 1 (weak, deprecated)
MS-CHAPv2 - Microsoft CHAP version 2 (broken, but still common)
EAP    - Extensible Authentication Protocol (better, but PPTP still weak)

Recommendation: Don't use PPTP regardless of auth method
```

## METASPLOIT MODULES
```bash
msfconsole

# Limited PPTP modules in Metasploit
# Focus on MS-CHAPv2 exploitation

# Generic port scan
use auxiliary/scanner/portscan/tcp
set RHOSTS <IP>
set PORTS 1723
run
```

## QUICK WIN CHECKLIST
```
☐ Scan for PPTP on port 1723/TCP
☐ Test default credentials (administrator:password, admin:admin)
☐ Brute force authentication
☐ Capture MS-CHAPv2 handshake
☐ Crack MS-CHAPv2 offline (chapcrack)
☐ Connect with valid credentials
☐ Enumerate internal network
☐ Search for known PPTP exploits
☐ Recommend migration to modern VPN protocol
```

## ONE-LINER ENUMERATION
```bash
# Quick PPTP detection
nmap -sV -p1723 --script pptp-version <IP>

# Test connection
echo "" | nc -nv <IP> 1723
```

## SECURITY IMPLICATIONS
```
RISKS:
- Cryptographically broken (MS-CHAPv2)
- Weak encryption (MPPE-40, MPPE-128)
- Password cracking in <24 hours from captured handshake
- No forward secrecy
- Vulnerable to man-in-the-middle attacks
- Legacy protocol with known vulnerabilities
- Internal network access after compromise

ATTACK VECTORS:
1. Brute force credentials
2. Capture MS-CHAPv2 handshake
3. Offline crack handshake (chapcrack)
4. Connect with cracked password
5. Enumerate internal network
6. Lateral movement

RECOMMENDATIONS:
- Migrate to modern VPN (IPsec, OpenVPN, WireGuard)
- Disable PPTP if not absolutely required
- Use multi-factor authentication (even on legacy PPTP)
- Monitor PPTP connections (unusual IPs, times)
- Implement account lockout policy
- Restrict PPTP to trusted networks only
- Plan deprecation timeline for PPTP
- Educate users on PPTP risks
```

## ALTERNATIVES TO PPTP
```
Modern VPN protocols (in order of preference):
1. WireGuard - Modern, fast, secure (recommended)
2. IPsec/IKEv2 - Industry standard, secure
3. OpenVPN - Open-source, widely supported
4. L2TP/IPsec - Better than PPTP, but slower
5. SSTP - Microsoft's alternative to PPTP
6. IKEv2 - Mobile-friendly, secure

DO NOT USE:
- PPTP (broken)
- L2TP without IPsec (no encryption)
```

## TOOLS
```bash
# PPTP client
apt-get install pptp-linux
pon myvpn

# Nmap
nmap -sV -p1723 --script pptp-version <IP>

# chapcrack (MS-CHAPv2 cracking)
git clone https://github.com/moxie0/chapcrack

# Hydra (limited support)
hydra -l user -P passwords.txt <IP> pptp

# tcpdump (capture handshake)
tcpdump -i eth0 -w pptp.pcap port 1723 or proto 47

# Wireshark
wireshark -f "port 1723 or proto 47"
```

## PPTP CONFIGURATION FILES
```bash
# Linux PPTP client config locations:
/etc/ppp/peers/                                 # Connection profiles
/etc/ppp/chap-secrets                           # Credentials (MS-CHAP)
/etc/ppp/pap-secrets                            # Credentials (PAP)
/etc/ppp/options.pptp                           # Global options

# Windows PPTP config:
C:\ProgramData\Microsoft\Network\Connections\Pbk\rasphone.pbk

# Look for stored credentials
cat /etc/ppp/chap-secrets
# Format: <username> <server> <password> <IP>
```

## DEFENSE DETECTION
```bash
# Monitor for PPTP connections:
# - Unusual source IPs
# - Brute force attempts (multiple failed auth)
# - Connections from geographic anomalies
# - Connections outside business hours

# Log analysis (Linux PPTP server)
tail -f /var/log/messages | grep pptp
grep "PPTP" /var/log/syslog

# Windows Event IDs:
# 20225 - PPTP connection established
# 20227 - PPTP connection terminated
# 6272 - Network Policy Server granted access
# 6273 - Network Policy Server denied access

# Firewall logs
# Monitor connections to 1723/TCP and GRE (protocol 47)
```

## POST-CONNECTION ENUMERATION
```bash
# After successful PPTP connection:

# Check VPN interface
ip a show ppp0
ifconfig ppp0

# Internal network scan
nmap -sn 10.0.0.0/24                            # Discover hosts
nmap -sV -p- 10.0.0.1                           # Scan gateway

# Check for SMB shares
crackmapexec smb 10.0.0.0/24

# Test credentials on internal systems
crackmapexec smb 10.0.0.0/24 -u <user> -p <cracked_pass> --shares

# Enumerate Active Directory (if domain-joined)
ldapsearch -x -h 10.0.0.1 -b "DC=domain,DC=local"
```

## INTEGRATION WITH OTHER ATTACKS
```bash
# Attack chain:

# 1. Discover PPTP
nmap -sV -p1723 <IP>

# 2. Brute force or capture handshake
hydra -l admin -P passwords.txt <IP> pptp
# OR
tcpdump -i eth0 -w pptp.pcap port 1723

# 3. Crack MS-CHAPv2 (if captured)
./chapcrack/chapcrack.py -r handshake.txt

# 4. Connect with credentials
pon myvpn

# 5. Enumerate internal network
nmap -sn 10.0.0.0/24

# 6. Lateral movement
crackmapexec smb 10.0.0.0/24 -u admin -p 'cracked_pass'

# 7. Compromise internal systems
```
