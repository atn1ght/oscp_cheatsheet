# mDNS ENUMERATION (Port 5353/UDP)

## SERVICE OVERVIEW
```
mDNS (Multicast DNS) - Zero-configuration service discovery
- Port: 5353/UDP
- Used by Bonjour (Apple), Avahi (Linux)
- Discovers services on local network without DNS server
- Multicast address: 224.0.0.251 (IPv4), FF02::FB (IPv6)
- Reveals hostnames, services, network topology
```

## BANNER GRABBING & VERSION DETECTION
```bash
nmap -sU -p5353 -sV <IP>                        # UDP scan with version detection
avahi-browse -a                                 # Browse all services (local)
dns-sd -B _services._dns-sd._udp local.         # Browse services (macOS)
```

## NMAP ENUMERATION
```bash
# mDNS detection
nmap -sU -p5353 --script dns-service-discovery <IP>
nmap -sU -p5353 --script broadcast-dns-service-discovery

# Multicast query (discovers all mDNS responders on network)
nmap --script broadcast-dns-service-discovery

# Comprehensive scan
nmap -sU -sV -p5353 <IP> -oA mdns_scan
```

## MDNS QUERIES
```bash
# Query specific service types
avahi-browse -t _http._tcp                      # Web servers
avahi-browse -t _ssh._tcp                       # SSH servers
avahi-browse -t _sftp-ssh._tcp                  # SFTP servers
avahi-browse -t _smb._tcp                       # SMB/CIFS shares
avahi-browse -t _afpovertcp._tcp                # AFP (Apple File Protocol)
avahi-browse -t _ftp._tcp                       # FTP servers
avahi-browse -t _ipp._tcp                       # Printers (IPP)
avahi-browse -t _daap._tcp                      # iTunes music sharing
avahi-browse -t _airplay._tcp                   # AirPlay devices

# Browse all services
avahi-browse -a                                 # All services
avahi-browse -a -r                              # All services (resolve)
avahi-browse -a -p                              # Parseable output

# Resolve hostname
avahi-resolve -n <hostname>.local
```

## COMMON MDNS SERVICE TYPES
```
Service Type              Description
_http._tcp                Web servers
_https._tcp               Secure web servers
_ssh._tcp                 SSH servers
_sftp-ssh._tcp            SFTP servers
_ftp._tcp                 FTP servers
_smb._tcp                 SMB/CIFS file shares
_afpovertcp._tcp          Apple File Protocol
_nfs._tcp                 Network File System
_ipp._tcp                 Internet Printing Protocol
_printer._tcp             Printers
_scanner._tcp             Scanners
_workstation._tcp         Workstations
_device-info._tcp         Device information
_daap._tcp                iTunes music sharing
_airplay._tcp             AirPlay (Apple TV, etc.)
_raop._tcp                Remote Audio Output Protocol
_homekit._tcp             Apple HomeKit devices
_googlecast._tcp          Chromecast devices
```

## ENUMERATE HOSTS AND SERVICES
```bash
# Discover all mDNS hosts on network
avahi-browse -a -r -t | grep hostname
avahi-browse -a -r -t | grep "=" | awk '{print $4}'

# Parse service information
avahi-browse -a -p | awk -F';' '{print $4,$7,$8,$9}'

# Example output parsing:
# hostname, service type, port, TXT records

# Get detailed service info
avahi-browse -a -r
# Shows:
# - Hostname
# - IP address
# - Port
# - Service type
# - TXT records (may contain version, path, etc.)
```

## MANUAL MDNS QUERIES
```bash
# Using dig for mDNS queries
dig @224.0.0.251 -p 5353 _services._dns-sd._udp.local PTR

# Query specific service
dig @224.0.0.251 -p 5353 _http._tcp.local PTR

# Resolve .local domain
dig @224.0.0.251 -p 5353 hostname.local A

# Using nslookup
nslookup -type=PTR _services._dns-sd._udp.local 224.0.0.251
```

## MDNS SPOOFING / POISONING
```bash
# mDNS can be spoofed for MitM attacks
# Respond to mDNS queries with malicious IP

# Responder (includes mDNS poisoning)
responder -I eth0 -w -r -f

# Manual mDNS response (requires custom tool)
# Tools: mDNS spoofer, evil-mdns

# Attack scenario:
# 1. Listen for mDNS queries
# 2. Respond with attacker's IP
# 3. Victim connects to attacker instead of legitimate service
# 4. Capture credentials or perform MitM
```

## INFORMATION DISCLOSURE
```bash
# mDNS reveals sensitive information:
# - Hostnames (often descriptive: "Johns-MacBook", "HR-Printer")
# - Operating system (from hostname patterns)
# - Services running (web, SSH, SMB, printers)
# - Device types (laptops, printers, NAS, IoT)
# - Network topology
# - User information (from hostnames)

# Extract all hostnames
avahi-browse -a -r -t | grep "hostname" | awk '{print $3}' | sort -u

# Extract all IP addresses
avahi-browse -a -r -t | grep "address" | awk '{print $3}' | sort -u

# Map services to hosts
avahi-browse -a -p | awk -F';' '{print $8,$7,$4}' | sort
```

## APPLE BONJOUR
```bash
# Bonjour is Apple's mDNS implementation
# Used by macOS, iOS, Apple TV, AirPlay, etc.

# Query Bonjour services (macOS)
dns-sd -B _services._dns-sd._udp local.
dns-sd -B _http._tcp local.
dns-sd -B _airplay._tcp local.

# Resolve service
dns-sd -L <service_name> <service_type> <domain>

# Example:
dns-sd -L "My Printer" _ipp._tcp local.
```

## LINUX AVAHI
```bash
# Avahi is Linux implementation of mDNS
# Check if Avahi is running
systemctl status avahi-daemon

# Avahi configuration
cat /etc/avahi/avahi-daemon.conf

# Disable Avahi (defense)
systemctl stop avahi-daemon
systemctl disable avahi-daemon
```

## COMMON MISCONFIGURATIONS
```
☐ mDNS enabled on corporate networks (information disclosure)
☐ Descriptive hostnames revealing user/purpose
☐ Services advertised unnecessarily
☐ No mDNS traffic filtering at network edge
☐ mDNS responses from sensitive devices (servers, printers)
☐ Avahi/Bonjour enabled by default (not needed)
☐ mDNS traffic crossing VLAN boundaries
☐ No monitoring of mDNS traffic
☐ Printer/IoT devices broadcasting services
```

## QUICK WIN CHECKLIST
```
☐ Scan for mDNS on port 5353/UDP
☐ Enumerate all mDNS services (avahi-browse -a)
☐ Extract hostnames (reveals users, devices)
☐ Map services to hosts (web, SSH, SMB, etc.)
☐ Identify device types (printers, NAS, IoT)
☐ Check for sensitive service exposure (SSH, SMB)
☐ Look for descriptive hostnames (social engineering)
☐ Document network topology from mDNS data
☐ Check for mDNS spoofing opportunities
☐ Use discovered services for targeted attacks
```

## ONE-LINER ENUMERATION
```bash
# Quick mDNS service discovery
avahi-browse -a -r -t | grep -E "hostname|address|txt"

# Parse all services and IPs
avahi-browse -a -p | awk -F';' '{print $8,$7,$4}' | sort -u
```

## SECURITY IMPLICATIONS
```
RISKS:
- Information disclosure (hostnames, services, topology)
- Hostname enumeration (reveals users, purposes)
- Service discovery (attack surface identification)
- mDNS spoofing/poisoning (MitM attacks)
- Social engineering (user info from hostnames)
- Device fingerprinting (OS, device type)
- Network mapping (topology discovery)

RECONNAISSANCE VALUE:
- Discover all hosts on network (even hidden ones)
- Identify services without port scanning
- Map network topology
- Find printers, NAS, IoT devices
- Discover web services, file shares
- User enumeration from hostnames
- Operating system identification

RECOMMENDATIONS:
- Disable mDNS if not needed
- Use non-descriptive hostnames
- Restrict mDNS to trusted VLANs
- Filter mDNS traffic at network boundaries
- Monitor mDNS traffic for anomalies
- Disable Avahi/Bonjour on servers
- Implement network segmentation (separate IoT VLAN)
- Educate users on hostname selection
- Regular audit of advertised services
```

## MDNS VS DNS
```
Traditional DNS:
- Port 53/UDP
- Requires DNS server
- Centralized
- Queries unicast
- Global namespace

mDNS:
- Port 5353/UDP
- No server required (serverless)
- Distributed (peer-to-peer)
- Queries multicast
- .local TLD
- Zero-configuration

Use cases:
- mDNS: Home networks, small offices, plug-and-play
- DNS: Corporate networks, internet
```

## TOOLS
```bash
# avahi-browse (Linux)
apt-get install avahi-utils
avahi-browse -a -r

# dns-sd (macOS, built-in)
dns-sd -B _services._dns-sd._udp local.

# Nmap
nmap --script broadcast-dns-service-discovery
nmap -sU -p5353 --script dns-service-discovery <IP>

# Responder (poisoning)
responder -I eth0 -w -r

# dig
dig @224.0.0.251 -p 5353 _services._dns-sd._udp.local PTR
```

## DEFENSE DETECTION
```bash
# Monitor for mDNS abuse:
# - Unusual mDNS queries
# - mDNS responses from unexpected sources
# - High volume of mDNS traffic (scanning)
# - mDNS spoofing attempts

# Capture mDNS traffic
tcpdump -i any udp port 5353 -vv

# Wireshark filter
udp.port == 5353

# Check for mDNS responders
avahi-browse -a | wc -l

# Disable mDNS (if not needed)
# Linux
systemctl stop avahi-daemon
systemctl disable avahi-daemon

# macOS (disable Bonjour)
sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.mDNSResponder.plist
```

## INTEGRATION WITH OTHER ATTACKS
```bash
# Attack chain:

# 1. Discover mDNS services
avahi-browse -a -r -t > mdns_services.txt

# 2. Extract SSH servers
grep "_ssh._tcp" mdns_services.txt | awk '{print $8}'

# 3. Extract SMB shares
grep "_smb._tcp" mdns_services.txt | awk '{print $8}'

# 4. Resolve hostnames to IPs
avahi-resolve -n hostname.local

# 5. Attack discovered services
# SSH brute force
hydra -L users.txt -P passwords.txt ssh://discovered_host

# SMB enumeration
smbclient -L //discovered_host -N

# 6. mDNS poisoning for MitM
responder -I eth0 -w -r
# Wait for victim to query for service
# Respond with attacker IP
# Capture credentials when victim connects
```

## PRINTER ENUMERATION VIA MDNS
```bash
# Printers often advertise via mDNS
avahi-browse -t _ipp._tcp
avahi-browse -t _printer._tcp
avahi-browse -t _scanner._tcp

# Get printer details
avahi-browse -t _ipp._tcp -r

# Information revealed:
# - Printer model and manufacturer
# - IP address
# - Printer name (often location: "3rd-Floor-Printer")
# - Supported protocols (IPP, LPD, etc.)

# Access printer web interface
# http://printer-ip/ (often has web UI)

# Potential attacks:
# - Print job interception
# - Printer firmware exploitation
# - Stored document access
# - Network pivot via printer
```
